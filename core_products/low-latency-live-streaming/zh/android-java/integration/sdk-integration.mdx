# 集成 

--- 

## 1 准备环境  
在开始集成 ZEGO Express SDK 前，请确保开发环境满足以下要求：  
- Android Studio 2.1 或以上版本。
- Android SDK 25、Android SDK Build-Tools 25.0.2、Android SDK Platform-Tools 25.x.x 或以上版本。
- Android 4.1 或以上版本，且支持音视频的 Android 设备。
- Android 设备已经连接到 Internet。  

## 2 集成 SDK  

### 2.1 （可选）新建项目

<details class="zg-primary">   
    <summary>此步骤以如何创建新项目为例，如果是集成到已有项目，可忽略此步。</summary>  

1. 打开 Android Studio，选择 “File > New > New Project” 菜单。
<img src="/Pics/Android/ZegoLiveRoom/ZegoLiveRoom-IntegrationGuide/3.1-new_project-1.png">

2. 填写项目名及项目存储路径。
<img src="/Pics/Android/ZegoLiveRoom/ZegoLiveRoom-IntegrationGuide/3.1-new_project-2.png">

3. 其它按照默认设置，单击 “Next”，最后单击 “Finish” 完成新工程创建。  
</details>   

### 2.2 导入 SDK  
目前支持的平台架构包括：armeabi-v7a、arm64-v8a、x86、x86_64。

开发者可通过以下任意一种方式实现集成 SDK。  

#### 方式一：使用 JitPack 自动集成 SDK 
 
1. 进入项目根目录，打开 “build.gradle” 文件，在 “allprojects” 中加入如下代码。

    ```gradle
    ...
    allprojects {
        repositories {
            maven { url 'https://www.jitpack.io' }
            google()
            jcenter()
        }
    }
    ```

2. 进入 “app” 目录，打开 “build.gradle” 文件，在 “dependencies” 中添加 `implementation 'com.github.zegolibrary:express-video:x.y.z'`。“x.y.z” 为 SDK 的版本号，请参考 [下载 SDK 包](#2969) 中的发布历史获取。

    ```gradle
    ...
    dependencies {
        ...
        // x.y.z 请填写具体版本号，如：2.7.0
        // 可通过 SDK 发布历史取得最新版本号
        implementation 'com.github.zegolibrary:express-video:x.y.z'
    }
    ```    

    <div class="mk-warning">   

    - 从 **2.7.0** 版本开始，Zego 将使用 JitPack 代替 JCenter 作为 SDK 托管服务器，因此开发者需手动将 `build.gradle` 里的配置变更为 `'com.github.zegolibrary:express-video:x.y.z'`
    - JCenter **2021-03-31** 之后停止上传新版本 SDK，该服务将于 **2021-05-01 停用**，详情请参考 [Service End for JCenter ](https://jfrog.com/blog/into-the-sunset-bintray-jcenter-gocenter-and-chartcenter/)。
    - 从 **1.11.0** 版本开始，依赖的命令从 `implementation 'im.zego:express-engine-video:x.y.z'` 改为 `implementation 'im.zego:express-video:x.y.z'`。使用 **1.11.0 以下** 的版本不受影响，但后续不再从 “express-engine-video” 里更新，建议所有使用旧版本的开发者切换到 **1.11.0 或以上** 的版本进行集成。
    </div>  



#### 方式二：复制 SDK 文件手动集成  

1. 请参考 [下载 SDK 包](#2969) ，下载最新版本的 SDK。
2. 解压 SDK 至项目目录，如 “app/libs”。  
<img src="/Pics/Android/ExpressSDK/Integration/add_jar.png" width="80%" height="10%">
3. 添加 SDK 引用，进入到 “app” 目录，打开 “build.gradle” 文件。  
    * 在 “defaultConfig” 节点添加 “ndk” 节点，指定支持的平台类型。  
<img src="/Pics/Android/ZegoLiveRoom/ZegoLiveRoom-IntegrationGuide/3.2-insert_ndk_node-1.png">

    ```gradle
    ndk {
        abiFilters 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64' 
    }
    ```

    * 在 “android” 节点添加 “sourceSets” 节点，指定 “libs” 所在目录。

    <div class="mk-hint">

    示例代码中 “libs” 目录仅为举例，开发者可根据实际路径填写。  
    </div>

    <img src="/Pics/Android/ZegoLiveRoom/ZegoLiveRoom-IntegrationGuide/3_2_insert_sourceSets_node_2.png">

    ```gradle
    sourceSets {
        main {
            jniLibs.srcDirs = ['libs']
        }
    }
    ```

    * 在 “dependencies” 节点引入 “libs” 下所有的 jar。  

    <img src="/Pics/Android/ZegoLiveRoom/ZegoLiveRoom-IntegrationGuide/3_2_insert_sourceSets_node_3.png"> 
 
    ```gradle
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    ```  


## 3 设置权限  
根据实际应用需要，设置应用所需权限。

进入 “app/src/main” 目录，打开 “AndroidManifest.xml” 文件，添加权限。  
``` 
<!-- SDK 必须使用的权限 -->
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />

<!-- App 需要使用的部分权限 -->
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />

<uses-feature
    android:glEsVersion="0x00020000"
    android:required="true" />

<uses-feature android:name="android.hardware.camera" />
<uses-feature android:name="android.hardware.camera.autofocus" />
```
<div class="mk-warning">

因为 Android 6.0 在一些比较重要的权限上要求必须申请动态权限，不能只通过 “AndroidMainfest.xml” 文件申请静态权限。因此还需要参考执行如下代码，其中 “requestPermissions” 是 “Activity” 的方法。 
</div>  

```java  
String[] permissionNeeded = {
    "android.permission.CAMERA",
    "android.permission.RECORD_AUDIO"};

if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    if (ContextCompat.checkSelfPermission(this, "android.permission.CAMERA") != PackageManager.PERMISSION_GRANTED ||
        ContextCompat.checkSelfPermission(this, "android.permission.RECORD_AUDIO") != PackageManager.PERMISSION_GRANTED) {
        requestPermissions(permissionNeeded, 101);
    }
}
```
## 4 防止混淆代码  

在 “proguard-rules.pro” 文件中，为 SDK 添加 `-keep` 类的配置，防止混淆 SDK 公共类名称。  

```
-keep class **.zego.**{*;}
```

## 相关文档

[如何减少集成 Native SDK 的 App 体积？](https://doc-zh.zego.im/faq/express_reduce_app_size)
