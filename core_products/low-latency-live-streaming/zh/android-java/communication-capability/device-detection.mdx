# 设备检测

---

## 1 功能简介

为了保证实时通信体验，通话或直播前可以进行设备检测，提前识别并排查问题。设备检测主要是检测本地麦克风、摄像头以及扬声器是否能正常工作。   


## 2 前提条件

在实现设备检测功能之前，请确保：

@@@Express-Video_Prerequisites@@@


## 3 设备检测


### 3.1 麦克风检测

#### 3.1.1 检测逻辑

麦克风设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Microphone_detection.png" width=555 >


#### 3.1.2 对应接口

**1. 启动麦克风**

调用 [startPreview\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-express-engine&jumpType=route#start-preview) 接口在不推流的情况下启动音频采集。

```java
engine.startPreview();
```

**2. 检测麦克风权限**

ZEGO SDK 自动检查麦克风权限。
<div class="mk-warning"><p>
因为 Android 6.0 在一些比较重要的权限上要求必须申请动态权限，不能只通过 “AndroidMainfest.xml” 文件申请静态权限。因此还需要参考执行如下代码，其中 “requestPermissions” 是 “Activity” 的方法。
</p></div>

```java
String[] permissionNeeded = {
    "android.permission.RECORD_AUDIO"};

if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    if (ContextCompat.checkSelfPermission(this, "android.permission.RECORD_AUDIO") != PackageManager.PERMISSION_GRANTED) {
        requestPermissions(permissionNeeded, 101);
    }
}
```

**3. 检测麦克风是否可用**


通过如下回调检测设备是否异常，若未检测到任何异常反馈（可同步启动 “4. 检测麦克风收音数据”），且麦克风收音数据检测正常，则麦克风设备可用。

监听 [onLocalDeviceExceptionOccurred\|_blank](@onLocalDeviceExceptionOccurred) 回调检测设备是否异常。


```java
/**
 * 本地设备异常通知
 * 
 * 支持版本：1.0.0 及以上。
 * 详情描述：本地设备异常。
 * 通知时机：当本地音频或视频设备功能出现异常时会触发此回调。
 * 
 * @param exceptionType 设备异常类型。
 * @param deviceType 发生异常的设备类型。
 * @param deviceID 设备 ID。目前仅支持桌面端设备，用于标识具体的设备；对于移动端设备，此参数将返回空字符串。
 */
public void onLocalDeviceExceptionOccurred(ZegoDeviceExceptionType exceptionType, ZegoDeviceType deviceType, String deviceID){

}
```

**4. 检测麦克风收音数据**

调用 [startSoundLevelMonitor\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-express-engine&jumpType=route#start-sound-level-monitor) 接口获取麦克风采集到声音的能量值，如果数据无异常则麦克风正常，可用于通话或直播。

```java
engine.startSoundLevelMonitor();
```


### 3.2 摄像头检测   

#### 3.2.1 检测逻辑

摄像头设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Camera_detection.png" width=555 >


#### 3.2.2 对应接口

**1. 启动摄像头** 

调用 [startPreview\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-express-engine&jumpType=route#start-preview) 接口绑定摄像头预览画面的视图，在不推流的情况下启动视频采集并预览。

```java
engine.startPreview();
```

**2. 检测摄像头权限**

ZEGO SDK 会自动检查摄像头权限。
<div class="mk-warning"><p>
因为 Android 6.0 在一些比较重要的权限上要求必须申请动态权限，不能只通过 “AndroidMainfest.xml” 文件申请静态权限。因此还需要参考执行如下代码，其中 “requestPermissions” 是 “Activity” 的方法。
</p></div>

```java
String[] permissionNeeded = {
    "android.permission.CAMERA"};

if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    if (ContextCompat.checkSelfPermission(this, "android.permission.CAMERA") != PackageManager.PERMISSION_GRANTED) {
        requestPermissions(permissionNeeded, 101);
    }
}
```

**3. 检测摄像头是否可用**


通过如下回调检测设备是否异常，若未检测到任何异常反馈（可同步启动“4. 检测画面是否正常”），且画面显示正常，则设备可用。

监听 [onLocalDeviceExceptionOccurred\|_blank](@onLocalDeviceExceptionOccurred) 回调检测设备是否异常。


```java
/**
 * 本地设备异常通知
 * 
 * 支持版本：1.0.0 及以上。
 * 详情描述：本地设备异常。
 * 通知时机：当本地音频或视频设备功能出现异常时会触发此回调。
 * 
 * @param exceptionType 设备异常类型。
 * @param deviceType 发生异常的设备类型。
 * @param deviceID 设备 ID。目前仅支持桌面端设备，用于标识具体的设备；对于移动端设备，此参数将返回空字符串。
 */
public void onLocalDeviceExceptionOccurred(ZegoDeviceExceptionType exceptionType, ZegoDeviceType deviceType, String deviceID){

}
```


**4. 检测画面是否正常**

若此时画面显示正常，则摄像头正常，可用于通话或直播。


### 3.3 扬声器检测   

#### 3.3.1 检测逻辑

播放设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Playback_device_detection.png" width=555 >


#### 3.3.2 对应接口

**1. 使用媒体播放器播放音频文件** 

调用 [ZegoMediaPlayer\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-media-player&jumpType=route) 接口播放您用于测试的音频文件。

```java
// 1. 创建播放器对象
ZegoMediaPlayer mediaPlayer = engine.createMediaPlayer();
// 2. 加载资源
String resourcePath = "xxx";
mediaPlayer.loadResource(resourcePath, null);
// 3. 播放资源
mediaPlayer.start();
```

**2. 检测是否听到声音**

如果可以听到相应的音频，则播放设备正常，可用于通话或直播。调用 [onMediaPlayerStateUpdate\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-callback-i-zego-media-player-event-handler&jumpType=route#on-media-player-state-update) 接口查看播放器状态回调：

```java
/**
* 播放器播放状态回调
* @param mediaPlayer 回调的播放器实例
* @param state 播放器状态
* @param errorCode 错误码，详情请参考常见错误码文档
*/
public void onMediaPlayerStateUpdate(ZegoMediaPlayer mediaPlayer, ZegoMediaPlayerState state, int errorCode){}
```


## 4 API 参考列表

| 方法 | 描述 |
|----|----|
|[startPreview\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-express-engine&jumpType=route#start-preview)|启动本地预览|
|[onLocalDeviceExceptionOccurred\|_blank](@onLocalDeviceExceptionOccurred)|本地设备异常通知|
|[startSoundLevelMonitor\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-zego-express-engine&jumpType=route#start-sound-level-monitor)|启动音量变化监控|
|[onMediaPlayerStateUpdate\|_blank](/article/api?doc=Express_Video_SDK_API~Java_android~class~im-zego-zegoexpress-callback-i-zego-media-player-event-handler&jumpType=route#on-media-player-state-update)|播放器播放状态回调|




## 5 常见错误码

当开发者收到 [onLocalDeviceExceptionOccurred\|_blank](@onLocalDeviceExceptionOccurred) 设备回调不为 0 时，相关的错误码请参考 [常见错误码\|_blank](4378#7)。
