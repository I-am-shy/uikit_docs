---
articleID: 14947
---
# 设备检测

---

## 1 功能简介

为了保证实时通信体验，通话前可以进行网络与设备的检测，提前识别并排查问题。   
- 网络测速：检测网络环境，可用于判断或预测网络环境是否适合推/拉指定码率的流。
- 设备检测：检测本地麦克风、摄像头以及扬声器是否能正常工作。

本文将介绍如何使用 ZEGO SDK 接口，实现上述两个角度的检测。


## 2 前提条件

在实现通话前网络/设备检测功能之前，请确保：

@@@Express-Video_Prerequisites@@@


## 3 网络测速

请参考 [网络与性能](#11524) 进行操作。


## 4 设备检测


### 4.1 麦克风检测

#### 4.1.1 检测逻辑

麦克风设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Microphone_detection.png" width=555 >


#### 4.1.2 对应接口

**1. 启动麦克风**

调用 [startPreview](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-express-engine&jumpType=route#start-preview) 接口在不推流的情况下启动音频采集。

```c++
engine->startPreview(&canvas);
```

**2. 检测麦克风权限**

ZEGO SDK 会自动检查麦克风权限。如果用户未授权，则会请求用户同意；如果用户拒绝，则需要用户手动去系统设置里开启权限。



**3. 检测麦克风是否可用**


通过如下回调检测设备是否异常，若未检测到任何异常反馈（可同步启动“4. 检测麦克风收音数据”），且麦克风收音数据检测正常，则麦克风设备可用。

- 2.15.0 之前版本：监听 [onDeviceError](@onDeviceError) 回调检测设备是否异常。


```c++
/**
* 设备异常通知
* @param errorCode 设备异常的错误码，请参考常见错误码文档
* @param deviceName 设备名称
*/
virtual void onDeviceError(int /*errorCode*/, const std::string& /*deviceName*/) {}
```

- 2.15.0 及以上版本：监听 [onLocalDeviceExceptionOccurred](@onLocalDeviceExceptionOccurred) 回调检测设备是否异常。


```cpp
/**
 * The callback triggered when a local device exception occurred.
 *
 * Available since: 2.15.0
 * Description: The callback triggered when a local device exception occurs.
 * Trigger: This callback is triggered when the function of the local audio or video device is abnormal.
 *
 * @param exceptionType The type of the device exception.
 * @param deviceType The type of device where the exception occurred.
 * @param deviceID Device ID. Currently, only desktop devices are supported to distinguish different devices; for mobile devices, this parameter will return an empty string.
 */
virtual void onLocalDeviceExceptionOccurred(ZegoDeviceExceptionType /*exceptionType*/, ZegoDeviceType /*deviceType*/, const std::string& /*deviceID*/) {

}
```



**4. 检测麦克风收音数据**

调用 [startSoundLevelMonitor](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-express-engine&jumpType=route#start-sound-level-monitor) 接口获取麦克风采集到声音的能量值，如果数据无异常则麦克风正常，可用于通话。

```c++
engine->startSoundLevelMonitor();
```


### 4.2 摄像头检测   

#### 4.2.1 检测逻辑

摄像头设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Camera_detection.png" width=555 >


#### 4.2.2 对应接口

**1. 启动摄像头** 

调用 [startPreview](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-express-engine&jumpType=route#start-preview) 接口绑定摄像头预览画面的视图，在不推流的情况下启动视频采集并预览。

```c++
ZegoCanvas canvas(ZegoView(ui->frame_Preview->winId()));
engine->startPreview(&canvas);
```

**2. 检测摄像头权限**

ZEGO SDK 会自动检查摄像头权限。如果用户未授权，则会请求用户同意；如果用户拒绝，则需要用户手动去系统设置里开启权限。



**3. 检测摄像头是否可用**


通过如下回调检测设备是否异常，若未检测到任何异常反馈（可同步启动“4. 检测画面是否正常”），且画面显示正常，则设备可用。

- 2.15.0 之前版本：监听 [onDeviceError](@onDeviceError) 回调检测设备是否异常。


```c++
/**
* 设备异常通知
* @param errorCode 设备异常的错误码，请参考常见错误码文档
* @param deviceName 设备名称
*/
virtual void onDeviceError(int /*errorCode*/, const std::string& /*deviceName*/) {}
```

- 2.15.0 及以上版本：监听 [onLocalDeviceExceptionOccurred](@onLocalDeviceExceptionOccurred) 回调检测设备是否异常。


```cpp
/**
 * The callback triggered when a local device exception occurred.
 *
 * Available since: 2.15.0
 * Description: The callback triggered when a local device exception occurs.
 * Trigger: This callback is triggered when the function of the local audio or video device is abnormal.
 *
 * @param exceptionType The type of the device exception.
 * @param deviceType The type of device where the exception occurred.
 * @param deviceID Device ID. Currently, only desktop devices are supported to distinguish different devices; for mobile devices, this parameter will return an empty string.
 */
virtual void onLocalDeviceExceptionOccurred(ZegoDeviceExceptionType /*exceptionType*/, ZegoDeviceType /*deviceType*/, const std::string& /*deviceID*/) {

}
```

**4. 检测画面是否正常**

若此时画面显示正常，则摄像头正常，可用于通话。


### 4.3 扬声器检测   

#### 4.3.1 检测逻辑

播放设备检测流程如下图所示：

<img src="/Pics/Common/ZegoExpressEngine/Playback_device_detection.png" width=555 >


#### 4.3.2 对应接口

**1. 使用媒体播放器播放音频文件** 

调用 [IZegoMediaPlayer](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-media-player&jumpType=route#public-func-lists) 接口播放您用于测试的音频文件。

```c++
// 1. 创建媒体播放器
IZegoMediaPlayer *mediaPlayer = engine->createMediaPlayer();
// 2. 加载资源
std::string currentSelectPath = "xxx";
mediaPlayer->loadResource(currentSelectPath, nullptr);
// 3. 播放资源
mediaPlayer->start();
```

**2. 检测是否听到声音**

如果可以听到相应的音频，则播放设备正常，可用于通话。调用 [onMediaPlayerStateUpdate](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-media-player-event-handler&jumpType=route#on-media-player-state-update) 接口查看媒体播放器状态：

```c++
/**
* 播放器播放状态回调
* @param mediaPlayer 回调的播放器实例
* @param state 播放器状态
* @param errorCode 错误码，详情请参考常见错误码文档
*/
virtual void onMediaPlayerStateUpdate(IZegoMediaPlayer* /*mediaPlayer*/, ZegoMediaPlayerState /*state*/, int /*errorCode*/) { }
```


## 5 API 参考列表

| 方法 | 描述 |
|----|----|
|[startPreview](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-express-engine&jumpType=route#start-preview)|启动本地预览|
|[onDeviceError](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-event-handler&jumpType=route#on-device-error)|设备异常通知|
|[startSoundLevelMonitor](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-express-engine&jumpType=route#start-sound-level-monitor)|启动音量变化监控|
|[onMediaPlayerStateUpdate](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-media-player-event-handler&jumpType=route#on-media-player-state-update)|播放器播放状态回调|



## 6 常见错误码

当开发者收到 [onDeviceError](/article/api?doc=Express_Video_SDK_API~CPP_macos~class~zego-express-i-zego-event-handler&jumpType=route#on-device-error) 设备回调不为 0 时，相关的错误码请参考 [常见错误码](5638#7)。
