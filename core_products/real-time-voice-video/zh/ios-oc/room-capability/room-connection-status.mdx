# 房间连接状态说明

- - -

@@@Introduction_to_Room_Connection_Status@@@

## 监听房间连接状态

@@@Monitor_Room_Connection_Status@@@

<table>
  <colgroup>
    <col width="20%">
    <col width="30%">
    <col width="50%">
  </colgroup>
  <tbody><tr>
    <th>状态及 Reason 枚举值</th>
    <th>含义</th>
    <th>触发进入该状态的常见事件</th>
  </tr>
  <tr>
    <td>Logining（ZegoRoomStateChangedReasonLogining）</td>
    <td>正在登录房间。当调用 [loginRoom] 登录房间或 [switchRoom] 切换到目标房间时，进入该状态，表示正在请求连接服务器。通常通过该状态进行应用界面的展示。</td>
    <td><ul><li>调用 [loginRoom] 登录房间，此时会先进入该状态，此时 errorCode 为 0。</li><li>调用 [switchRoom] 切换到目标房间时，SDK 内部请求登录目标房间，此时 errorCode 为 0。</li></ul></td>
  </tr>
  <tr>
    <td>Logined（ZegoRoomStateChangedReasonLogined）</td>
    <td>登录房间成功。当登录房间或切换房间成功后，进入该状态，表示登录房间已经成功，用户可以正常收到房间内的其他用户和所有流信息增删的回调通知。</td>
    <td><ul><li>调用 [loginRoom] 登录房间成功，此时 errorCode 为 0。</li><li>调用 [switchRoom] 切换到目标房间时，SDK 内部登录目标房间成功，此时 errorCode 为 0。</li></ul></td>
  </tr>
  <tr>
    <td>LoginFailed（ZegoRoomStateChangedReasonLoginFailed）</td>
    <td>登录房间失败。当登录房间或切换房间失败后，进入该状态，表示登录房间或切换房间已经失败，例如 AppID 或 Token 不正确等。</td>
    <td><ul><li>当使用 Token 鉴权功能时，传入的 Token 错误，此时 errorCode 为 1002033。</li><li>当因为网络问题导致登录房间超时，此时 errorCode 为 1002053。</li><li>当切换到目标房间时，SDK 内部登录目标房间失败，此时 errorCode 请参考以上登录错误说明。</li></ul></td>
  </tr>
  <tr>
    <td>Reconnecting（ZegoRoomStateChangedReasonReconnecting）</td>
    <td>房间连接临时中断。如果因为网络质量不佳产生的中断，SDK 会进行内部重试。</td>
    <td>当因为网络质量不佳导致房间连接临时中断并进行重连，此时 errorCode 为 1002051。</td>
  </tr>
  <tr>
    <td>Reconnected（ZegoRoomStateChangedReasonReconnected）</td>
    <td>房间重新连接成功。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，重连成功后进入该状态。</td>
    <td>当因为网络质量不佳导致房间连接临时中断后重连成功，此时 errorCode 为 0。</td>
  </tr>
  <tr>
    <td>ReconnectFailed（ZegoRoomStateChangedReasonReconnectFailed）</td>
    <td>房间重新连接失败。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，重连失败后进入该状态。</td>
    <td>当因为网络质量不佳导致房间连接临时中断后重连失败，此时 errorCode 为 1002053。</td>
  </tr>
  <tr>
    <td>KickOut（ZegoRoomStateChangedReasonKickOut）</td>
    <td>被服务器踢出房间。例如有相同用户名在其他地方登录房间导致本端被踢出房间，会进入该状态。</td>
    <td><ul><li>用户被踢出房间（由于 userID 相同的用户在其他地方登录），此时 errorCode 为 1002050。</li><li>用户被踢出房间（开发者主动调用后台的 <a target="_blank" href="/article/19569">踢出房间用户</a> 接口），此时 errorCode 为 1002055。</li></ul></td>
  </tr>
  <tr>
    <td>Logout（ZegoRoomStateChangedReasonLogout）</td>
    <td>登出房间成功。没有登录房间前默认为该状态，当调用 [logoutRoom] 登出房间成功或 [switchRoom] 内部登出当前房间成功后，进入该状态。</td>
    <td><ul><li>当调用 [logoutRoom] 登出房间成功后，此时 errorCode 为 0。</li><li>当调用 [switchRoom] 切换房间时，SDK 内部登出当前房间成功。</li></ul></td>
  </tr>
  <tr>
    <td>LogoutFailed（ZegoRoomStateChangedReasonLogoutFailed）</td>
    <td>登出房间失败。当调用 [logoutRoom] 登出房间失败或 [switchRoom] 内部登出当前房间失败后，进入该状态。</td>
    <td>在多房间场景下，当调用 [logoutRoom] 登出某个房间时，房间 ID 不存在，此时 errorCode 为 1002002。<br>登出房间失败后请根据实际失败原因再次尝试登出，否则在心跳超时前其他用户都能看到该用户。</td>
  </tr>
</tbody></table>

开发者可参考以下代码处理常见业务事件：

```objc
-(void)onRoomStateChanged:(ZegoRoomStateChangedReason)reason errorCode:(int)errorCode extendedData:(NSDictionary *)extendedData roomID:(NSString *)roomID {
    if(reason == ZegoRoomStateChangedReasonLogining)
    {
        // 登录中
        // 当调用 loginRoom 登录房间或 switchRoom 切换到目标房间时，进入该状态，表示正在请求连接服务器。
    }
    else if(reason == ZegoRoomStateChangedReasonLogined)
    {
        // 登录成功
        // 当前是开发者主动调用 loginRoom 登录成功，或调用 switchRoom 切换房间成功触发的回调。这里可以处理首次登录房间成功的业务逻辑，比如拉取聊天室、直播间基础信息。
    }
    else if(reason == ZegoRoomStateChangedReasonLoginFailed)
    {
        // 登录失败
        if (errorCode == 1002033) {
            //当使用登录房间鉴权的功能时，传入的 Token 错误或者过期
        }
    }
    else if(reason == ZegoRoomStateChangedReasonReconnecting)
    {
        // 重连中
        // 当前是 SDK 断线重连成功触发的回调，这里建议展示一些重连的 UI
    }
    else if(reason == ZegoRoomStateChangedReasonReconnected)
    {
        // 重连成功
    }
    else if(reason == ZegoRoomStateChangedReasonReconnectFailed)
    {
        // 重连失败
        // 当房间连接彻底断开时，SDK 不会再进行重连，开发者如果需要再次登录房间，可以主动调用 loginRoom 接口
        // 此时可以在业务中退出房间/直播间/课堂，或者手动调用接口再次登录
    }
    else if(reason == ZegoRoomStateChangedReasonKickOut)
    {
        // 被踢出房间
        if (errorCode == 1002050) {
            // 用户被踢出房间（由于 userID 相同的用户在其他地方登录）
        }
        else if (errorCode == 1002055) {
            // 用户被踢出房间（开发者主动调用后台的踢人接口）
        }
    }
    else if(reason == ZegoRoomStateChangedReasonLogout)
    {
        // 登出成功
        // 开发者主动调用 logoutRoom 登出房间成功
        // 或调用 switchRoom 切换房间，SDK 内部登出当前房间成功
        // 开发者可以在这里处理主动登出房间回调的逻辑
    }
    else if(reason == ZegoRoomStateChangedReasonLogoutFailed)
    {
        // 登出失败
        // 开发者主动调用 logoutRoom 登出房间失败
        // 或调用 switchRoom 切换房间，SDK 内部登出当前房间失败
        // 错误的原因可能有登出房间 ID 错误或者不存在
    }
}
```


## 房间断线重连

用户登录房间后，因网络信号问题/网络类型切换问题导致与房间断连，SDK 内部会自动重连。用户与房间断连后重连有三种情况：

- 在 ZEGO 服务端判断用户 A 心跳超时前重连成功
- 在 ZEGO 服务端判断用户 A 心跳超时后重连成功
- 用户 A 重连失败

<div class="mk-hint">

- 心跳超时时间为 90s。
- 重试超时时间为 20min。
</div>



下图以用户 A 和用户 B 已登录同一个房间的情况下，用户 A 与房间断连后重连的情况为例：

@@@Room_Disconnection_and_Reconnection_iOS@@@


## 相关文档

[Express SDK 是否支持断线重连机制？\|_blank](https://doc-zh.zego.im/faq/reconnect?product=ExpressVideo&platform=ios)
