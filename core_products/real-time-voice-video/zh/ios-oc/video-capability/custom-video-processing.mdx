<style>
table th:nth-of-type(1) {width: 20%;}
table {width: 100%;}
</style>

# 自定义视频前处理

- - -

## 功能简介

@@@Express_Custom_Video_Pre-processing-function_Introduction@@@

## 示例源码下载

ZEGO 提供了一个通过 Effects SDK 实现美颜功能的示例源码，请参考 [实时音视频和 AI 美颜的搭配使用\|_blank](#11256)。

## 前提条件

在进行自定义视频前处理前，请确保：

@@@Express-Video_Prerequisites@@@

## 使用步骤

自定义视频前处理的流程与接口调用，如下所示： 

<img src="/Pics/Common/ZegoExpressEngine/custom_video_process_ios_new.png">

1. 初始化 Express SDK，并登录房间。
2. 调用 [enableCustomVideoProcessing\|_blank](@enableCustomVideoProcessing) 接口，[开启自定义视频前处理](7655#4_1) 功能。
5. [获取原始视频数据，进行视频前处理](7655#4_2)。
    1. 调用 [setCustomVideoProcessHandler\|_blank](@setCustomVideoProcessHandler) 接口，注册自定义视频前处理回调，并实现 [onCapturedUnprocessedCVPixelBuffer\|_blank](@onCapturedUnprocessedCVPixelBuffer) 等回调方法。
    2. 开始预览，推流。
    3. 通过 [onStart\|_blank](@onStart-ZegoCustomVideoProcessHandler) 回调，通知自定义视频前处理开始，开发者如果使用第三方美颜库或者预先申请内存，可以在此时初始化工具和分配内存。
    4. 通过 [onCapturedUnprocessedCVPixelBuffer\|_blank](@onCapturedUnprocessedCVPixelBuffer) 回调接口获取原始视频数据。开发者可以根据业务需要，进行相关处理：可以通过 Express SDK 自带的基础美颜、水印等功能处理；也可以与 Effects SDK 搭配实现更多处理效果。
    5. 视频数据处理完成后，在 [onCapturedUnprocessedCVPixelBuffer\|_blank](@onCapturedUnprocessedCVPixelBuffer) 回调中，调用 [sendCustomVideoProcessedCVPixelBuffer\|_blank](@sendCustomVideoProcessedCVPixelBuffer) 接口，向 Express SDK 发送处理后的视频帧数据。
4. 其他客户端可以拉取处理后的视频流。
5. 停止预览及推流。
6. 通过 [onStop\|_blank](@onStop-ZegoCustomVideoProcessHandler) 回调，通知自定义视频前处理结束，开发者如果使用第三方美颜库或者预先申请内存，可以在此时反初始化工具并释放内存。
7. 退出房间，销毁引擎，释放资源。


### 1 开启自定义视频前处理

创建自定义视频前处理 [ZegoCustomVideoProcessConfig\|_blank](@-ZegoCustomVideoProcessConfig) 对象，设置 [bufferType\|_blank](@bufferType-ZegoCustomVideoProcessConfig) 属性，用于提供视频帧数据类型。

目前 iOS SDK 支持如下 2 种 [bufferType \|_blank](@-ZegoVideoBufferType) 数据类型，设置其他枚举值将无法正常使用：

| Buffer 类型 | 枚举值|说明 |
|-----|------|-----|
| CVPixelBuffer | ZegoVideoBufferTypeCVPixelBuffer |表示 CVPixelBufferRef 类型的原始视频数据，格式为 BGRA32。|
| NV12CVPixelBuffer | ZegoVideoBufferTypeNV12CVPixelBuffer |表示 CVPixelBufferRef 类型的原始视频数据，格式为 NV12。|

在开始预览和开始推流前，调用 [enableCustomVideoProcessing\|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#enable-custom-video-processing-config) 接口，开启自定义视频前处理功能。

下文以 “ZegoVideoBufferTypeCVPixelBuffer” 为例演示自定义视频前处理的用法。

```objc
ZegoCustomVideoProcessConfig *processConfig = [[ZegoCustomVideoProcessConfig alloc] init];
// 选择 CVPixelBuffer 类型视频帧数据
processConfig.bufferType = ZegoVideoBufferTypeCVPixelBuffer;

[[ZegoExpressEngine sharedEngine] enableCustomVideoProcessing:YES config:processConfig channel:ZegoPublishChannelMain];
```

### 2 获取原始视频数据，进行视频前处理

#### 2.1 注册自定义视频前处理回调

1. 将 “ViewController” 作为自定义视频前处理回调对象，遵循 [ZegoCustomVideoProcessHandler \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~protocol~zego-custom-video-process-handler) 协议。

    ```objc
    @interface ViewController () <ZegoEventHandler, ZegoCustomVideoProcessHandler>

        ......

    @end
    ```

2. 调用 [setCustomVideoProcessHandler \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#set-custom-video-process-handler) 接口，设置自定义视频采集回调。

    ```objc
    // 将自身作为自定义视频前处理回调对象
    [[ZegoExpressEngine sharedEngine] setCustomVideoProcessHandler:self];
    ```

#### 2.2 获取原始视频，进行前处理

1. 使用 “ZegoVideoBufferTypeCVPixelBuffer” 类型的视频前处理方式，需要实现 [onCapturedUnprocessedCVPixelBuffer\|_blank](@onCapturedUnprocessedCVPixelBuffer) 回调方法。当 SDK 获取到原始视频数据后，会通过 [onCapturedUnprocessedCVPixelBuffer\|_blank](@onCapturedUnprocessedCVPixelBuffer) 方法通知开发者。

2. 开发者可以使用 Express SDK 自带的基础美颜、水印等功能处理视频数据，详情请参考 [推流视频增强\|_blank](!Publish_Video_Enhanced)；也可以与 Effects SDK 搭配实现更多处理效果，详情请参考 [实时音视频和 AI 美颜的搭配使用\|_blank](#11256)。
    <div class="mk-warning">

    开发者如果使用第三方美颜库或者预先申请内存，请在：
    - 自定义视频前处理开始时（[onStart\|_blank](@onStart-ZegoCustomVideoProcessHandler)），初始化工具和分配内存。
    - 自定义视频前处理结束时（[onStop\|_blank](@onStop-ZegoCustomVideoProcessHandler)），反初始化工具并释放内存。 
    </div>



3. 处理完成后，调用 [sendCustomVideoProcessedCVPixelBuffer\|_blank](@sendCustomVideoProcessedCVPixelBuffer) 接口，将处理后的视频帧数据发送给 Express SDK，推流出去，其他客户端可以拉取到处理后的视频流。

```objc
- (void)onCapturedUnprocessedCVPixelBuffer:(CVPixelBufferRef)buffer timestamp:(CMTime)timestamp channel:(ZegoPublishChannel)channel {
    // 自定义前处理：此处使用 Effects SDK 进行视频处理
    [self.effects processImageBuffer:buffer];
    
    // 将处理后的 buffer 发回 Express SDK 里
    [[ZegoExpressEngine sharedEngine] sendCustomVideoProcessedCVPixelBuffer:buffer timestamp:timestamp channel:channel];
}
```
