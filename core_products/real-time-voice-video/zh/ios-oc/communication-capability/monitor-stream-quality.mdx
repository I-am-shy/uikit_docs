---
articleID: 1079
---
# 通话质量监测

---

## 功能简介

@@@Introduction_to_the_call_quality_detection_function@@@

## 示例源码

请参考 [下载示例源码](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/ZegoExpressExample/Examples/AdvancedStreaming/StreamMonitoring” 目录下的文件。


## 前提条件

在监测通话质量之前，请确保：

@@@Express-Video_Prerequisites@@@

## 基础网络质量报告

您可以通过监听 [onNetworkQuality](@onNetworkQuality) 回调，收到用户（包括您自己）的上下行网络质量。此回调每隔两秒会收到一次，网络质量等级请参考 [ZegoStreamQualityLevel](@-ZegoStreamQualityLevel)。

不同版本的 [onNetworkQuality](@onNetworkQuality) 回调逻辑有所不同：

@@@onNetworkQuality_callback@@@

<div class="mk-warning">


[onNetworkQuality](@onNetworkQuality) 不适用于使用 CDN 进行直播的场景，您可以参考 [进阶质量报告 - 推流质量报告](!Publisher_Player_Advanced/MonitorStreamQuality#5_1) 监测 CDN 的推流质量。
</div>


```objective-c
- (void)onNetworkQuality:(NSString *)userID upstreamQuality:(ZegoStreamQualityLevel)upstreamQuality downstreamQuality:(ZegoStreamQualityLevel)downstreamQuality {
    if (userID.length == 0) {
        // 代表本地用户（本端）的网络质量
        NSLog(@"我的上行网络质量是 %lu", (unsigned long)upstreamQuality);
        NSLog(@"我的下行网络质量是 %lu", (unsigned long)downstreamQuality);
    } else {
        //代表房间内其他用户的网络质量
        NSLog(@"用户 %@ 的上行网络质量是 %lu", userID, (unsigned long)upstreamQuality);
        NSLog(@"用户 %@ 的下行网络质量是 %lu", userID, (unsigned long)downstreamQuality);
    }
    
    /*
     ZegoStreamQualityLevelExcellent 网络质量极好
     ZegoStreamQualityLevelGood 网络质量好
     ZegoStreamQualityLevelMedium 网络质量正常
     ZegoStreamQualityLevelBad 网络质量差
     ZegoStreamQualityLevelDie 网络异常
     ZegoStreamQualityLevelUnknown 网络质量未知
     */
}
```


## 进阶质量报告

如果上述的基础网络质量报告不能满足您的需求，ZEGO 还提供了更详细的推流质量报告、拉流质量报告以及其他相关信息。

### 推流质量报告

推流质量报告是指描述用户把音视频推送到 ZEGO 服务端这个过程的质量报告，包含了采集、编码阶段音视频流的帧率，传输（发送）的音视频流的帧率、码率、延时及丢包率。

您可以通过注册 [onPublisherQualityUpdate](@onPublisherQualityUpdate) 接收推流质量回调，推流成功后每隔三秒会收到此回调。可根据 quality（[ZegoPublishStreamQuality](@-ZegoPublishStreamQuality)) 参数实时了解推送的音视频流的健康情况。

- 大多数情况下，您只需要关注 “quality” 的 “level” 参数，以 “level” 枚举值来判断推流的综合质量，详情可参考 [ZegoStreamQualityLevel](@-ZegoStreamQualityLevel)。
- 如果您想关注更详细的推流质量参数，可以参考 [ZegoPublishStreamQuality](@-ZegoPublishStreamQuality)。


```objective-c
    // 开发者可以在此回调中监控具体的质量以上报到业务服务器做监控，或者监控质量对象的某个字段以给用户友好的提示
- (void)onPublisherQualityUpdate:(ZegoPublishStreamQuality *)quality streamID:(NSString *)streamID {
    NSString *networkQuality = @"";
    // level 代表了推流质量的综合分数，大部分情况下，开发者可以参考此分数展示上行网络的质量

    switch (quality.level) {
        case ZegoStreamQualityLevelExcellent:
            networkQuality = @"非常好";
            break;
        case ZegoStreamQualityLevelGood:
            networkQuality = @"好";
            break;
        case ZegoStreamQualityLevelMedium:
            networkQuality = @"一般";
            break;
        case ZegoStreamQualityLevelBad:
            networkQuality = @"差";
            break;
        case ZegoStreamQualityLevelDie:
            networkQuality = @"失败";
            break;
        case ZegoStreamQualityLevelUnknown:
            networkQuality = @"未知";
            break;
        default:
            break;
    }
    NSLog(@"推流的网络质量是：%@", networkQuality);
    
}
```

### 拉流质量报告

拉流质量报告指用户拉取播放音视频流这个过程的质量报告，包含了接收的音视频流的帧率、码率、延时和丢包率，解码阶段音视频流的帧率，以及渲染阶段的帧率、卡顿率、音视频整体质量。

您可以通过注册 [onPlayerQualityUpdate](@onPlayerQualityUpdate) 接收拉流质量回调，拉流成功后每隔三秒会收到此回调。可根据 quality（[ZegoPlayStreamQuality](@-ZegoPlayStreamQuality)) 参数实时了解拉取的音视频流的健康情况。

- 大多数情况下，您只需关注 “quality” 的 “level” 参数，以 “level” 枚举值来判断拉流的综合质量，详情可参考 [ZegoStreamQualityLevel](@-ZegoStreamQualityLevel)。
- 如果您想关注更详细的拉流质量参数，可以参考 [ZegoPlayStreamQuality](@-ZegoPlayStreamQuality)。


```objective-c
    // 开发者可以在此回调中监控具体的质量以上报到业务服务器做监控，或者监控质量对象的某个字段以给用户友好的提示
- (void)onPlayerQualityUpdate:(ZegoPlayStreamQuality *) quality streamID:(NSString *) streamID {
    NSString *networkQuality = @"";
    // level 代表了拉流质量的综合分数，大部分情况下，开发者可以参考此分数展示下行网络的质量

    switch (quality.level) {
        case ZegoStreamQualityLevelExcellent:
            networkQuality = @"非常好";
            break;
        case ZegoStreamQualityLevelGood:
            networkQuality = @"好";
            break;
        case ZegoStreamQualityLevelMedium:
            networkQuality = @"一般";
            break;
        case ZegoStreamQualityLevelBad:
            networkQuality = @"差";
            break;
        case ZegoStreamQualityLevelDie:
            networkQuality = @"失败";
            break;
        case ZegoStreamQualityLevelUnknown:
            networkQuality = @"未知";
            break;
        default:
            break;
    }
    NSLog(@"拉流的网络质量是：%@", networkQuality);
    
}
```

@@@Express_mos_quality_score@@@


## 其他信息监测

### 推流/拉流状态变化通知

#### 1. 推流状态回调

在推流成功后，开发者可通过 [onPublisherStateUpdate](@onPublisherStateUpdate) 获取推流状态变更的通知。

```objective-c
- (void)onPublisherStateUpdate:(ZegoPublisherState)state errorCode:(int)errorCode extendedData:(NSDictionary *)extendedData streamID:(NSString *)streamID {
        // 当 state 为 ZegoPublisherStateNoPublish 时，且 errcode 非 0，表示推流失败，同时不会再进行重试推流了，此时可在界面作出推流失败提示。   
        // 当 state 为 ZegoPublisherStatePublishRequesting 时，且 errcode 非 0，表示在重试推流，此时如果超出重试时间未成功推流会抛出推流失败通知。
}
```

您可以根据回调内的 “state” 参数是否在 “正在请求推流状态” 来大体判断用户的推流网络情况。“state” 参数的取值与用户推流状态对应如下:

<table>
  <colgroup>
    <col width="30%">
    <col width="70%">
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZegoPublisherStateNoPublish</td>
<td>未推流状态，在推流前处于该状态。如果推流过程出现稳态的异常，例如 AppID、AppSign、或 Token 等不正确，或者如果其他用户已经在推送流，推送相同流 ID 的流会失败，都会进入未推流状态。</td>
</tr>
<tr>
<td>ZegoPublisherStatePublishRequesting</td>
<td>正在请求推流状态，推流操作执行成功后会进入正在请求推流状态，通常通过该状态进行 UI 界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在请求推流状态。</td>
</tr>
<tr>
<td>ZegoPublisherStatePublishing</td>
<td>正在推流状态，进入该状态表明推流已经成功，用户可以正常通信。</td>
</tr>
</tbody></table>

参数 “extendedData” 为状态更新附带的扩展信息。若使用 ZEGO 的 CDN 内容分发网络，在推流成功后，该参数的内容的键为 “flv_url_list”、“rtmp_url_list”、“hls_url_list”，分别对应 flv、rtmp、hls 协议的拉流 URL。

#### 2. 拉流状态变更回调

在拉流成功后，开发者可通过 [onPlayerStateUpdate](@onPlayerStateUpdate) 获取拉流状态变更的通知。

```objective-c
- (void)onPlayerStateUpdate:(ZegoPlayerState)state errorCode:(int)errorCode extendedData:(NSDictionary *)extendedData streamID:(NSString *)streamID {
        // 当 state 为 ZegoPlayerStateNoPlay 时，且 errcode 非 0，表示拉流失败，同时不会再进行重试拉流了，此时可在界面作出拉流失败提示。
        // 当 state 为 ZegoPlayerStatePlayRequesting 时，且 errcode 非 0，表示重试拉流，此时如果超出重试时间未成功拉到流会抛出拉流失败通知。
}
```

开发者可根据 “state” 参数是否在 “正在请求拉流状态” 来大体判断用户的拉流网络情况。“state” 参数的取值与用户拉流状态对应如下:

<table>
  <colgroup>
    <col width="30%">
    <col width="70%">
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZegoPlayerStateNoPlay</td>
<td>未拉流状态，在拉流前处于该状态。如果拉流过程出现稳态的异常，例如 AppID、AppSign、或 Token 等不正确，都会进入未拉流状态。</td>
</tr>
<tr>
<td>ZegoPlayerStatePlayRequesting</td>
<td>正在请求拉流状态，拉流操作执行成功后会进入正在请求拉流状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在请求拉流状态。</td>
</tr>
<tr>
<td>ZegoPlayerStatePlaying</td>
<td>正在拉流状态，进入该状态表明拉流已经成功，用户可以正常通信。</td>
</tr>
</tbody></table>

### 接收到音频/视频首帧的通知

#### 1. 推流端音频采集首帧回调

@@@Callback_of_the_first_frame_of_audio_collection_at_the_push_end@@@


```objective-c
- (void)onPublisherCapturedAudioFirstFrame {

}
```

#### 2. 推流端视频采集首帧回调（仅实时音视频 Video SDK 支持）

@@@Callback_of_the_first_frame_of_video_collection_at_the_push_end@@@

```objective-c
- (void)onPublisherCapturedVideoFirstFrame:(ZegoPublishChannel)channel {

}
```

#### 3. 拉流端音频接收首帧回调

您可以通过注册 [onPlayerRecvAudioFirstFrame](@onPlayerRecvAudioFirstFrame) 监听拉流端音频接收首帧回调。调用拉流接口成功后，SDK 拉流拉到第一帧音频数据时会收到此回调。

```objective-c
- (void)onPlayerRecvAudioFirstFrame:(NSString *)streamID {
}
```

#### 4. 拉流端视频接收首帧回调（仅实时音视频 Video SDK 支持）

您可以通过注册 [onPlayerRecvVideoFirstFrame](@onPlayerRecvVideoFirstFrame) 监听拉流端接收视频首帧回调。调用拉流接口成功后，SDK 拉流拉到第一帧视频数据时会收到此回调。

```objective-c
- (void)onPlayerRecvVideoFirstFrame:(NSString *)streamID {
}
```

#### 5. 拉流端渲染完视频首帧回调（仅实时音视频 Video SDK 支持）

您可以通过注册 [onPlayerRenderVideoFirstFrame](@onPlayerRenderVideoFirstFrame) 监听拉流端渲染完视频首帧回调。调用拉流接口成功后，SDK 拉流并渲染完第一帧视频数据后会收到此回调。

<div class='mk-hint'>

您可用该回调来统计首帧耗时或更新播放流的 UI 组件。
</div>

```objective-c
- (void)onPlayerRenderVideoFirstFrame:(NSString *)streamID
}
```

### 视频分辨率变化的回调（仅实时音视频 Video SDK 支持）

#### 1. 采集视频分辨率变更回调

@@@Callback_of_the_captured_video@@@


```objective-c
- (void)onPublisherVideoSizeChanged:(CGSize)size channel:(ZegoPublishChannel)channel {
}
```

#### 2. 拉流分辨率变更通知

@@@Pull_stream_resolution_change_notification@@@


```objective-c
- (void)onPlayerVideoSizeChanged:(CGSize)size streamID:(NSString *)streamID {
}
```


## 相关文档

@@@Documents_related_to_call_quality_monitoring@@@
