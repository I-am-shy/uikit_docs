---
articleID: 3641
---
# 使用 CDN 直播

---

## 功能简介

@@@Push_Pull_Streaming_via_CDN@@@

## 前提条件

在使用 CDN 直播之前，请确保：

@@@Express-Video_Prerequisites@@@

@@@Enable_CDN@@@

## 示例源码下载

请参考 [下载示例源码\|_blank](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/ZegoExpressExample/Examples/AdvancedStreaming/StreamByCDN” 目录下的文件。

## 转推 CDN

@@@Express_Started_to_Retweet@@@

```objc
// 推流成功后，开始转推到 CDN

// 推流时使用的流 ID
NSString *streamID = @"STREAM_ID";
// 需要转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名，可自定义
NSString *URL = @"rtmp://推流域名/接入点/streamID";
[self.engine addPublishCDNURL:URL stream:streamID callback:^(int errorCode) {
    // 获取转推 CDN 是否成功的通知
    if(errorCode == 0) {
        // 转推成功
    } else {
        // 转推失败，可能由于网络原因转推请求发送失败
    }
}];
```

### 4 （可选）监听 CDN 转推状态通知

#### 4.1 添加/删除转推 CDN 地址状态回调

开发者可通过注册 [onPublisherRelayCDNStateUpdate\|_blank](@onPublisherRelayCDNStateUpdate) 获取添加/删除转推 CDN 地址状态回调。在 ZEGO RTC 服务器将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。

<div class='mk-hint'>

开发者可根据该回调判断转推 CDN 的音视频流是否正常：
- 若不正常根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
- 若对异常的原因不了解，可联系 ZEGO 技术支持分析具体异常的原因。
</div>


```objc
- (void)onPublisherRelayCDNStateUpdate:(NSArray<ZegoStreamRelayCDNInfo *> *)infoList streamID:(NSString *)streamID {
}
```

#### 4.2 转推 CDN 信息详解

转推 CDN 信息 [ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo) 包含了 CDN 推流的 URL，转推状态，转推状态变更的原因状态发生的时间。[ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo) 内所有参数如下：

|参数名|说明|
|-|-|
|url|CDN 推流的 URL。|
|state|转推状态。|
|updateReason|转推状态变更的原因。|
|stateTime|状态发生的时间。|

其中，state 取值如下：

|枚举值|说明|
|-|-|
|ZegoStreamRelayCDNStateNoRelay|未转推状态，在转推前处于该状态。如果转推过程出现持续的异常，例如转推地址不正确，都会进入未转推状态。|
|ZegoStreamRelayCDNStateRelayRequesting|正在请求转推状态，转推操作执行成功后会进入正在请求转推状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在转推状态。|
|ZegoStreamRelayCDNStateRelaying |正在转推状态，进入该状态表明转推已成功。|

updateReason 取值如下：

|枚举值|说明|
|-|-|
|ZegoStreamRelayCDNUpdateReasonNone|无。|
|ZegoStreamRelayCDNUpdateReasonServerError|服务器错误。|
|ZegoStreamRelayCDNUpdateReasonHandshakeFailed|握手失败。|
|ZegoStreamRelayCDNUpdateReasonAccessPointError|接入点错误。|
|ZegoStreamRelayCDNUpdateReasonCreateStreamFailed|创建流失败。|
|ZegoStreamRelayCDNUpdateReasonBadName|流 ID 不合法。|
|ZegoStreamRelayCDNUpdateReasonCDNServerDisconnected|CDN 服务器主动断开。|
|ZegoStreamRelayCDNUpdateReasonDisconnected|主动断开。|
|ZegoStreamRelayCDNUpdateReasonMixStreamAllInputStreamClosed|混流的全部输入流会话关闭。|
|ZegoStreamRelayCDNUpdateReasonMixStreamAllInputStreamNoData|混流的全部输入流没有数据。|
|ZegoStreamRelayCDNUpdateReasonMixStreamServerInternalError|混流服务器内部错误。|


### 5 停止转推

调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 即可删除动态转推至 CDN 的 URL。**调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 接口停止转推时，请确保当前流 streamID 是存在的。**

<div class = 'mk-warning'>

该接口并不会停止推往 ZEGO 实时音视频云的音视频流。
</div>

```objc
// 推流时使用的流 ID
NSString *streamID = @"STREAM_ID";
// 需要停止转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名
NSString *URL = @"rtmp://推流域名/接入点/streamID";
[self.engine removePublishCDNURL:URL stream:streamID callback:^(int errorCode) {
    // 获取停止转推 CDN 是否成功的通知
    if(errorCode == 0) {
        // 停止转推成功
    } else {
        // 停止转推失败，可能由于网络原因停止转推请求发送失败
    }
}];
```

## 直推 CDN 

@@@Express_Started_to_Push_Directly@@@


```objc
ZegoCDNConfig *config = [[ZegoCDNConfig alloc] init];
// URL 需要开发者根据实际情况填写，streamID 为推流的流名，可自定义
config.URL = @"rtmp://推流域名/接入点/streamID";
[self.engine enablePublishDirectToCDN:YES config:config];
[self.engine startPublishing:@"STREAM_ID"];
```
### 2 停止直推 CDN

若需停止直推 CDN，调用 [stopPublishingStream\|_blank](@stopPublishingStream) 接口停止推流即可。

停止推流后，若下一次推流无需直推 CDN，则可以调用 [enablePublishDirectToCDN\|_blank](@enablePublishDirectToCDN) 并传值为 “false” 关闭直推 CDN 功能。在推流途中调用此接口不会影响此次推流。

```objc
[[ZegoExpressEngine sharedEngine] stopPublishingStream];
ZegoCDNConfig *config = [[ZegoCDNConfig alloc] init];
[[ZegoExpressEngine sharedEngine] enablePublishDirectToCDN:NO config:config];
```

## 观众拉流

@@@Audience_Pull@@@
