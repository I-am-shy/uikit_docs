# 实现流程

- - - 

@@@ZegoObjectSegmentation_Intro@@@

## 前提条件

@@@Object_Segmentation_Prerequisite@@@

## 实现流程

实现流程主要包含 6 个步骤，即初始化 SDK、加入房间、管理麦位、使用主体分割、拉流和退出房间。

### 1 初始化 SDK

- 在管理房间内的麦位之前，需要先初始化 ZIM SDK，并设置通知回调，以便监听 ZIM 事件，接口调用详情请参考 [即时通讯 - 实现基本消息收发\|_blank](#11567#create) 的 “2. 创建 ZIM 实例” 和 “3. 使用 EventHandler 协议”。
- 在实现主体分割之前，需要先初始化 ZEGO Express SDK，同时设置通知回调，以便监听 Express 事件，接口调用请参考 [实时音视频 - 实现视频通话\|_blank](#7628#4_1) 的 “3.1 初始化”。

<img src="/Pics/ZegoObjectSegmentation/init_iOS.png" width="80%">

### 2 加入房间

- 为实现推流，用户需要先登录 RTC 房间，接口调用请参考 [实时音视频 - 实现视频通话\|_blank](#7628#4_2) 的 “3.2 登录房间”。
- 本最佳实践通过修改 ZIM 房间属性实现用户上下麦的业务逻辑，因此，用户需要：
    1. 登录 ZIM 服务，接口调用请参考 [即时通讯 - 实现基本消息收发\|_blank](#11567#login) 的 “2. 登录 ZIM”。
    2. 用户需要创建或加入 ZIM 房间，详情请参考 [即时通讯 - 房间管理\|_blank](#14313#3_1) 的 “创建房间、加入房间”。

<img src="/Pics/ZegoObjectSegmentation/joinRoom_iOS.png" width="80%">

### 3 管理麦位

- 加入 ZIM 房间后，用户可通过查询房间所有属性了解房间内的麦位信息，接口调用详情请参考 [即时通讯 - 房间属性管理\|_blank](#12879#3_3) 的 “获取房间属性”。
- 用户如需上麦，可通过修改房间属性，修改麦位信息，接口调用详情请参考 [即时通讯 - 房间属性管理\|_blank](#12879#3_1) 的 “设置房间属性”。

<img src="/Pics/ZegoObjectSegmentation/micManagement_iOS.png" width="80%">


### 4 使用主体分割

1. 为在推流时传输经主体分割后的图像，需要设置透明通道，请参考 [实时音视频 - 主体分割|_blank](#16478#4_7) 的 “使用 Alpha 通道传输分割出的主体”，了解如何调用 [enableAlphaChannelVideoEncoder\|_blank](@enableAlphaChannelVideoEncoder) 设置透明通道。

2. 由于手机前置摄像头捕捉的画面与实际左右相反，需要开启屏幕镜像，以便预览或拉流时，获取正确方向画面，接口调用详情请参考 [实时音视频 - 常用视频配置\|_blank](#10365#4_3) 的 “4.3 设置镜像模式”。

3. 出于旋转手机屏幕时画面的美观角度，需要设置采集视频的朝向，接口调用详情请参考 [实时音视频 - 视频采集旋转\|_blank](#15974)。

4. 如需预览本端的画面，需先将用于渲染的 View 的 backgroundColor 属性为 clearColor（透明色），接口调用详情请参考 [实时音视频 - 主体分割\|_blank](#16478#4_2) 的 “对 view 进行特殊设置”。

    预览和推送本端画面，接口调用详情请参考 [实时音视频 - 主体分割\|_blank](#16478#4_8) 的 “开始预览和推流”。

5. 开启主体分割，接收分割结果，接口调用详情请参考 [实时音视频 - 主体分割\|_blank](#16478#4_5) 的 “监听主体分割状态回调” 和 “使用主体分割实现多种业务功能”。

    <div class="mk-hint">

    由于 RTC 房间仅与推流有关，所以，开发者也可在 RTC 房间外预览主体分割的效果。
    </div>

<img src="/Pics/ZegoObjectSegmentation/previewAndPublishing_iOS.png" width="80%">


### 5 拉流

用户收到 ZIM 事件通知，得知房间内有人上麦后：
1. 调用实时音视频接口将用于渲染的 View 的 backgroundColor 属性为 clearColor（透明色），接口调用详情请参考 [实时音视频 - 主体分割\|_blank](#16478#4_2) 的 “对 view 进行特殊设置”。
    
    <div class="mk-hint">
    
    如在预览时实现了对 View 的设置，则可省略此步骤。
    </div>

2. 拉取对方已实现主体分割的视频流，从而实现两个用户处在 “同一空间” 面对面对话的视觉效果。接口调用详情请参考 [实时音视频 - 主体分割\|_blank](#16478#4_9) 的 “开始拉流”。
3. 如需结束拉流，接口调用详情可参考 [实时音视频 - 实现视频通话\|_blank](#7628#5_2) 的 “停止音视频通话”。

<img src="/Pics/ZegoObjectSegmentation/playingStream_iOS.png" width="80%">

### 6 退出房间

1. 停止预览和推流，接口调用详情请参考 [实时音视频 - 实现视频通话\|_blank](#7628#5_2) 的 “停止音视频通话”。
2. 离开 ZIM 房间，接口调用详情请参考 [即时通讯 - 房间管理\|_blank](#14313#3_3) 的 “离开房间”。
3. 退出 RTC 房间，接口调用详情请参考 [实时音视频 - 实现视频通话\|_blank](#7628#5_2) 的 “停止音视频通话”。

<img src="/Pics/ZegoObjectSegmentation/logoutRoom_iOS.png" width="80%">
