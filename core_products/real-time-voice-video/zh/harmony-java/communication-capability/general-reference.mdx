# 使用 Token 鉴权

---

## 1 功能介绍

鉴权是指验证用户是否拥有访问系统的权限，来避免因权限控制缺失或操作不当引发的安全风险问题，ZEGO 通过 Token（包括基础鉴权 Token 和权限认证 Token） 对用户进行鉴权。


|鉴权方式|描述|应用场景|
|-|-|-|
|[基础鉴权 Token](!Integration/User_Access_Control#tab_item1)|开发者在登录房间时必须带上 Token 参数，来验证用户的合法性。|基础鉴权 Token 为 Token 的基本能力，用于业务的简单权限验证场景，绝大多数情况下生成该 Token 即可。 |
|[权限认证 Token](!Integration/User_Access_Control#tab_item1)|为了进一步提高安全性开放了房间 ID 和推流 ID 这两个权限位，可以验证登录房间的 ID 和推流 ID。|房间 ID 和推流 ID 权限位的一般使用场景如下：<ul><li>房间有普通房间和会员房间的区别，需要控制非会员用户登录会员房间。</li><li>语聊房或秀场直播中，需要控制推流用户和麦上用户的一致，防止“幽灵麦”现象，即在房间里听到了非麦上用户声音的情况。</li><li>狼人杀等发言游戏，需要防止应用被黑客破解之后，黑客可以使用其他用户 ID 登录同一房间，获取到游戏进行的信息进行作弊，影响正常用户的游戏体验。</li></ul>|


## 2 前提条件

<Warning title="注意">
- 仅 2.17.0 及以上版本 ZEGO Express SDK，支持参考本文档使用 Token 鉴权。
- 若您集成的是 2.17.0 之前版本的 ZEGO Express SDK（使用 AppSign 鉴权），现在想升级到 2.17.0 版本且使用 Token 鉴权，可以通过 [如何从 AppSign 鉴权升级为 Token 鉴权](https://doc-zh.zego.im/faq/token_upgrade) 文档了解 AppSign 鉴权和 Token 鉴权更多信息。
</Warning>


## 3 实现流程

使用 Token 鉴权时，需要开发者先生成 Token，再携带 Token 登录房间。ZEGO 服务端对带着 Token 的用户进行校验。

以使用 Token 判断用户是否能登录房间为例介绍使用流程，如下图：


<Frame width="512" height="auto" caption=""><img src="https://storage.zego.im/sdk-doc/Pics/QuickStart/token_uml.png" /></Frame>

1. 开发者客户端发起申请 Token 的请求。
2. 在开发者的服务端上生成 Token，并返回给开发者客户端。
3. 开发者客户端携带申请到的 Token 和 userID、roomID 信息，登录对应的房间。
4. ZEGO SDK 会自动将 Token 发送到 ZEGO 服务端进行校验。
5. ZEGO 服务端会将校验结果返回给 ZEGO SDK。
6. ZEGO SDK 再将校验的结果直接返回给开发者客户端，没有权限的客户端将登录失败。


## 4 使用步骤

@@@Token_usage_steps@@@


### 4.2 生成 Token


#### 4.2.1 服务端生成 Token（推荐）

@@@Server_generates_Token_1@@@

@@@Server_generates_Token_2@@@

#### 4.2.2 客户端生成 Token（不推荐）

若您在开发过程中还无法通过服务端下发 Token 时，可以先使用客户端代码生成 Token，待服务端开发完后，再完成对接。

<Warning title="注意">

- App 上线时，切勿在客户端生成 Token，否则您的 ServerSecret 将暴露在风险中。
- 为保证安全性，强烈推荐您使用服务端生成 Token，否则会存在 ServerSecret 被窃取的风险。
</Warning>


zego_server_assistant 插件中用于客户端生成 Token 的各语言参考信息如下：

<table>
  <colgroup>
    <col width="20%"/>
    <col width="30%"/>
    <col width="20%"/>
    <col width="30%"/>
  </colgroup>
  <tbody><tr>
    <th>语言</th>
    <th>支持版本</th>
    <th>关键函数</th>
    <th>具体地址</th>
  </tr>
  <tr>
    <td>C++</td>
    <td>C++ 11 或以上版本</td>
    <td>GenerateToken04</td>
    <td><ul><li><a target="_blank" href="https://github.com/zegoim/zego_server_assistant/blob/release/github/token/c%2B%2B/token04">GitHub</a></li><li><a target="_blank" href="https://gitee.com/zegodev_admin/zego_server_assistant/tree/release/github/token/c++/token04">Gitee</a></li></ul></td>
  </tr>
  <tr>
    <td>Java</td>
    <td>Java 1.8 或以上版本</td>
    <td>generateToken04</td>
    <td><ul><li><a target="_blank" href="https://github.com/zegoim/zego_server_assistant/tree/release/github/token/java/token04">GitHub</a></li><li><a target="_blank" href="https://gitee.com/zegodev_admin/zego_server_assistant/tree/release/github/token/java/token04">Gitee</a></li></ul></td>
  </tr>
  <tr>
    <td>Objective-C</td>
    <td>-</td>
    <td>GenerateToken04</td>
    <td><ul><li><a target="_blank" href="https://github.com/zegoim/zego_server_assistant/tree/release/github/token/oc/token04">GitHub</a></li><li><a target="_blank" href="https://gitee.com/zegodev_admin/zego_server_assistant/tree/release/github/token/oc/token04">Gitee</a></li><ul></ul></ul></td>
  </tr>
</tbody></table>


### 4.3 使用 Token 

用户携带获取到的 Token 和 user、roomID 信息，通过 [loginRoom](@loginRoom) 接口登录对应的房间。

<div class="mk-warning">

调用 [loginRoom](@loginRoom) 接口登录房间时使用的 roomID、userID，必须和 “4.2 生成 Token” 时使用的 roomID、userID 保持一致。 
</div>

```java
String roomID = "xxx" // 要登录的房间ID
ZegoUser user = new ZegoUser("xxxx");
ZegoRoomConfig config = new ZegoRoomConfig();
config.token = "xxxxxxxxxx"; // 请求开发者服务端获取
engine.loginRoom(roomID, user, config);
```

如果开发者需要在登录房间后修改权限位，也可以调用 [renewToken](@renewToken) 接口更新 Token，更新后会影响下一次登录某些房间和推某些流的权限，之前已经成功的房间登录和推流不受影响。


```java
String token = getToken(); // 重新请求开发者服务端获取 Token;
engine.renewToken(roomID, token);
```


### 4.4 Token 过期处理机制

<Warning title="注意">

Token 过期可能导致推拉流异常等问题，请严格按照以下说明，及时处理过期 Token。
</Warning>

在 Token 过期前 30 秒，SDK 会通过 [onRoomTokenWillExpire](@onRoomTokenWillExpire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [renewToken](@renewToken) 接口更新 Token。若未处理：

 - 可以联系 ZEGO 技术支持额外配置权限位过期管理机制，此时如果未更新 Token，则当权限位过期时：
    - 已登录的用户会被踢出房间，且无法再登录房间。
    - 当前已成功的推流会被停止，也无法进行下一次推流。
- 若未联系 ZEGO 技术支持额外配置权限位过期管理机制，此时如果未更新 Token：
    - 已登录的用户不会被踢出房间。
    - 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。


<div class="mk-hint">

若开启了房间 ID 权限位，用户登录房间时必须主动传入新的 Token。
</div>


```java
@Override
public void onRoomTokenWillExpire(String roomID, int remainTimeInSecond){
    String token = getToken(); // 重新请求开发者服务端获取 Token;
    engine.renewToken(roomID, token);
}
```


## 5 API 参考

| 方法 | 描述 |
|-------|--------|
| [loginRoom](@loginRoom) | 登录房间 |
| [renewToken](@renewToken) | 更新 Token |
| [onRoomTokenWillExpire](@onRoomTokenWillExpire) | Token 过期回调 |


## 相关文档

[如何防止音视频互动中的幽灵麦或炸房的现象？](https://doc-zh.zego.im/faq/bombing)
