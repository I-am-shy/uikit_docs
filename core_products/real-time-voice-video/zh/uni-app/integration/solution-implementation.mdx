---
articleID: 10330
---
# 实现视频通话 

---

@@@Common_usage_introduction@@@

## 2 前提条件  

在实现基本的实时音视频功能之前，请确保：

@@@Express_Video_Implementation_Process_Prerequisites@@@


## 3 使用步骤 

@@@quick_start_base_intro@@@

整个推拉流过程的 API 调用时序如下图：

<img src="/Pics/QuickStart/quickstart_uml_RN.png" alt="时序图">

<a id="CreateEngine"> </a>

### 3.1 创建引擎 

**1. （可选）创建界面**

<details class="zg-primary">
    <summary>添加界面元素</summary>

在创建引擎之前，ZEGO 推荐开发者添加以下界面元素，方便实现基本的实时音视频功能。

- 本地预览窗口
- 远端视频窗口
- 结束按钮

<img src="/Pics/QuickStart/UI.jpg" alt="界面图">



</details>  

**2. 创建引擎** 

调用 [createEngineWithProfile](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#createenginewithprofile) 接口，将申请到的 AppID 和 AppSign 传入参数 “appID” 和 “appSign”，创建引擎单例对象。

<div class="mk-warning">

SDK 同时也支持 Token 鉴权，若您对项目安全性有更高要求，建议您升级鉴权方式，可参考 [如何从 AppSign 鉴权升级为 Token 鉴权](http://doc-zh.zego.im/faq/token_upgrade?product=ExpressVideo)。
</div>

```javascript
// 导入 ZEGO Express SDK
import ZegoExpressEngine from '@/components/zego-ZegoExpressUniApp-JS/lib/ZegoExpressEngine';

// 采用通用场景
const profile = {
appID : xxx,
// AppSign 仅满足简单的鉴权需求，如果需要升级为更加安全的鉴权方式，请参考[如何从 AppSign 鉴权升级为 Token 鉴权](https://doc-zh.zego.im/faq/token_upgrade?product=ExpressVideo&platform=all)
// AppSign 可通过[控制台](https://console.zego.im/dashboard)获取，格式为 @"39011cbxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
appSign: '39011cbxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
scenario : 0
};

ZegoExpressEngine.createEngineWithProfile(profile)
```

**3.设置回调**

创建引擎后开发者可根据实际需要，调用引擎实例的 [on ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#on) 方法设置回调。

<div class="mk-warning">

为避免错过事件通知，建议在在创建引擎后立即注册回调
</div>


<a id="loginRoom"> </a>

### 3.2 登录房间

**1. 登录**  

您可以调用 [loginRoom ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口登录房间。如果房间不存在，调用该接口时会创建并登录此房间。
- roomID 和 user 的参数由您本地生成，但是需要满足以下条件:
    - 同一个 AppID 内，需保证 “roomID” 全局唯一。
    - 同一个 AppID 内，需保证 “userID” 全局唯一，建议开发者将 “userID” 与自己业务的账号系统进行关联。 

```javascript
let roomConfig = {};
// 只有传入 “isUserStatusNotify” 参数取值为 “true” 的 ZegoRoomConfig，才能收到 onRoomUserUpdate 回调。
roomConfig.isUserStatusNotify = true;
// 获取token传入
roomConfig.token = "********";
// 登录房间
// 开始登录房间
ZegoExpressEngine.instance().loginRoom('room1', {'userID': 'id1', 'userName': 'user1'}, roomConfig);
```

**2. 监听登录房间后的事件回调** 

可根据实际应用需要，在登录房间后监听想要关注的事件通知，比如房间状态更新、用户状态更新、流状态更新等。
- [roomStateUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstateupdate)：房间状态更新回调，登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK 会通过该回调通知。
- [roomUserUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate)：用户状态更新回调，登录房间后，当房间内有用户新增或删除时，SDK 会通过该回调通知。

    只有调用 [loginRoom](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口登录房间时传入 [ZegoRoomConfig](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressdefines_.zegoroomconfig.html) 配置，且 “isUserStatusNotify” 参数取值为 “true” 时，用户才能收到 [roomUserUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate) 回调。

- [roomStreamUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstreamupdate)：流状态更新回调，登录房间后，当房间内有用户新推送或删除音视频流时，SDK 会通过该回调通知。

<div class="mk-warning">

- 只有调用 [loginRoom](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口登录房间时传入 [ZegoRoomConfig](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressdefines_.zegoroomconfig.html) 配置，且 “isUserStatusNotify” 参数取值为 “true” 时，用户才能收到 [roomUserUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate) 回调。
- 通常情况下，如果某个用户想要播放其他用户推送的视频，可以在收到流状态更新（新增）的回调中，调用 [startPlayingStream](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#startplayingstream) 接口拉取远端推送的音视频流。
</div>

```javascript
// 以下为常用的房间相关回调

ZegoExpressEngine.instance().on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
  // 房间状态更新回调，登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK会通过该回调通知
}); ;

ZegoExpressEngine.instance().on('roomUserUpdate', (roomID, updateType, userList) => {
  // 用户状态更新，登录房间后，当房间内有用户新增或删除时，SDK会通过该回调通知
});

ZegoExpressEngine.instance().on('roomStreamUpdate', (roomID, updateType, streamList) => {
  // 流状态更新，登录房间后，当房间内有用户新推送或删除音视频流时，SDK会通过该回调通知
});
```

<a id="publishingStream"></a>

### 3.3 推流

**1. 开始推流**

调用 [startPublishingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#startpublishingstream) 接口，传入流 ID 参数 “streamID”，向远端用户发送本端的音视频流。

<div class="mk-warning"> 
    
同一个 AppID 内，需保证 “streamID” 全局唯一。如果同一个 AppID 内，不同用户各推了一条 “streamID” 相同的流，会导致后推流的用户推流失败。  
</div>

```javascript
await ZegoExpressEngine.instance().startPublishingStream("streamID");
```

**2. （可选）启动本地预览**

<details class="zg-primary">
    <summary>设置预览视图并启动本地预览</summary> 

如果希望看到本端画面，在 uni-app 项目中调用 [startPreview ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#startpreview) 接口启动本地预览。利用 uni-app 所提供的 [条件编译](https://uniapp.dcloud.io/tutorial/platform.html#preprocessor)，在 uni-app 项目的**App 环境**中，开发者可使用 `<zego-local-view>` 标签设置预览视图；在 **Web 环境**中，开发者在调用 `startPreview` 时，需要传入一个用于播放视图的 `video` 元素。

```HTML
<template>
    <!-- #ifdef APP-PLUS -->
    <zego-local-view style="height: 403.84rpx;flex: 1;"></zego-local-view>
    <!-- #endif -->
    <!-- #ifdef H5 -->
    <video id="local_video" style="height: 403.84rpx;flex: 1;"  autoplay playsinline :muted="true"></video>
    <!-- #endif -->
</template>

js部分:
/** 开始预览 */
let channel = 0 // channel为可选参数，可传可不传
// #ifdef H5
let localVideoElem = document.querySelector("#local_video video")
ZegoExpressEngine.instance().startPreview(localVideoElem, channel);
// #endif
// #ifdef APP-PLUS
ZegoExpressEngine.instance().startPreview(channel)
// #endif
```
</details>

**3. 监听推流后的事件回调** 

根据实际应用需要，在推流后监听想要关注的事件通知，比如推流状态更新等。

[publisherStateUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#publisherstateupdate)：推流状态更新回调，调用推流接口成功后，当推流状态发生变更，如出现网络中断导致推流异常等情况，SDK 在重试推流的同时，会通过该回调通知。

```javascript
ZegoExpressEngine.instance().on("publisherStateUpdate", (streamID, state, errorCode, extendedData) => {
    // 调用推流接口成功后，当推流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试推流的同时，会通过该回调通知
    //....
});
```

@@@Warning_How_to_switch_devices@@@ 

<a id="PlayingStream"></a>

### 3.4 拉流  

**1. 开始拉流**  

调用 [startPlayingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#startplayingstream) 接口，根据传入的流 ID 参数 “streamID”，拉取远端推送的音视频流。

关于远端视频流视图：
* 在 uni-app 的 App 环境中，若 `startPlayingStream` 调用成功，则无返回值，可使用 `<zego-remote-view>` 标签设置远端视频流视图。
* 在 uni-app 的 Web 环境中，若 `startPlayingStream` 调用成功，会返回一个 MediaStream 对象，开发者可以用返回的 MediaStream 赋值给 video 元素的 srcObject 属性设置远端视频流视图。

<div class="mk-hint">


- 远端用户推送的 “streamID” 可以从 [roomStreamUpdate ](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstreamupdate) 回调中获取。
- 需保证 “streamID” 全局唯一。

</div>



```HTML
<template>
    <!-- #ifdef APP-PLUS -->
    <zego-remote-view :streamID="playStreamID" style="height: 403.84rpx;flex: 1"></zego-remote-view>
    <!-- #endif -->
    <!-- #ifdef H5 -->
    <video id="remote_video" style="height: 403.84rpx;flex: 1;"  autoplay playsinline :muted="true"></video>
    <!-- #endif -->
</template>

js部分:
/** 开始拉流 */
this.playStreamID = "StreamID_1"
const stream = await ZegoExpressEngine.instance().startPlayingStream(this.playStreamID)
// #ifdef H5
document.querySelector("#remote_video video").srcObject = stream
// #endif
```

**2. 监听拉流后的事件回调** 

根据实际应用需要，在拉流后监听想要关注的事件通知，比如拉流状态更新等。

[playerStateUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#playerstateupdate)：拉流状态更新回调，调用拉流接口成功后，当拉流状态发生变更，如出现网络中断导致推流异常等情况，SDK 在重试拉流的同时，会通过该回调通知。

```javascript
ZegoExpressEngine.instance().on("playerStateUpdate", (streamID, state, errorCode, extendedData) => {
    /** 调用拉流接口成功后，当拉流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试拉流的同时，会通过该回调通知 */
    //....
});
```

### 3.5 在线测试推拉流功能

@@@New_Experience_RTC_Functions@@@

### 3.6 停止推拉流

**1. 停止推流/预览**

调用 [stopPublishingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#stoppublishingstream) 接口停止发送本地的音视频流，结束通话。

```javascript
/** 停止推流 */
ZegoExpressEngine.instance().stopPublishingStream();
```

如果启用了本地预览，开发者可以在停止推流后根据业务需要调用 [stopPreview ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#stoppreview) 接口停止预览。

```javascript
/** 停止本地预览 */
ZegoExpressEngine.instance().stopPreview();
```

**2. 停止拉流**

调用 [stopPlayingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#stopplayingstream) 接口，停止拉取远端的音视频流。

<div class="mk-warning">

如果开发者通过 [roomStreamUpdate](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstreamupdate) 回调收到了音视频流 “减少” 的通知，请及时调用 [stopPlayingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#stopplayingstream) 接口停止拉流，避免拉到空流、产生额外的成本；或者，开发者可以根据自己的业务需求，选择合适的时机，主动调用 [stopPlayingStream ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#stopplayingstream) 接口停止拉流。
</div>

```javascript
/** 停止拉流 */
ZegoExpressEngine.instance().stopPlayingStream("streamID");
```


**3. 退出房间**  

调用 [logoutRoom ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#logoutroom) 接口退出房间，本端会收到 [roomStateUpdate ](/unique-api/express-video-sdk/zh/javascript_uni-app/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstateupdate) 回调通知调用结果，并停止其所有推拉流以及本地预览。


```javascript
/** 退出房间 */
ZegoExpressEngine.instance().logoutRoom('room1');
```

### 3.7 销毁引擎

调用 [destroyEngine ](/unique-api/express-video-sdk/zh/javascript_uni-app/classes/_zegoexpressengine_.zegoexpressengine.html#destroyengine) 接口销毁引擎，用于释放 SDK 使用的资源。


```javascript
/** 销毁引擎 */
ZegoExpressEngine.destroyEngine();
```

<div class="mk-hint">

根据实际需要，可在销毁引擎时通过 “await” 关键字，进行异步等待以确保设备硬件资源被释放完成。   
</div>

@@@relevant_quickstart@@@
