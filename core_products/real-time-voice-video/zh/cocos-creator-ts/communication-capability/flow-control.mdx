# 流量控制

---

## 功能简介

@@@Flow_Control_OverView@@@


## 使用步骤

### 1 开启流量控制

推流前调用 [enableTrafficControl\|_blank](@enableTrafficControl) 接口，通过 `enable` 参数开启流量控制，并通过 `property` 参数设置可调节的流量控制属性（码率、帧率、分辨率）。支持选择多项，默认值为 `AdaptiveFPS`，即自适应（降低）视频帧率。当上行带宽不足时，SDK 会根据当前网络环境，根据设置的`property`参数减少最终推流的上行码率，以适应上行带宽。

<div class = 'mk-warning'>

* 使用限制: 仅支持 RTC 推流。
* 当关闭流量控制开关后，已设置的流量控制属性 `property` 也将失效。
* 当流量控制属性中含有自适应分辨率 `AdaptiveResolution` 时，只支持 “16:9” 或 “4:3” 比例的初始分辨率，若初始分辨率为其他值，则自适应分辨率无法生效，SDK 会降级到直接降低编码码率。

</div>

```ts
// 开启流量控制，且同时开启自适应（降低）视频帧率和自适应（降低）视频分辨率
ZegoExpressEngine.instance.enableTrafficControl(true, ZegoTrafficControlProperty.AdaptiveFPS | ZegoTrafficControlProperty.AdaptiveResolution)
```

### 2 （可选）自动调整流量控制属性

SDK 会根据 [创建引擎\|_blank](!Integration/Solution_Implementation#CreateEngine) 时，开发者选择的场景 [`scenario`\|_blank](!video_proflie)，自动设置适合该场景的流量控制属性。例如，秀场直播场景需要保证视频流畅性，推荐选择自适应（降低）视频分辨率；教育场景需要保证清晰度，推荐选择自适应（降低）视频帧率。

<div class="mk-warning">

SDK 会根据接口调用顺序，决定当前流量控制属性，后调用的生效。即如果先通过 `enableTrafficControl` 设置了流量控制属性，再调用 `setRoomScenario` 设置 `scenario`，流量控制属性就会根据 `scenario` 变化。
</div>

### 3 设置流量控制视频码率最小值（纯音频场景可跳过）

开启流量控制后，调用 [setMinVideoBitrateForTrafficControl\|_blank](@setMinVideoBitrateForTrafficControl) 方法设置视频码率最小值（默认值为 “0”）及视频发送模式，可以使 SDK 在网络未达到发送视频的最小码率时，采用该方法设置视频发送模式（不发送视频或以极低的帧率发送）。

<div class = 'mk-warning'>

可以在初始化 SDK 后且推流 [startPublishingStream\|_blank](@startPublishingStream) 前的任意时间调用 [setMinVideoBitrateForTrafficControl\|_blank](@setMinVideoBitrateForTrafficControl)，但需要开启流量控制后该设置才生效。

</div>

```ts
// 开启流控后，当上下行带宽低于 200 kbps 时，以极低的帧率继续发送视频数据
ZegoExpressEngine.instance.setMinVideoBitrateForTrafficControl(200, ZegoTrafficControlMinVideoBitrateMode.UltraLowFPS)
```
