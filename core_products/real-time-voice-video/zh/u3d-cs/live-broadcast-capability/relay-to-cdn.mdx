---
articleID: 14448
---
# 使用 CDN 直播

---

## 功能简介
	 
@@@Push_Pull_Streaming_via_CDN@@@

## 前提条件

在使用 CDN 直播之前，请确保：

@@@Express-Video_Prerequisites@@@

@@@Enable_CDN@@@

## 示例源码下载

请参考 [下载示例源码\|_blank](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “Assets/ZegoExpressExample/Examples/AdvancedStreaming/StreamByCDN” 目录下的文件。

## 转推 CDN

<div class = 'mk-hint'>

若选择使用直推 CDN 功能，则无需执行本节所有步骤，请参考 [直推 CDN](!Publisher_Player_Advanced/RelayToCDN#5)。

</div>

### 1 初始化和登录房间

请参考 [快速开始 - 实现流程\|_blank](!Integration/Solution_Implementation#CreateEngine) 的 “创建引擎”、“登录房间”。

### 2 开始推流

请参考 [快速开始 - 实现流程\|_blank](!Integration/Solution_Implementation#publishingStream) 的 “推流”。

### 3 开始转推

当推流成功后，调用 [AddPublishCdnUrl\|_blank](@AddPublishCdnUrl) 接口增加动态转推至 CDN 的 URL，即可将已经成功推向 ZEGO 实时云的音视频流动态向第三方 CDN 进行转推。支持的转推地址格式为 “rtmp”。

<div class = 'mk-hint'>

- 若开发者有转推到多家第三方 CDN 厂商的需求，可使用同一个流 ID 多次调用 [AddPublishCdnUrl\|_blank](@AddPublishCdnUrl) 接口（URL 需要不同）。
- 开发者转推到多家第三方 CDN 后，停止转推时也同样需要调用多次来停止所有转推的流。
- 开发者转推到多家第三方 CDN 后，可从 CDN 回调状态通知 [OnPublisherRelayCDNStateUpdate\|_blank](@OnPublisherRelayCDNStateUpdate) 的列表参数中获取到每条转推流的状态变更通知。**在 WebGL 平台上运行时，不支持该回调状态通知。**
</div>

                   

```C#
// 推流成功后，开始转推到 CDN 

// 推流时使用的流 ID
string streamID = "STREAM_ID";
// 需要转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名，可自定义
string URL = "rtmp://推流域名/接入点/streamID";
engine.AddPublishCdnUrl(streamID, URL, (int errorCode)=>{
    if(errorCode == 0) 
    {
        // 转推成功
    } else 
    {
        // 转推失败，可能由于网络原因转推请求发送失败        
    }
});
```
   
   
### 4 （可选）监听 CDN 回调的状态通知


#### 4.1 添加/删除转推 CDN 地址状态回调

开发者可通过设置 [OnPublisherRelayCDNStateUpdate\|_blank](@OnPublisherRelayCDNStateUpdate) 委托获取添加/删除转推 CDN 地址状态回调。在 ZEGO RTC 服务器将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。

<div class = 'mk-warning'>
	 
在 WebGL 平台上运行时，不支持该回调状态通知。
</div>

<div class='mk-hint'>

开发者可根据该回调判断转推 CDN 的音视频流是否正常：
- 若不正常根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
- 若对异常的原因不了解，可联系 ZEGO 技术人员分析具体异常的原因。
</div>


```cs
public delegate void OnPublisherRelayCDNStateUpdate(string streamID, List<ZegoStreamRelayCDNInfo> infoList);

engine.OnPublisherRelayCDNStateUpdate = (string streamID, List<ZegoStreamRelayCDNInfo> infoList)=>{

};
```

#### 4.2 转推 CDN 信息详解

转推 CDN 信息 [ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo) 包含了 CDN 推流的 URL，转推状态，转推状态变更的原因状态发生的时间。[ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo)内所有参数如下：

<div class = 'mk-warning'>
	 
在 WebGL 平台上运行时，没有转推 CDN 信息 [ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo)。
</div>

|参数名|说明|
|-|-|
|url|CDN 推流的 URL。|
|state|转推状态。|
|updateReason|转推状态变更的原因。|
|stateTime|状态发生的时间。|

其中，state 取值如下：

|枚举值|说明|
|-|-|
| ZegoStreamRelayCDNState.NoRelay |未转推状态，在转推前处于该状态。如果转推过程出现持续的异常，例如转推地址不正确，都会进入未转推状态。|
| ZegoStreamRelayCDNState.RelayRequesting |正在请求转推状态，转推操作执行成功后会进入正在请求转推状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在转推状态。|
| ZegoStreamRelayCDNState.Relaying |正在转推状态，进入该状态表明转推已成功。|

updateReason 取值如下：

|枚举值|说明|
|-|-|
| ZegoStreamRelayCDNUpdateReason.None |无。|
| ZegoStreamRelayCDNUpdateReason.ServerError |服务器错误。|
| ZegoStreamRelayCDNUpdateReason.HandshakeFailed |握手失败|。
| ZegoStreamRelayCDNUpdateReason.AccessPointError |接入点错误。|
| ZegoStreamRelayCDNUpdateReason.CreateStreamFailed |创建流失败。|
| ZegoStreamRelayCDNUpdateReason.BadName |流 ID 不合法。|
| ZegoStreamRelayCDNUpdateReason.CDNServerDisconnected |CDN 服务器主动断开。|
| ZegoStreamRelayCDNUpdateReason.Disconnected |主动断开。|
| ZegoStreamRelayCDNUpdateReason.MixStreamAllInputStreamClosed |混流的全部输入流会话关闭。|
| ZegoStreamRelayCDNUpdateReason.MixStreamAllInputStreamNoData |混流的全部输入流没有数据。|
| ZegoStreamRelayCDNUpdateReason.MixStreamServerInternalError |混流服务器内部错误。|


### 5 停止转推

调用 [RemovePublishCdnUrl\|_blank](@RemovePublishCdnUrl) 即可删除动态转推至 CDN 的 URL。**调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 接口停止转推时，请确保当前流 streamID 是存在的。**

<div class = 'mk-warning'>
	 
该接口并不会停止推往 ZEGO 实时音视频云的音视频流。

</div>


```C#
// 推流时使用的流 ID
string streamID = "STREAM_ID";
// 需要停止转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名
string URL = "rtmp://推流域名/接入点/streamID";
engine.RemovePublishCdnUrl(streamID, URL, (int errorCode)=>{
    if(errorCode == 0) 
    {
        // 停止转推成功
    } else 
    {
        // 停止转推失败，可能由于网络原因停止转推请求发送失败
    }
});
```


## 直推 CDN 

<div class = 'mk-warning'>

- 在 WebGL 平台上运行时，不支持直推 CDN。
- 若选择使用转推 CDN 功能，则无需执行本节所有步骤，请参考 [转推 CDN](!Publisher_Player_Advanced/RelayToCDN#4)。
</div>

### 1 开始直推 CDN

在推流前调用 [EnablePublishDirectToCDN\|_blank](@EnablePublishDirectToCDN) 接口将音视频流直接推往 CDN。

<div class = 'mk-warning'>

- 调用 [EnablePublishDirectToCDN\|_blank](@EnablePublishDirectToCDN) 接口后再调用 [AddPublishCdnUrl\|_blank](@AddPublishCdnUrl) 与 [RemovePublishCdnUrl\|_blank](@RemovePublishCdnUrl) 动态转推至 CDN 则不再生效，因为这两个接口是从 ZEGO 实时音视频云将音视频流转推或停止转推到 CDN，若将音视频流直接推往 CDN 则无法通过 ZEGO 实时音视频云将音视频流再动态转推至 CDN。
- 若调用 [EnablePublishDirectToCDN\|_blank](@EnablePublishDirectToCDN) 接口出现 1000038 错误码，可能存在的问题有：域名配置错误、媒体网络异常或媒体网络链接为空，请联系 ZEGO 技术支持。
</div> 



```C#
ZegoCDNConfig config = new ZegoCDNConfig();
// URL 需要开发者根据实际情况填写，streamID 为推流的流名，可自定义
config.url = "rtmp://推流域名/接入点/streamID";
engine.EnablePublishDirectToCDN(true, config);
engine.StartPublishingStream("STREAM_ID");
```

### 2 停止直推 CDN 

若需停止直推 CDN，调用 [StopPublishingStream\|_blank](@StopPublishingStream) 接口停止推流即可。

停止推流后，若下一次推流无需直推 CDN，则可以调用 [EnablePublishDirectToCDN\|_blank](@EnablePublishDirectToCDN) 接口并传值为 “false” 关闭直推 CDN 功能。在推流途中调用此接口不会影响此次推流。

```C#
engine.StopPublishingStream();
ZegoCDNConfig cdnConfig = new ZegoCDNConfig();
engine.EnablePublishDirectToCDN(false, cdnConfig);
```

## 观众拉流

@@@Audience_Pull@@@
