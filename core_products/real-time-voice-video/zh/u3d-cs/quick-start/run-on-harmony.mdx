# 快速接入 HarmonyOS 平台

- - - -
本文将为您介绍如何基于 Zego Express Unity3D SDK，快速接入 HarmonyOS 平台。

## 准备环境

请确保开发环境满足以下要求：

- [Unity](https://unity.cn/tuanjie/tuanjieyinqing) 2018.4.21f1 或以上版本（建议通过 Unity Hub 下载最新的 LTS 版本）。
- 确保运行设备已经连接到 Internet。

<Note title="说明">


本文说的 Unity 是指 [团结引擎](https://unity.cn/tuanjie/tuanjieyinqing)，目前只有 Unity 中国团队的团结引擎支持 HarmonyOS 平台。

</Note>





## 2 导入 SDK

1. [下载 ZEGO Express Unity3D SDK](!DownloadSDK/DownloadSDK)，并解压 ZegoExpressUnity3D.zip 文件。
2. 将解压后的 “Assets/Plugins/OpenHarmony” 目录下的文件，拷贝到您自己创建的 Unity 工程中的同等目录下。

<Note title="说明">

    
     - 如果 Unity 工程中 “Assets/Plugins/” 目录下没有 OpenHarmony 文件夹，需要手动创建，保持同等目录。
     - Zego Express SDK 默认支持 arm64-v8a、armeabi-v7a、x86_64 三种 ABI。在手机场景以及 Unity 下，默认使用 arm64-v8a，因此您可以删除 armabi-v7a、x86_64 两种 ABI 文件。
    
</Note>


  
2. 将解压后的 “Assets/Scripts/” 下的所有文件，拷贝到您自己创建的 Unity 工程中的同等目录下。

<Note title="说明">


   如果此前 Unity 工程已经集成过 ZEGO Express 的其他平台 SDK，那么此时 Unity 工程下对应的目录应该已有这份文件，则不需要执行此操作，但建议更新为最新的文件。
   
</Note>



    


## 修改代码配置

1. 在 Unity 工程入口，引入 OpenHarmony 的命名空间。
   ```
    #if UNITY_OPENHARMONY
    using UnityEngine.OpenHarmony;
    #endif
   ```
2. 在 Unity Editor 中，选择“文件 > 生成设置”，勾选“导出项目”导出 OpenHarmony 的工程。

3. 使用 DevEco Studio 打开导出工程，选择“File > Project Structure > Signing Configs"，添加签名。

<Note title="说明">


   由于当前 Unity 暂不支持模拟器，因此需要使用真机进行调试，真机调试需要额外勾选“Automatically generate signature”。
    
</Note>


4. 在导出工程中，打开 “entry/src/main/ets/ability” 目录下的 TuanjiePlayerAbility.ets 文件，并增加以下初始化代码。
    ```
    import { ZegoOpenHarmony } from '../zegoets/utils/ZegoOpenHarmony'

    onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
  
    //...
    ZegoOpenHarmony.initEnv(this.context.getApplicationContext());
    }
    ```
5. 在导出工程中，找到 module.json5 文件，确保包含以下权限声明。
    ```json
    {
      "name": "ohos.permission.INTERNET",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "always"
      },
      "reason": "$string:default_reason"
    },
    {
      "name": "ohos.permission.ACCELEROMETER",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "always"
      },
      "reason": "$string:default_reason"
    },
    {
      "name": "ohos.permission.MICROPHONE",  // 麦克风权限
      "reason": "$string:default_reason",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "inuse"
      }
    },
    {
      "name": "ohos.permission.CAMERA",  // 摄像头权限
      "reason": "$string:default_reason",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "inuse"
      }
    },
    {
      "name": "ohos.permission.ACCESS_BLUETOOTH",  // 蓝牙权限
      "reason": "$string:default_reason",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
    ],
    "when": "always"
      }
    },
    {
      "name": "ohos.permission.GET_NETWORK_INFO",  // 网络状态权限
      "reason": "$string:default_reason",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "always"
      }
    },
    {
      "name": "ohos.permission.KEEP_BACKGROUND_RUNNING",
      "usedScene": {
        "abilities": [
          "TuanjiePlayerAbility"
        ],
        "when": "always"
      }
    }
    ```
6. 在 UNITY_2018_3_OR_NEWER 或以上版本中，Unity 不会主动获取摄像头和麦克风权限，需要开发者调用获取权限。
    ```json
    #if UNITY_OPENHARMONY
    using UnityEngine.OpenHarmony;
    #endif
    
    private ArrayList permissionList = new ArrayList();
    
    #if (UNITY_2018_3_OR_NEWER)
            permissionList.Add(Permission.Microphone);
            permissionList.Add(Permission.Camera);
            
            foreach (string permission in permissionList)
            {
                if (Permission.HasUserAuthorizedPermission(permission) == false)
                {
                    Permission.RequestUserPermission(permission);
                }
            }
    #endif
    ```

完成以上操作，即接入 HarmonyOS 平台并开发相关应用。

## 常见问题

#### 在 HarmonyOS 平台可以使用 WebCamTexture 吗？
 暂不支持

#### HarmonyOS 平台如何使用媒体播放器模块？

HarmonyOS 平台如需正常使用媒体播放器模块需增加以下配置
```
ZegoEngineConfig engineConfig = new ZegoEngineConfig();
engineConfig.advancedConfig  = new Dictionary<string, string>();
engineConfig.advancedConfig.Add("mediaplay_cache_type", "2");
ZegoExpressEngine.SetEngineConfig(engineConfig);
```

#### 真机调试时，出现“code:9568322 error: signature verification failed due to not trusted app source”报错，该如何处理？

签名问题，每次使用新的测试机器，都需要 [重新确认签名配置](https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs-V5/faqs-app-debugging-9-V5)。

#### 真机调试时，出现“TypeError：Cannot read property Zego_TsApi_InitNapiFunc of undefined”报错，该如何处理？

请确保 [导入 SDK 步骤](https://doc-zh.zego.im/article/21309#2) 执行正确。并确保导出的工程中，“entry/libs/” 目录下，包含 “libZegoExpressEngine.so” 文件；“entry/src/main/ets/” 目录下，包含 “zegoets” 以及相关文件。
