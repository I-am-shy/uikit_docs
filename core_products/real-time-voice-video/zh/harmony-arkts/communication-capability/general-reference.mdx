# 使用 Token 鉴权（不发布，不主推）

---

## 1 功能介绍

@@@Introduction_to_Token_Authentication_Native@@@

## 2 前提条件

@@@Rerequisites_for_Using_Token_Native@@@


## 3 实现流程

@@@Token_implementation_process@@@


## 4 使用步骤

@@@Token_usage_steps@@@


### 4.2 生成 Token


#### 4.2.1 服务端生成 Token（推荐）

@@@Server_generates_Token_1@@@

@@@Server_generates_Token_2@@@

#### 4.2.2 客户端生成 Token（不推荐）

@@@Client_generates_Token@@@


### 4.3 使用 Token 

用户携带获取到的 Token 和 user、roomID 信息，通过 [loginRoom](@loginRoom) 接口登录对应的房间。

<div class="mk-warning">

调用 [loginRoom](@loginRoom) 接口登录房间时使用的 roomID、userID，必须和 “4.2 生成 Token” 时使用的 roomID、userID 保持一致。 
</div>

```java
String roomID = "xxx" // 要登录的房间ID
ZegoUser user = new ZegoUser("xxxx");
ZegoRoomConfig config = new ZegoRoomConfig();
config.token = "xxxxxxxxxx"; // 请求开发者服务端获取
engine.loginRoom(roomID, user, config);
```

如果开发者需要在登录房间后修改权限位，也可以调用 [renewToken](@renewToken) 接口更新 Token，更新后会影响下一次登录某些房间和推某些流的权限，之前已经成功的房间登录和推流不受影响。


```java
String token = getToken(); // 重新请求开发者服务端获取 Token;
engine.renewToken(roomID, token);
```


### 4.4 Token 过期处理机制

@@@Token_overdue@@@

在 Token 过期前 30 秒，SDK 会通过 [onRoomTokenWillExpire](@onRoomTokenWillExpire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [renewToken](@renewToken) 接口更新 Token。若未处理：

 - 可以联系 ZEGO 技术支持额外配置权限位过期管理机制，此时如果未更新 Token，则当权限位过期时：
    - 已登录的用户会被踢出房间，且无法再登录房间。
    - 当前已成功的推流会被停止，也无法进行下一次推流。
- 若未联系 ZEGO 技术支持额外配置权限位过期管理机制，此时如果未更新 Token：
    - 已登录的用户不会被踢出房间。
    - 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。


<div class="mk-hint">

若开启了房间 ID 权限位，用户登录房间时必须主动传入新的 Token。
</div>


```java
@Override
public void onRoomTokenWillExpire(String roomID, int remainTimeInSecond){
    String token = getToken(); // 重新请求开发者服务端获取 Token;
    engine.renewToken(roomID, token);
}
```


## 5 API 参考

| 方法 | 描述 |
|-------|--------|
| [loginRoom](@loginRoom) | 登录房间 |
| [renewToken](@renewToken) | 更新 Token |
| [onRoomTokenWillExpire](@onRoomTokenWillExpire) | Token 过期回调 |


## 相关文档

[如何防止音视频互动中的幽灵麦或炸房的现象？](https://doc-zh.zego.im/faq/bombing)
