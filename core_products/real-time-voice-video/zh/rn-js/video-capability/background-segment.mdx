---
articleID: 17973
---
# 主体分割

- - -

## 功能简介


@@@Express_background_segment_info_1@@@

**请注意，ReactNative SDK 在以上平台中使用时，硬件兼容性同上。**

## 前提条件

在使用主体分割功能前，请确保：

- 已联系 ZEGO 技术支持进行特殊编包。

@@@Express-Video_Prerequisites@@@

## 实现流程

<div class = "mk-warning">

- 开启主体分割功能会额外消耗系统资源，为了保证用户体验，目前仅支持对一路通道推流画面开启主体分割。
- 如果有经过自定义前处理第三方滤镜，需要确保第三方滤镜支持 Alpha 通道透传功能。
</div>

<img src="/Pics/subject_segmentation/subject_segmentation_rn.png" width="80%">

请注意，开发者可根据自己的业务场景需要，选择是否实现上图中的 **（可选）** 步骤。如需实现，请参考下文中的具体说明。

### 1 初始化和登录房间

初始化和登录房间的具体流程，请参考实现视频通话文档中的 “[创建引擎](!Integration/Solution_Implementation#CreateEngine)”及“[登录房间](!Integration/Solution_Implementation#loginRoom)”。


### 2 监听主体分割状态回调

调用 [videoObjectSegmentationStateChanged](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#videoobjectsegmentationstatechanged) 接口，监听主体分割状态回调。

<div class = 'mk-warning'>

主体分割的状态回调依赖于开启预览或者推流，即如需监听 [videoObjectSegmentationStateChanged](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#videoobjectsegmentationstatechanged) 回调，需要调用预览 [startPreview](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startpreview) 或推流 [startPublishingStream](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startpublishingstream)。
</div>

```javascript
ZegoExpressEngine.instance().on('videoObjectSegmentationStateChanged', (state, channel, errorCdoe) => {
    console.log("JS videoObjectSegmentationStateChanged: " + state + " channel: " + channel + " errorCode: " + errorCdoe);
})
```


### 3 使用主体分割实现不同的业务功能

<div class="mk-warning">

开发者如需更新主体分割类型、背景处理类型，需要修改 [ZegoObjectSegmentationConfig](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressdefines_.zegoobjectsegmentationconfig.html) 的配置，并再次调用 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口开启主体分割，即可更新主体分割效果；更新结果将通过 [videoObjectSegmentationStateChanged](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#videoobjectsegmentationstatechanged) 回调通知给开发者。 
</div>

#### 背景虚化

<details class="zg-primary">
    <summary>使用主体分割实现背景虚化</summary>

调用 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口，开启主体分割，并设置背景处理类型为“虚化”。

```javascript
let config = new ZegoObjectSegmentationConfig();
config.objectSegmentationType = ZegoObjectSegmentationType.AnyBackground;//根据实际情况选择需要开启的主体分割类型
config.backgroundConfig.processType = ZegoBackgroundProcessType.Blur;//设置背景处理方式为虚化
config.backgroundConfig.blurLevel = ZegoBackgroundBlurLevel.Medium;//设置背景虚化级别为中
ZegoExpressEngine.instance().enableVideoObjectSegmentation(enable, config, ZegoPublishChannel.Main);//开启主体分割
```
</details>

#### 虚拟背景

<details class="zg-primary">
    <summary>使用主体分割实现虚拟背景</summary>

<div class="mk-warning">

- 开发者在使用本功能时，请注意自定义图片的宽高比，否则图片超出视图的部分会被裁减。
- 当前支持 “PNG” 与 “JPEG” 两种图片格式，即 “.png”、“.jpg”、“.jpeg” 三种后缀的图片文件。
</div>

调用 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口，开启主体分割，并设置背景处理类型为“图片”。

```javascript
let config = new ZegoObjectSegmentationConfig();
config.objectSegmentationType = ZegoObjectSegmentationType.AnyBackground;//根据实际情况选择需要开启的主体分割类型
config.backgroundConfig.processType = ZegoBackgroundProcessType.Image;//设置背景处理方式为图片
config.backgroundConfig.imageURL = "<image_path>";//设置背景图片路径
ZegoExpressEngine.instance().enableVideoObjectSegmentation(enable, config, ZegoPublishChannel.Main);//开启主体分割
```
</details>

#### 透明背景

<a name="enableAlphaChannelVideoEncoder"></a>

<details class="zg-primary">
    <summary>使用主体分割实现透明背景</summary>

<div class="mk-warning">

如果开发者需要实现类似“演讲模式”的业务功能，需要在业务侧将“主体画面”与“要混合的视频源内容”混为一条视频流。

</div>

调用 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口，开启主体分割，并设置背景处理类型为“透明”。

```javascript
let config = new ZegoObjectSegmentationConfig();
config.objectSegmentationType = ZegoObjectSegmentationType.AnyBackground;//根据实际情况选择需要开启的主体分割类型
config.backgroundConfig.processType = ZegoBackgroundProcessType.Transparent;//设置背景处理方式为透明
ZegoExpressEngine.instance().enableVideoObjectSegmentation(enable, config, ZegoPublishChannel.Main);//开启主体分割
```
</details>

### 4 （可选）使用 Alpha 通道传输分割出的主体

<details class="zg-primary">
    <summary>使用 Alpha 通道传输分割出的主体</summary>

如果推流端需要把分割后的主体画面通过 Alpha 通道传输到拉流端，在拉流端做主体渲染，需要先调用 [enableAlphaChannelVideoEncoder](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablealphachannelvideoencoder) 接口，设置编码器支持透明通道，然后调用 [startPublishingStream](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startpublishingstream) 接口推流，使其顺利传输至拉流端。

<div class = 'mk-warning'>

目前仅支持透明通道数据排列在 RGB 或 YUV 数据下方。
</div>

- 开启 Alpha 通道数据传输：

    ```javascript
    let layoutType = ZegoAlphaLayoutType.Bottom; // 透明通道数据排列在 RGB 或 YUV 数据下方
    ZegoExpressEngine.instance().enableAlphaChannelVideoEncoder(true, layoutType, ZegoPublishChannel.Main); // 开启编码器支持透明通道
    ```

- 关闭 Alpha 通道数据传输：

    ```javascript
    let layoutType = ZegoAlphaLayoutType.Bottom; // 透明通道数据排列在 RGB 或 YUV 数据下方
    ZegoExpressEngine.instance().enableAlphaChannelVideoEncoder(false, layoutType, ZegoPublishChannel.Main); // 关闭编码器支持透明通道
    ```
</details>

### 5 开始预览和推流

通过 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口开启主体分割功能后，可以进行预览。

<div class = 'mk-hint'>

开发者也可以先开启预览，再开启主体分割。本文以先开启主体分割，再进行预览为例进行介绍。
</div>

```javascript
let view = {"reactTag": findNodeHandle(this.refs.zego_preview_view), "viewMode": 0, "backgroundColor": 0};
view.alphaBlend = true;//开启内部渲染 Alpha 混合，开启后支持分割后的主体与背景图层进行 Alpha 混合
ZegoExpressEngine.instance().startPreview(view);
ZegoExpressEngine.instance().startPublishingStream(streamID);
```

### 6（可选）在拉流端设置 Alpha 通道渲染并拉流

<details class="zg-primary">
    <summary>在拉流端设置 Alpha 通道渲染，并开启拉流</summary>

<div class="mk-warning">

推流端开启了 Alpha 通道传输的情况下，才需要在拉流端开启 Alpha 通道渲染。
</div>

```javascript
let view = {"reactTag": findNodeHandle(this.refs.zego_play_view), "viewMode": 0, "backgroundColor": 0};
view.alphaBlend = true;//开启内部渲染 Alpha 混合，开启后支持分割后的主体与背景图层进行 Alpha 混合
ZegoExpressEngine.instance().startPlayingStream(streamID, canvas);
```
</details>

### 7 关闭主体分割

调用 [enableVideoObjectSegmentation](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#enablevideoobjectsegmentation) 接口，关闭主体分割。

```javascript
let objectType = ZegoObjectSegmentationType.AnyBackground;//根据实际情况选择需要关闭的主体分割类型
ZegoExpressEngine.instance().enableVideoObjectSegmentation(false, objectType, ZegoPublishChannel.Main);//关闭主体分割
```

### 8 销毁引擎

调用 [destroyEngine](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#destroyengine) 接口，销毁引擎。

```javascript
ZegoExpressEngine.destroyEngine();
```
