---
articleID: 1078
---
# 通话质量监测

- - -

## 功能简介

@@@Push_Pull_Stream_Information_Detection_Function_Introduction@@@

## 示例源码下载

请参考 [下载示例源码](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/ZegoExpressExample/Examples/AdvancedStreaming/StreamMonitoring” 目录下的文件。

## 前提条件

在进行通话质量监测之前，请确保：

- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 已在项目中集成 ZEGO Express SDK，并实现了基本的音视频推拉流功能，详情请参考 [快速开始 - 集成](!Integration/SDK_Integration) 和 [快速开始 - 实现流程](!Integration/Solution_Implementation)。


## 实现方法

### 用户网络质量

您可以通过监听 [onNetworkQuality](@onNetworkQuality) 回调，收到用户（包括您自己）的上下行网络质量。此回调每隔两秒会收到一次，网络质量等级请参考 [ZegoStreamQualityLevel](@-ZegoStreamQualityLevel)。

不同版本的 [onNetworkQuality](@onNetworkQuality) 回调逻辑有所不同：

<table>
  <colgroup>
    <col width="20%"/>
    <col width="75%"/>
  </colgroup>
<tbody><tr>
<th>版本号</th>
<th>回调逻辑</th>
</tr>
<tr>
<td>2.22.0 及以上</td>
<td>基于 2.14.0 ～ 2.21.1 的 onNetworkQuality 接口的回调逻辑上，还可预估远端推流用户的网络情况，如果远端推流用户心跳丢失 1 次，回调其网络质量为 unknown；如果远端推流用户心跳丢失达到 3 次，回调其网络质量为 die。</td>
</tr>
<tr>
<td>2.14.0 ～ 2.21.1</td>
<td>
* 您只要推流或者拉流，就能收到自己的网络质量回调。&nbsp;&nbsp;
* 当您拉取了其他用户推送的音视频流并且该用户在您的房间内时，您才会收到该用户的网络质量回调。&nbsp;
* 当 “userID” 为 ""（空字符串）时，代表本次是您自己的网络质量，当 “userID” 不为 ""（空字符串）时，代表是房间内其他用户的报告。
</td>
</tr>
<tr>
<td>2.10.0 ～ 2.13.1</td>
<td>
* 您必须既推流又拉流，才会收到自身的网络质量回调。&nbsp;
* 当您拉取一条流时，推送该条流的用户必须在同一房间内，且他也进行了拉流，您才会收到该用户的网络质量回调。
* 当 “userID” 为 ""（空字符串）时，代表本次是您自己的网络质量，当 “userID” 不为 ""（空字符串）时，代表是房间内其他用户的报告。
</td>
</tr>
</tbody></table>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onNetworkQuality(const std::string& userID, ZegoStreamQualityLevel upstreamQuality, ZegoStreamQualityLevel downstreamQuality){
        // 开发者可以在此回调中监控用户的上下行网络质量以上报到业务服务器做监控，或者给用户友好的提示
    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

### 监测推流质量

开发者可通过注册 [onPublisherQualityUpdate](@onPublisherQualityUpdate) 接收推流质量回调。推流成功后每隔三秒会收到此回调。开发者可根据回调返回的质量参数实时监控推送的音视频流的健康情况，以便在设备 UI 界面上实时展示上行网络状况。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherQualityUpdate(String streamID, ZegoPublishStreamQuality quality){
        // 开发者可以在此回调中监控具体的质量以上报到业务服务器做监控，或者监控质量对象的某个字段以给用户友好的提示
        // 若开发者不知道监控质量哪个字段可以关注 level 字段，这个字段是质量对象的综合值
    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

### 推流质量详解
    

@@@Push_Pull_Stream_Information_Detection_Detailed_Detailed_Quality_Explanation@@@

level 字段的说明如下：

|字段名|说明|
|-|-|
|ZEGO_STREAM_QUALITY_LEVEL_EXCELLENT|流质量极好|
|ZEGO_STREAM_QUALITY_LEVEL_GOOD|流质量好|
|ZEGO_STREAM_QUALITY_LEVEL_MEDIUM|流质量正常|
|ZEGO_STREAM_QUALITY_LEVEL_BAD|流质量差|
|ZEGO_STREAM_QUALITY_LEVEL_DIE|流质量异常|

### 监测拉流质量

开发者可通过注册 [onPlayerQualityUpdate](@onPlayerQualityUpdate) 接收拉流质量回调。拉流成功后每隔三秒会收到此回调。开发者可根据回调返回的质量参数实时监控拉取的音视频流的健康情况，以便在设备 UI 界面上实时展示下行网络状况。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerQualityUpdate(String streamID, ZegoPlayStreamQuality quality){
        // 开发者可以在此回调中监控具体的质量以上报到业务服务器做监控，或者监控质量对象的某个字段以给用户友好的提示
        // 若开发者不知道监控质量哪个字段可以关注 level 字段，这个字段是质量对象的综合值
    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

### 拉流质量详解

@@@Push_Pull_Flow_Information_Detection_Detailed_Explanation_of_Pull_Flow_Quality@@@

### 监控推流/拉流状态

#### 推流状态回调

在推流成功后，开发者可通过 [onPublisherStateUpdate](@onPublisherStateUpdate) 获取推流状态变更的通知。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherStateUpdate(String streamID, ZegoPublisherState state, int errorCode, JSONObject extendedData){
    // 当 state 为 PUBLISHER_STATE_NO_PUBLISH 时，且 errcode 非 0，表示推流失败，同时不会再进行重试推流了，此时可在界面作出推流失败提示；    
    // 当 state 为 PUBLISHER_STATE_PUBLISH_REQUESTING 时，且 errcode 非 0，表示在重试推流，此时如果超出重试时间未成功推流会抛出推流失败通知。
    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

开发者可根据回调内的 “state” 参数是否在 “正在请求推流状态” 来大体判断用户的推流网络情况。“state” 参数的取值与用户推流状态对应如下:

<table>
  <colgroup>
    <col width="30%">
    <col width="70%">
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZEGO_PUBLISHER_STATE_NO_PUBLISH</td>
<td>未推流状态，在推流前处于该状态。如果推流过程出现稳态的异常，例如 AppID、AppSign、或 Token 等不正确，或者如果其他用户已经在推送流，推送相同流 ID 的流会失败，都会进入未推流状态。</td>
</tr>
<tr>
<td>ZEGO_PUBLISHER_STATE_PUBLISH_REQUESTING</td>
<td>正在请求推流状态，推流操作执行成功后会进入正在请求推流状态，通常通过该状态进行 UI 界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在请求推流状态。</td>
</tr>
<tr>
<td>ZEGO_PUBLISHER_STATE_PUBLISHING</td>
<td>正在推流状态，进入该状态表明推流已经成功，用户可以正常通信。</td>
</tr>
</tbody></table>

参数 “extendedData” 为状态更新附带的扩展信息。若使用 ZEGO 的 CDN 内容分发网络，在推流成功后，该参数的内容的键为 “flv_url_list”、“rtmp_url_list”、“hls_url_list”，分别对应 flv、rtmp、hls 协议的拉流 URL。

#### 拉流状态变更回调

在拉流成功后，开发者可通过 [onPlayerStateUpdate](@onPlayerStateUpdate) 获取拉流状态变更的通知。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerStateUpdate(String streamID, ZegoPlayerState state, int errorCode, JSONObject extendedData){
        // 当 state 为 PLAYER_STATE_NO_PLAY 时，且 errcode 非 0，表示拉流失败，同时不会再进行重试拉流了，此时可在界面作出拉流失败提示；
        // 当 state 为 PLAYER_STATE_PLAY_REQUESTING 时，且 errcode 非 0，表示重试拉流，此时如果超出重试时间未成功拉到流会抛出拉流失败通知。
    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

开发者可根据 “state” 参数是否在 “正在请求拉流状态” 来大体判断用户的拉流网络情况。“state” 参数的取值与用户拉流状态对应如下:

<table>
  <colgroup>
    <col width="30%">
    <col width="70%">
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZEGO_PLAYER_STATE_NO_PLAY</td>
<td>未拉流状态，在拉流前处于该状态。如果拉流过程出现稳态的异常，例如 AppID、AppSign、或 Token 等不正确，都会进入未拉流状态。</td>
</tr>
<tr>
<td>ZEGO_PLAYER_STATE_PLAY_REQUESTING</td>
<td>正在请求拉流状态，拉流操作执行成功后会进入正在请求拉流状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在请求拉流状态。</td>
</tr>
<tr>
<td>ZEGO_PLAYER_STATE_PLAYING</td>
<td>正在拉流状态，进入该状态表明拉流已经成功，用户可以正常通信。</td>
</tr>
</tbody></table>

### 音视频首帧回调

#### 推流端音频采集首帧回调

开发者可通过注册 [onPublisherCapturedAudioFirstFrame](@onPublisherCapturedAudioFirstFrame) 接收音频首帧回调。调用推流接口成功后，SDK 采集到第一帧音频数据时会收到此回调。

<div class='mk-hint'>
    
在未推流的情况下，调用推流接口后，即 SDK 内部的音视频模块的引擎启动时，会采集本机设备的音频数据，收到该回调。开发者可根据该回调判断 SDK 是否真的采集到音频数据，若未收到该回调，说明音频采集设备被占用或异常。  
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherCapturedAudioFirstFrame(){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```   

#### 推流端视频采集首帧回调

开发者可通过注册 [onPublisherCapturedVideoFirstFrame](@onPublisherCapturedVideoFirstFrame) 接收视频首帧回调。调用推流接口成功后，SDK 采集到第一帧视频数据时会收到此回调。

<div class='mk-hint'>

在未推流或未预览的情况下，调用推流或预览接口后，即 SDK 内部的音视频模块的引擎启动时，会采集本机设备的视频数据，收到该回调。开发者可根据该回调判断 SDK 是否真的采集到视频数据，若未收到该回调，说明视频采集设备被占用或异常。
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherCapturedVideoFirstFrame(ZegoPublishChannel channel){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

#### 拉流端音频接收首帧回调

开发者可通过注册 [onPlayerRecvAudioFirstFrame](@onPlayerRecvAudioFirstFrame) 监听拉流端音频接收首帧回调。调用拉流接口成功后，SDK 拉流拉到第一帧音频数据时会收到此回调。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerRecvAudioFirstFrame(String streamID){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

#### 拉流端视频接收首帧回调

开发者可通过注册 [onPlayerRecvVideoFirstFrame](@onPlayerRecvVideoFirstFrame) 监听拉流端接收视频首帧回调。调用拉流接口成功后，SDK 拉流拉到第一帧视频数据时会收到此回调。

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerRecvVideoFirstFrame(String streamID)(ZegoPublishChannel channel){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

#### 拉流端渲染完视频首帧回调

开发者可通过注册 [onPlayerRenderVideoFirstFrame](@onPlayerRenderVideoFirstFrame) 监听拉流端渲染完视频首帧回调。调用拉流接口成功后，SDK 拉流并渲染完第一帧视频数据后会收到此回调。

<div class='mk-hint'>

开发者可用该回调来统计首帧耗时或更新播放流的 UI 组件。
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerRenderVideoFirstFrame{

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

### 监控视频分辨率变化

#### 采集视频分辨率变更回调

开发者可通过注册 [onPublisherVideoSizeChanged](@onPublisherVideoSizeChanged) 监听采集视频大小变更回调。推流成功后，在推流中途如果有改变视频采集分辨率发生变化将会收到此回调。

<div class='mk-hint'>

当在未推流或未预览的情况下，首次推流或首次预览，即 SDK 内部的音视频模块的引擎启动时，会去采集本机设备的视频数据，此时采集分辨率会改变。

开发者可以根据此回调来去除本地预览的 UI 的遮盖等类似操作。也可以根据该回调的分辨率来动态调整预览视图的比例等。
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherVideoSizeChanged(int width, int height, ZegoPublishChannel channel){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

#### 拉流分辨率变更通知

开发者可通过注册 [onPlayerVideoSizeChanged](@onPlayerVideoSizeChanged) 获取拉流分辨率变更通知。拉流成功后，在拉流中途如果有视频分辨率发生变化将会收到此回调，用户可根据流的最终分辨率调整显示。

<div class='mk-hint'>

- 若拉的是流只有音频数据，会收不到该回调。
- 若推流端由于网络问题触发 SDK 内部的流量控制时，可能会动态减小推流端的编码分辨率，此时也会收到此回调。所拉的音视频流真正渲染到所设置 UI 播放界面时会触发此回调。开发者可利用该回调通知来更新或切换真正播放流的 UI 组件。
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPlayerVideoSizeChanged(String streamID, int width, int height){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```
 

### 监控 CDN 转推状态

#### 添加/删除转推 CDN 地址状态回调

开发者可通过注册 [onPublisherRelayCDNStateUpdate](@onPublisherRelayCDNStateUpdate) 获取添加/删除转推 CDN 地址状态回调。在 ZEGO RTC 服务器将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。

<div class='mk-hint'>

开发者可根据该回调判断转推 CDN 的音视频流是否正常：
- 若不正常根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
- 若对异常的原因不了解，可联系 ZEGO 技术人员分析具体异常的原因。
</div>

```C++
class MyEventHandler : public IZegoEventHandler{
public:
    void onPublisherRelayCDNStateUpdate(String streamID, ArrayList<ZegoStreamRelayCDNInfo> infoList){

    }
}
auto eventhandler = std::make_shared<MyEventHandler>();
engine->setEventHandler(eventhandler);
```

#### 转推 CDN 信息详解

转推 CDN 信息 [ZegoStreamRelayCDNInfo](@-ZegoStreamRelayCDNInfo) 包含了 CDN 推流的 URL，转推状态，转推状态变更的原因状态发生的时间。[ZegoStreamRelayCDNInfo](@-ZegoStreamRelayCDNInfo)内所有参数如下：

<table>
  <colgroup>
    <col width="50%">
    <col width="50%">
  </colgroup>
<tbody><tr>
<th>参数名</th>
<th>说明</th>
</tr>
<tr>
<td>url</td>
<td>CDN 推流的 URL</td>
</tr>
<tr>
<td>state</td>
<td>转推状态</td>
</tr>
<tr>
<td>updateReason</td>
<td>转推状态变更的原因</td>
</tr>
<tr>
<td>stateTime</td>
<td>状态发生的时间</td>
</tr>
</tbody></table>

其中，state取值如下：

|枚举值|说明|
|-|-|
|ZEGO_STREAM_RELAY_CDN_STATE_NO_RELAY|未转推状态，在转推前处于该状态。如果转推过程出现持续的异常，例如转推地址不正确，都会进入未转推状态。|
|ZEGO_STREAM_RELAY_CDN_STATE_RELAY_REQUESTING|正在请求转推状态，转推操作执行成功后会进入正在请求转推状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在转推状态。|
|ZEGO_STREAM_RELAY_CDN_STATE_RELAYING|正在转推状态，进入该状态表明转推已成功。|

updateReason 取值如下：

|枚举值|说明|
|-|-|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_NONE|无|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_SERVER_ERROR|服务器错误|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_HANDSHAKE_FAILED|握手失败|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_ACCESS_POINT_ERROR|接入点错误|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CREATE_STREAM_FAILED|创建流失败|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_BAD_NAME|BAD NAME|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CDN_SERVER_DISCONNECTED|CDN 服务器主动断开|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_DISCONNECTED|主动断开|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_CLOSED|混流的全部输入流会话关闭|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_NO_DATA|混流的全部输入流没有数据|
|ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_SERVER_INTERNAL_ERROR|混流服务器内部错误|


## 相关文档

- [怎么处理视频卡顿问题？](https://doc-zh.zego.im/faq/video_freeze)
- [怎么处理音频卡顿问题？](https://doc-zh.zego.im/faq/audio_freeze)
- [如何理解和使用 SEI（媒体补充增强信息）？](https://doc-zh.zego.im/faq/sei)
