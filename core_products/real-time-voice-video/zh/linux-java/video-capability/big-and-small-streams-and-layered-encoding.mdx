# 视频大小流和分层编码

- - -

@@@Big_and_small_streams_and_Layered_Encoding@@@


## 示例源码下载

请参考 [下载示例源码](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/ZegoExpressExample/AdvancedVideoProcessing/src/main/java/im/zego/advancedvideoprocessing/encodinganddecoding” 目录下的文件。


## 前提条件

在实现两种视频编码功能之前，请确保：

- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 已在项目中集成 ZEGO Express SDK，并实现了基本的音视频推拉流功能，详情请参考 [快速开始 - 集成](!Integration/SDK_Integration) 和 [快速开始 - 实现流程](!Integration/Solution_Implementation)。



## 实现步骤

### 分层视频编码

#### 1 开启分层视频编码

在调用 [startPublishingStream](@startPublishingStream) 之前，调用 [setVideoConfig](@setVideoConfig-ZegoExpressEngine) 接口，设置 [ZegoVideoConfig](@-ZegoVideoConfig) 类中的参数 `codecID` 为 `ZegoVideoCodecIDSVC`，开启分层视频编码；并调用 [startPublishingStream](@startPublishingStream) 接口开始推流。

```java
ZegoVideoConfig videoConfig = new ZegoVideoConfig ();
videoConfig.codecID = ZegoVideoCodecID.ZegoVideoCodecIDSVC

engine.setVideoConfig(videoConfig);
engine.startPublishingStream("0012");
```

<div class="mk-hint">

“codecID” 设置为 “ZegoVideoCodecIDDefault”、“ZegoVideoCodecIDVP8” 或 “ZegoVideoCodecIDH265” 可关闭该功能。
</div>

#### 2 指定拉取的分层视频

在推流端开启了分层视频编码后，拉流端用户在拉流前后均可调用 [setPlayStreamVideoType](@setPlayStreamVideoType) 接口，传入具体的拉流参数以拉取特定的视频分层。如果没有指定，拉流端默认会根据网络情况拉取合适的视频分层，例如弱网只拉取基本层。目前支持的视频分层如下：

|枚举值|说明|
|-|-|
|ZegoVideoStreamTypeDefault|根据网络状态自动选择流类型，默认值|
|ZegoVideoStreamTypeSmall| 基本层，小分辨率类型|
|ZegoVideoStreamTypeBig| 扩展层，大分辨率类型|

```java
engine.setPlayStreamVideoType(ZegoVideoStreamTypeBig, streamID)
engine.startPlayingStream:self.streamID playCanvas;
```

### 大小流视频编码

`大小流视频编码` 与 `分层视频编码` 的实现步骤基本一致，不同的是 `大小视频流编码` 功能支持在推流前，分别设置大流和小流的分辨率、帧率和码率等信息。

#### 1 开启大小流视频编码

在推流（[startPublishingStream](@startPublishingStream)）前，调用 [setVideoConfig](@setVideoConfig-ZegoExpressEngine) 接口设置 [ZegoVideoConfig](@-ZegoVideoConfig) 类中的参数 `codecID` 为 `ZegoVideoCodecIDH264DualStream`，即可开启大小流视频编码。

```java
ZegoVideoConfig videoConfig = new ZegoVideoConfig ();
videoConfig.codecID = ZegoVideoCodecID.H264_DUAL_STREAM

engine.setVideoConfig(videoConfig);
```

<div class="mk-hint">

“codecID” 设置为 “ZegoVideoCodecIDDefault”、“ZegoVideoCodecIDVP8” 或 “ZegoVideoCodecIDH265” 可关闭该功能。
</div>

#### 2 设置基本层、扩展层的参数

通过 [setPublishDualStreamConfig](@setPublishDualStreamConfig) 接口，分别设置大流和小流的分辨率、帧率和码率等信息，并调用 [startPublishingStream](@startPublishingStream) 接口开始推流。

@@@Big_and_small_streams_and_Layered_Encoding_Warning@@@

```java
ArrayList<ZegoPublishDualStreamConfig> config_list = new ArrayList<ZegoPublishDualStreamConfig>();

ZegoPublishDualStreamConfig big = new ZegoPublishDualStreamConfig();
big.streamType = ZegoVideoStreamType.BIG;
big.encodeWidth = 960;
big.encodeHeight = 540;
big.fps = 15;
big.bitrate = 1200;
config_list.add(big);

ZegoPublishDualStreamConfig small = new ZegoPublishDualStreamConfig();
small.streamType = ZegoVideoStreamType.SMALL;
small.encodeWidth = 320;
small.encodeHeight = 180;
small.fps = 15;
small.bitrate = 300;
config_list.add(small);
engine.setPublishDualStreamConfig(config_list,ZegoPublishChannel.MAIN);

engine.startPublishingStream("dual_streamid");
```

#### 3 指定拉取的视频码流

在推流端开启了分层视频编码后，拉流端用户在拉流前后均可调用 [setPlayStreamVideoType](@setPlayStreamVideoType) 接口，传入具体的拉流参数以拉取特定的视频分层。如果没有指定，拉流端默认会根据网络情况拉取合适的视频分层，例如弱网只拉取基本层。目前支持的视频分层如下：

|枚举值|说明|
|-|-|
|ZegoVideoStreamTypeDefault|根据网络状态自动选择流类型，默认值|
|ZegoVideoStreamTypeSmall| 基本层，小分辨率类型|
|ZegoVideoStreamTypeBig| 扩展层，大分辨率类型|

```java
engine.setPlayStreamVideoType(ZegoVideoStreamTypeBig,streamID);
engine.startPlayingStream(streamID,canvans);
```

## 常见问题

@@@Big_and_small_streams_and_Layered_Encoding_FAQ@@@
