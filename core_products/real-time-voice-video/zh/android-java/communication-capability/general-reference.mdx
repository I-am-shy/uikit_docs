# 使用 Token 鉴权

---

## 1 功能介绍

@@@Introduction_to_Token_Authentication_Native@@@

## 2 前提条件

@@@Rerequisites_for_Using_Token_Native@@@


## 3 流程概述

#### 场景 1：登录房间场景
	 
@@@Token_implementation_process@@@
	 
#### 场景 2：登录万人音视频的范围场景
	 
 <details class="zg-primary">
     <summary>生成并使用 Token 登录万人音视频的范围场景</summary>
 
使用 Token 鉴权时，需要开发者先生成 Token，您再携带 Token 登录场景，ZEGO 服务端对带着 Token 的用户进行校验。

以使用 Token 判断用户是否能登录场景为例介绍使用流程，如下图：

![token_rangescene_uml](/Pics/QuickStart/token_rangescene_uml.png)

1. 开发者客户端发起申请 Token 的请求。
2. 在开发者的服务端上生成 Token，并返回给开发者客户端。
3. 开发者客户端携带申请到的 Token 和 userID、sceneID 信息，登录对应的场景。
4. ZEGO SDK 会自动将 Token 发送到 ZEGO 服务端进行校验。
5. ZEGO 服务端会将校验结果返回给 ZEGO SDK。
6. ZEGO SDK 再将校验的结果直接返回给开发者客户端，没有权限的客户端将登录失败。
</details>


## 4 生成 Token 与使用

@@@Token_usage_steps_change@@@


### 4.2 在服务端生成 Token

@@@Server_generates_Token_change@@@

<div class="mk-warning">

范围场景模块暂不支持权限认证 Token。 
</div>

<a id="tab_item1"></a>
<div class="multipletabs-content">
    <!--tabs列表-->
    <div class="item-tabs">
        <div class="scroll-box">
          <span class="tab-item">
             生成基础鉴权 Token
          </span>
          <span class="tab-item">
             生成权限认证 Token
          </span>
        </div>
    </div>
<!--MarkDown内容要注意包裹在md-content标签内，且注意前面不能有空格，不然也会渲染异常-->
<div class="multipletabs-content-item ">
  <md-content>
@@@Server_generates_Token_change3@@@
  </md-content>
</div>
<!--嵌套其它html模板示例-->
<div class="multipletabs-content-item ">
@@@Server_generates_Token_change4@@@
</div>
</div>

@@@Server_generates_Token_change_warning@@@


### 4.3 使用 Token 

#### 场景 1：登录房间场景

用户携带获取到的 Token 和 user、roomID 信息，通过 [loginRoom\|_blank](@loginRoom) 接口登录对应的房间。

@@@RTC_Token_LoginRoom@@@

```java
String roomID = "xxx" // 要登录的房间ID
ZegoUser user = new ZegoUser("xxxx");
ZegoRoomConfig config = new ZegoRoomConfig();
config.token = "xxxxxxxxxx"; // 请求开发者服务端获取
engine.loginRoom(roomID, user, config);
```

如果开发者需要在登录房间后修改权限位，也可以调用 [renewToken\|_blank](@renewToken) 接口更新 Token，更新后会影响下一次登录某些房间和推某些流的权限，之前已经成功的房间登录和推流不受影响。


```java
String token = getToken(); // 重新请求开发者服务端获取 Token;
engine.renewToken(roomID, token);
```

#### 场景 2：登录万人音视频的范围场景

<details class="zg-primary">
    <summary>使用 Token 登录万人音视频的范围场景</summary>

用户携带获取到的 Token 和 user、sceneID 信息，登录对应的场景。

<div class="mk-warning">

调用 [loginScene\|_blank](@loginScene) 接口登录场景时使用的 userID，必须和 “4.2 在服务端生成 Token” 时使用的 userID 保持一致。 
</div>

```java
long sceneID = 123L; // 要登录的场景 ID
ZegoUser user = new ZegoUser("xxxx");
ZegoSceneParam config = new ZegoSceneParam();
param.sceneID = sceneID;
param.user = user;
param.token = @"xxxxxxxx"; // 请求开发者服务端获取

rangeScene.loginScene(param, new IZegoRangeSceneLoginSceneCallback() {
    @Override
    public void onLoginSceneCallback(int errorCode, ZegoSceneConfig config) {
    }
});
```
</details>

### 4.4 Token 过期处理机制

@@@Token_overdue@@@

#### 场景 1：登录房间场景

在 Token 过期前 30 秒，SDK 会通过 [onRoomTokenWillExpire\|_blank](@onRoomTokenWillExpire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [renewToken\|_blank](@renewToken) 接口更新 Token。

@@@Token expiration processing mechanism@@@


```java
@Override
public void onRoomTokenWillExpire(String roomID, int remainTimeInSecond){
    String token = getToken(); // 重新请求开发者服务端获取 Token;
    engine.renewToken(roomID, token);
}
```

#### 场景 2：范围场景模块

<details class="zg-primary">
    <summary>万人音视频的范围场景下，Token 过期时的处理方式</summary>

在 Token 过期前 30 秒，SDK 会通过 [onSceneTokenWillExpire\|_blank](@onSceneTokenWillExpire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [ZegoRangeScene.renewToken\|_blank](@renewToken-ZegoRangeScene) 接口更新 Token。若未处理，Token 过期的处理机制如下：

- 已登录的用户不会被踢出场景。
- 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。



```java
public void onSceneTokenWillExpire(ZegoRangeScene rangeScene, int remainTimeInSecond) {
    super.onSceneTokenWillExpire(rangeScene, remainTimeInSecond);
    String token = getToken(); // 重新请求开发者服务端获取 Token;
    // 请切换线程调用 renewToken
    rangeScene.renewToken(token);
}
```
</details>

## 5 其他

<details class="zg-primary">
    <summary>客户端生成 Token 与使用（不推荐）</summary>

@@@Client_generates_Token@@@

@@@Client_generates_Token_Step@@@
</details>

## 6 API 参考

| 方法 | 描述 |
|-------|--------|
| [loginRoom\|_blank](@loginRoom) | 登录房间 |
| [renewToken\|_blank](@renewToken) | 更新 Token |
| [onRoomTokenWillExpire\|_blank](@onRoomTokenWillExpire) | Token 过期回调 |


## 7 相关文档

[如何防止音视频互动中的幽灵麦或炸房的现象？\|_blank](https://doc-zh.zego.im/faq/bombing)
