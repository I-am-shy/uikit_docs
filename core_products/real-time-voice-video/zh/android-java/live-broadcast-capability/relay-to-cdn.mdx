---
articleID: 1188
---
# 使用 CDN 直播

---

## 功能简介

@@@Push_Pull_Streaming_via_CDN@@@

## 前提条件

在使用 CDN 直播之前，请确保：

@@@Express-Video_Prerequisites@@@

@@@Enable_CDN@@@

## 示例源码下载

请参考 [下载示例源码\|_blank](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/ZegoExpressExample/AdvancedStreaming/src/main/java/im/zego/advancedstreaming/streamByCdn” 目录下的文件。

## 转推 CDN

@@@Express_Started_to_Retweet@@@

```java
// 推流成功后，开始转推到 CDN

// 推流时使用的流 ID
String streamID = "STREAM_ID";
// 需要转推的 CDN 地址，请开发者按照实际URL填入，streamID 为推流的流名，可自定义
String URL = "rtmp://推流域名/接入点/streamID";
engine.addPublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCdnUrlCallback() {
    @Override
    public void onPublisherUpdateCdnUrlResult(int errorCode) {
    if(errorCode == 0) {
        // 转推成功
        } else {
            // 转推失败，可能由于网络原因转推请求发送失败
        }
    }
});
```

### 4 （可选）监听 CDN 转推状态通知

#### 4.1 添加/删除转推 CDN 地址状态回调

开发者可通过注册 [onPublisherRelayCDNStateUpdate\|_blank](@onPublisherRelayCDNStateUpdate) 获取添加/删除转推 CDN 地址状态回调。在 ZEGO RTC 服务器将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。

<div class='mk-hint'>

开发者可根据该回调判断转推 CDN 的音视频流是否正常：
- 若不正常，则根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
- 若对异常的原因不了解，可联系 ZEGO 技术支持分析具体异常的原因。

</div>

```java
engine.setEventHandler(new IZegoEventHandler() {
    @Override
    public void onPublisherRelayCDNStateUpdate(String streamID, ArrayList<ZegoStreamRelayCDNInfo> infoList) {
    super.onPublisherRelayCDNStateUpdate(streamID, infoList);
    }
}
```


#### 4.2 转推 CDN 信息详解

转推 CDN 信息 [ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo) 包含了 CDN 推流的 URL、转推状态、转推状态变更的原因、状态发生的时间。[ZegoStreamRelayCDNInfo\|_blank](@-ZegoStreamRelayCDNInfo) 内所有参数如下：

<table>
  <colgroup>
  </colgroup>
<tbody><tr>
<th>参数名</th>
<th>说明</th>
</tr>
<tr>
<td>url</td>
<td>CDN 推流的 URL。</td>
</tr>
<tr>
<td>state</td>
<td>转推状态。</td>
</tr>
<tr>
<td>updateReason</td>
<td>转推状态变更的原因。</td>
</tr>
<tr>
<td>stateTime</td>
<td>状态发生的时间。</td>
</tr>
</tbody></table>

其中，state 取值如下：

<table>
  <colgroup>
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_NO_RELAY</td>
<td>未转推状态，在转推前处于该状态。如果转推过程出现持续的异常，例如转推地址不正确，都会进入未转推状态。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_RELAY_REQUESTING</td>
<td>正在请求转推状态，转推操作执行成功后会进入正在请求转推状态，通常通过该状态进行应用界面的展示。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，也会回到正在转推状态。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_STATE_RELAYING</td>
<td>正在转推状态，进入该状态表明转推已成功。</td>
</tr>
</tbody></table>

updateReason 取值如下：

<table>
  <colgroup>
  </colgroup>
<tbody><tr>
<th>枚举值</th>
<th>说明</th>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_NONE</td>
<td>无。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_SERVER_ERROR</td>
<td>服务器错误。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_HANDSHAKE_FAILED</td>
<td>握手失败。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_ACCESS_POINT_ERROR</td>
<td>接入点错误。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CREATE_STREAM_FAILED</td>
<td>创建流失败。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_BAD_NAME</td>
<td>流 ID 不合法。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_CDN_SERVER_DISCONNECTED</td>
<td>CDN 服务器主动断开。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_DISCONNECTED</td>
<td>主动断开。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_CLOSED</td>
<td>混流的全部输入流会话关闭。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_ALL_INPUT_STREAM_NO_DATA</td>
<td>混流的全部输入流没有数据。</td>
</tr>
<tr>
<td>ZEGO_STREAM_RELAY_CDN_UPDATE_REASON_MIX_STREAM_SERVER_INTERNAL_ERROR</td>
<td>混流服务器内部错误。</td>
</tr>
</tbody></table>

### 5 停止转推

调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 接口即可删除动态转推至 CDN 的 URL。**调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 接口停止转推时，请确保当前流 streamID 是存在的。**

<div class = 'mk-warning'>

该接口并不会停止推往 ZEGO 实时音视频云的音视频流。
</div>

```java
// 推流时使用的流 ID
String streamID = "STREAM_ID";
// 需要停止转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名
String URL = "rtmp://推流域名/接入点/streamID";
engine.removePublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCdnUrlCallback() {
    @Override
    public void onPublisherUpdateCdnUrlResult(int errorCode) {
        if(errorCode == 0) {
        // 停止转推成功
        } else {
        // 停止转推失败，可能由于网络原因停止转推请求发送失败
        }
    }
});
```

## 直推 CDN 

@@@Express_Started_to_Push_Directly@@@


```java
ZegoCDNConfig config = new ZegoCDNConfig();
// URL 需要开发者根据实际情况填写，streamID 为推流的流名，可自定义
config.url = "rtmp://推流域名/接入点/streamID";
engine.enablePublishDirectToCDN(true, config);
engine.startPublishingStream("STREAM_ID");
```

### 2 停止直推 CDN

若需停止直推 CDN，调用 [stopPublishingStream\|_blank](@stopPublishingStream) 接口停止推流即可。

停止推流后，若下一次推流无需直推 CDN，则可以调用 [enablePublishDirectToCDN\|_blank](@enablePublishDirectToCDN) 接口并传值为 “false” 关闭直推 CDN 功能。在推流途中调用此接口不会影响此次推流。

```java
engine.stopPublishingStream();
ZegoCDNConfig config = new ZegoCDNConfig();
engine.enablePublishDirectToCDN(false, config);
```

## 观众拉流

@@@Audience_Pull@@@
