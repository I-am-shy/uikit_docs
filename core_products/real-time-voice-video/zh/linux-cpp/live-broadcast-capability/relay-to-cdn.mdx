---
articleID: 6864
---
# 使用 CDN 直播

---

## 功能简介
	 
@@@Push_Pull_Streaming_via_CDN@@@

## 前提条件

在使用 CDN 直播之前，请确保：

- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 已在项目中集成 ZEGO Express SDK，并实现了基本的音视频推拉流功能，详情请参考 [快速开始 - 集成](!Integration/SDK_Integration) 和 [快速开始 - 实现流程](!Integration/Solution_Implementation)。


@@@Enable_CDN@@@


## 使用步骤

### 转推 CDN

<div class = 'mk-hint'>

若选择使用直推 CDN 功能，则无需执行本节所有步骤，请参考 [直推 CDN](!Publisher_Player_Advanced/RelayToCDN#3_2)。

</div>

#### 1 初始化、登录房间、开始推流

请参考 [快速开始 - 实现流程](!Integration/Solution_Implementation#CreateEngine) 的 “创建引擎”、“登录房间”、“推流”。

#### 2 开始转推

当`推流成功后`，调用 [addPublishCdnUrl](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#add-publish-cdn-url) 接口增加动态转推至 CDN 的 URL，即可将已经成功推向 ZEGO 实时云的音视频流动态向第三方 CDN 进行转推。

<div class='mk-hint'>

* 若开发者有转推到多家第三方 CDN 厂商的需求，可使用同一个流ID多次调用 [addPublishCdnUrl](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#add-publish-cdn-url)（URL 需不同）。
* 若开发者转推到多家第三方 CDN 后，停止转推时也同样需要调用多次来停止所有转推的流。
* 若开发者转推到多家第三方 CDN 后，可从 CDN 回调状态通知 [onPublisherRelayCDNStateUpdate](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-publisher-relay-cdn-state-update) 的列表参数中获取到每条转推流的状态变更通知。
</div>

- 调用示例:

    ```cpp
    // 推流成功后，开始转推到 CDN 

    // 推流时使用的流 ID
    std::string streamID = "STREAM_ID";
    // 需要转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名，可自定义
    std::string URL = "rtmp://推流域名/接入点/streamID";

    engine->addPublishCdnUrl(streamID, URL, [](int errorCode) {
        if(errorCode == 0) {
            // 转推成功
        } else {
            // 转推失败，可能由于网络原因转推请求发送失败
        }
    });
    ```

#### 3 （可选）监听 CDN 回调的状态通知

开发者可通过注册 [onPublisherRelayCDNStateUpdate](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~cpp_linux~class~IZegoEventHandler#on-publisher-relay-cdn-state-update) 获取添加/删除转推 CDN 地址状态回调。在 ZEGO RTC 服务器将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。

<div class='mk-hint'>

开发者可根据该回调判断转推 CDN 的音视频流是否正常：

* 若不正常，则根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
* 若对异常的原因不了解，可联系 ZEGO 技术支持分析具体异常的原因。
 </div>

- 调用示例：

    ```cpp
    class MyEventHandler:public IZegoEventHandler{
    public:
        void onPublisherRelayCDNStateUpdate(const std::string& /*streamID*/, const std::vector<ZegoStreamRelayCDNInfo>& /*streamInfoList*/) {
            // 调用动态转推接口成功后，当 CDN 连接状态发生变更，如出现网络中断导致转推异常等情况，SDK 在重试转推的同时，会通过该回调通知 
            // 请注意，请勿在 SDK 回调线程中调用任何 SDK 接口，需要手动切换为其他线程，否则会产生死锁
        }
    };
    auto handler=std::make_shared<MyEventHandler>();
    engine->setEventHandler(handler);
    ```


#### 4 停止转推

调用 [removePublishCdnUrl](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#remove-publish-cdn-url) 即可删除动态转推至 CDN 的 URL。**调用 [removePublishCdnUrl](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#remove-publish-cdn-url) 接口停止转推时，请确保当前流 streamID 是存在的。**

- 调用示例：

    ```cpp
    // 停止推流前，先停止转推 CDN 

    // 推流时使用的流 ID
    std::string streamID = "STREAM_ID";
    // 需要停止转推的 CDN 地址，请开发者按照实际 URL 填入，streamID 为推流的流名
    std::string URL = "rtmp://推流域名/接入点/streamID";

    engine->removePublishCdnUrl(streamID, URL, [](int errorCode) {
        if(errorCode == 0) {
            // 停止转推成功
        } else {
            // 停止转推失败，可能由于网络原因停止转推请求发送失败
        }
    });
    ```

### 直推 CDN 

<div class = 'mk-hint'>

若选择使用转推 CDN 功能，则无需执行本节所有步骤，请参考 [转推 CDN](!Publisher_Player_Advanced/RelayToCDN#3_1)。
</div>

#### 1 开始直推 CDN

在推流前调用 [enablePublishDirectToCDN](@enablePublishDirectToCDN) 接口将音视频流直接推往 CDN。

<div class = 'mk-warning'>

- 调用 [enablePublishDirectToCDN](@enablePublishDirectToCDN) 接口后再调用 [addPublishCdnUrl](@addPublishCdnUrl) 与 [removePublishCdnUrl](@removePublishCdnUrl) 动态转推至 CDN 则不再生效，因为这两个接口是从 ZEGO 实时音视频云将音视频流转推或停止转推到 CDN，若将音视频流直接推往 CDN 则无法通过 ZEGO 实时音视频云将音视频流再动态转推至 CDN。
- 若调用 [enablePublishDirectToCDN](@enablePublishDirectToCDN) 接口出现 1000038 错误码，可能存在的问题有：域名配置错误、媒体网络异常或媒体网络链接为空，请联系 ZEGO 技术支持。
</div> 

```C++
ZegoCDNConfig config;
// URL 需要开发者根据实际情况填写，streamID 为推流的流名，可自定义
config.url = "rtmp://推流域名/接入点/streamID";
engine->enablePublishDirectToCDN(true, &config);
engine->startPublishingStream("STREAM_ID");
```

#### 2 停止直推 CDN 

若需停止直推 CDN，调用 [stopPublishingStream](@stopPublishingStream) 接口停止推流即可。

停止推流后，若下一次推流无需直推 CDN，则可以调用 [enablePublishDirectToCDN](@enablePublishDirectToCDN) 接口并传值为 “false” 关闭直推 CDN 功能。在推流途中调用此接口不会影响此次推流。

```C++
engine->stopPublishingStream();
ZegoCDNConfig cdnConfig;
engine->enablePublishDirectToCDN(false, &cdnConfig);
```

## 观众拉流

@@@Audience_Pull@@@
