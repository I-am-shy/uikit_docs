---
articleID: 9976
---
# 实现视频通话

---

@@@SupTestEnvNewDocWarn@@@

##  功能简介

本文将介绍如何快速实现一个简单的实时音视频通话。

相关概念解释:

- ZEGO Express SDK：由 ZEGO 提供的实时音视频 SDK，能够为开发者提供便捷接入、高清流畅、多平台互通、低延迟、高并发的音视频服务。
- 流：指一组按指定编码格式封装，不断发送中的音视频数据。一个用户可以同时推多条流（例如一条推摄像头数据，一条推屏幕共享数据）也可以同时拉多条流。每条流都由一个流 ID（streamID）标识。
- 推流：把封包好的音视频数据流推送到 ZEGO 实时音视频云的过程。
- 拉流：从 ZEGO 实时音视频云将已有音视频数据流拉取播放的过程。
- 房间：是 ZEGO 提供的音视频空间服务，用于组织用户群，同一房间内的用户可以互相收发实时音视频及消息。
    1. 用户需要先登录某个房间，才能进行推流、拉流操作。
    2. 用户只能收到自己所在房间内的相关消息（用户进出、音视频流变化等）。
    3. 每个房间由一个 ApplD 内唯一的 roomlD 标识。所有使用同一个 roomID 登录房间的用户即属于同房间。



更多相关概念请参考 [术语说明](#5390)。

## 2 前提条件

在实现基本的实时音视频功能之前，请确保：

- 已在项目中集成 ZEGO Express SDK，实现基本的实时音视频功能，详情请参考 [快速开始 - 集成](!Integration/SDK_Integration)。
- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目管理](https://doc-zh.zego.im/article/12107) 中的“项目信息”。

<Warning title="注意">

SDK 同时也支持 Token 鉴权，若您对项目安全性有更高要求，建议您升级鉴权方式，详情请参考 [如何从 AppSign 鉴权升级为 Token 鉴权](http://doc-zh.zego.im/faq/token_upgrade?product=ExpressVideo)。
</Warning>

## 3 使用步骤

以用户 A 拉取用户 B 的流为例，流程如下图：

![/Pics/Common/ZegoExpressEngine/common_usage.png](/Pics/Common/ZegoExpressEngine/common_usage.png)

整个推拉流过程的 API 调用时序如下图：

<img src="/Pics/QuickStart/quickstart_uml.png" alt="时序图">

### 3.1 创建引擎
 
**1.（可选）创建界面**

<details class="zg-primary">
    <summary>添加界面元素</summary>

在开始之前，推荐开发者添加以下界面元素，方便实现基本的实时音视频功能。

- 本地预览窗口
- 远端视频窗口
- 结束按钮

<img src="/Pics/QuickStart/UI_PC.jpg" alt="界面图">

</details>

**2. 引入头文件**

在项目中引入 ZegoExpressEngine 头文件。

```C++
#include "ZegoExpressSDK.h"
using namespace ZEGO::EXPRESS;
```

**3. 创建引擎** 
     
调用 [createEngine](@createEngine) 接口，将申请到到 AppID 传入参数 “appID”，创建引擎单例对象。
  
如果需要注册回调，可将实现了 [IZegoEventHandler](@-IZegoEventHandler) 的对象传入参数 “eventHandler”。如果不需要注册回调，可将 “nullptr” 传入参数 “eventHandler”，创建引擎后仍需要注册回调时可通过调用 [setEventHandler](@setEventHandler) 接口设置回调。


```C++

ZegoEngineProfile profile;
// AppID 由 ZEGO 分配给各 App
profile.appID = appID;
profile.scenario = ZegoScenario::ZEGO_SCENARIO_GENERAL;
// 创建引擎实例
auto engine = ZegoExpressSDK::createEngine(profile, nullptr);

// 调用 engine 实例对象的各种方法
// 登录房间 =》 推流
// 登录房间 =》 拉流

```  

### 3.2 登录房间  

**1. 登录** 

@@@Express_Video_Login_Room_Notes@@@
  
传入用户 ID 参数 “userID” 和 “userName” 创建 ZegoUser 用户对象后，调用 [loginRoom](@loginRoom)，传入房间 ID 参数 “roomID” 和用户参数 “user”，登录房间。  

<div class="mk-warning">

- 同一个 AppID 内，需保证 “roomID” 全局唯一。  
- 同一个 AppID 内，需保证 “userID” 全局唯一，建议开发者将其设置成一个有意义的值，可将 “userID” 与自己业务账号系统进行关联。  
- “userID” 与 “userName” 不能为空，否则会导致登录房间失败。
  
</div>

```C++
// 创建用户对象
ZegoUser user("user1", "user1");
// 只有传入 “isUserStatusNotify” 参数取值为 “true” 的 ZegoRoomConfig，才能收到 onRoomUserUpdate 回调。
ZegoRoomConfig roomConfig;
//token 由用户自己的服务端生成，为了更快跑通流程，也可以通过即构控制台获取临时的音视频 token
roomConfig.token = "xxxx";
roomConfig.isUserStatusNotify = true;
// 登录房间
engine->loginRoom(roomID, user, roomConfig);
```


**2. 监听登录房间后的事件回调**

根据实际需要，在登录房间后监听想要关注的事件回调，比如房间状态更新、用户状态更新、流状态更新等。  
- [onRoomStateUpdate](@onRoomStateUpdate)：房间状态更新回调。登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK 会通过该回调通知。
- [onRoomUserUpdate](@onRoomUserUpdate)：用户状态更新回调。登录房间后，当房间内有用户新增或删除时，SDK 会通过该回调通知。

    @@@Notes_on_onRoomUserUpdate@@@

- [onRoomStreamUpdate](@onRoomStreamUpdate)：流状态更新回调。登录房间后，当房间内有用户新推送或删除音视频流时，SDK 会通过该回调通知。

@@@Login_Room_Callback@@@ 


```C++
// 房间状态更新回调
void onRoomStateUpdate(const std::string& roomID, ZegoRoomState state, int errorCode, const std::string& extendedData) override {
    // 根据需要实现事件回调      
}

// 用户状态更新回调
void onRoomUserUpdate(const std::string& roomID, ZegoUpdateType updateType, const std::vector<ZegoUser>& userList) override {
    // 根据需要实现事件回调
}

// 流状态更新回调
void onRoomStreamUpdate(const std::string& roomID, ZegoUpdateType updateType, const std::vector<ZegoStream>& streamList, const std::string& extendedData) override {
    // 根据需要实现事件回调    
}
```


### 3.3 推流  

**1. 开始推流**  
      
调用 [startPublishingStream](@startPublishingStream)，传入流 ID 参数 “streamID”，向远端用户发送本端的音视频流。 

<div class="mk-warning">

同一个 AppID 内，需保证 “streamID” 全局唯一。如果同一个 AppID 内，不同用户各推了一条 “streamID” 相同的流，会导致后推流的用户推流失败。

</div>

 
```C++
// 开始推流
engine->startPublishingStream("streamID");
```


**2. （可选）启用本地预览**

<details class="zg-primary">
    <summary>设置预览视图并启动本地预览</summary>

开发者如果希望看到自己本端的画面，可通过调用如下接口启动本地预览。 
  
若开发者使用 Qt 框架进行开发，虽然可以使用 `view->winId()` 的方式传给 SDK 渲染，但该方式会使开发者无法在该控件之上叠加其他控件。为了保障开发质量与效果，建议 Qt 开发者使用 [视频进阶 - 自定义视频渲染](!VideoAdvanced/CustomVideoRender)。

```C++
// Qt 框架下启动本地预览
ZegoView previewWND = ZegoView(ui->view->winId());
ZegoCanvas canvas(previewWND);
engine->startPreview(&canvas);
```  

</details> 


**3. 监听推流后的事件回调**

根据实际应用需要，在推流后监听想要关注的事件回调，比如推流状态更新等。

[onPublisherStateUpdate](@onPublisherStateUpdate)：推流状态更新回调。调用推流接口成功后，当推流状态发生变更（如出现网络中断导致推流异常等情况），SDK 在重试推流的同时，会通过该回调通知。


```C++
// 推流状态更新回调
virtual void onPublisherStateUpdate(const std::string& streamID, ZegoPublisherState state, int errorCode, const std::string& extendedData) {
    // 根据需要实现事件回调
}
```


### 3.4 拉流  
  
**1. 开始拉流**  
  
调用 [startPlayingStream](@startPlayingStream) 接口，根据传入的流 ID 参数 “streamID”，拉取远端推送的音视频流。


<div class="mk-hint">


远端用户推送的 “streamID” 可以从 [IZegoEventHandler](@-IZegoEventHandler) 中的 [onRoomStreamUpdate](@onRoomStreamUpdate) 回调中获得。
</div>




```C++
/** Qt 框架下拉取实时流*/
ZegoView playWND = ZegoView(ui->view->winId());
ZegoCanvas canvas(playWND);
engine->startPlayingStream("streamID", &canvas);
```

**2. 监听拉流后的事件回调**

根据实际应用需要，在拉流后监听想要关注的事件通知，比如拉流状态更新等。

[onPlayerStateUpdate](@onPlayerStateUpdate)：拉流状态更新回调。调用拉流接口成功后，当拉流状态发生变更（如出现网络中断导致推流异常等情况），SDK 在重试拉流的同时，会通过该回调通知。

```C++
// 拉流状态变更回调
virtual void onPlayerStateUpdate(const std::string& streamID, ZegoPlayerState state, int errorCode, const std::string& extendedData) {
    // 根据需要实现事件回调
}
```

### 3.5 体验实时音视频功能

在真机中运行项目，运行成功后，可以看到本端视频画面。

为方便体验，ZEGO 提供了一个 [Web 端调试示例](https://zegodev.github.io/zego-express-webrtc-sample/assistDev/index.html)，在该页面下，输入相同的 AppID、RoomID，输入不同的 UserID、以及对应的 [Token](https://doc-zh.zego.im/article/16309)，即可加入同一房间与真机设备互通。当成功开始音视频通话时，可以听到远端的音频，看到远端的视频画面。



### 3.6 停止推拉流

**1. 停止推流/预览**  

调用 [stopPublishingStream](@stopPublishingStream) 停止向远端用户发送本端的音视频流。    

```C++
// 停止推流
engine->stopPublishingStream();
```     
如果启用了本地预览，调用 [stopPreview](@stopPreview) 接口停止预览。  

```C++
// 停止本地预览
engine->stopPreview();
```

**2. 停止拉流**  

调用 [stopPlayingStream](@stopPlayingStream) 停止拉取远端推送的音视频流。

```C++
// 停止拉流
engine->stopPlayingStream("streamID");
```


### 3.7 退出房间

调用 [logoutRoom](@logoutRoom) 接口退出房间。

```C++
// 退出房间
engine->logoutRoom("roomID");
```

### 3.8 销毁引擎

调用 [destroyEngine](@destroyEngine) 接口销毁引擎，用于释放 SDK 使用的资源。

- 如果需要监听回调，来确保设备硬件资源释放完成，可在销毁引擎时传入 “callback”。该回调只用于发送通知，开发者不可以在回调内释放与引擎相关的资源。

- 如果不需要监听回调，可传入 “nullptr”。


```C++
// 销毁引擎实例
ZegoExpressSDK::destroyEngine(engine, nullptr);
```

## 相关文档
- [常见错误码](!ExpressVideoSDK-Error_Code/Error_Code)
- [如何处理房间与用户的相关问题？](https://doc-zh.zego.im/faq/express_room?product=ExpressVideo&platform=all)
- [如何设置和获取 SDK 的日志、堆栈信息？](https://doc-zh.zego.im/faq/express_sdkLog?product=ExpressVideo&platform=all)
- [SDK 是否支持断线重连？](https://doc-zh.zego.im/faq/reconnect?product=ExpressVideo&platform=all)
- [直播场景下，如何监听远端观众角色用户登录/退出房间的事件？](https://doc-zh.zego.im/faq/audience_event?product=ExpressVideo&platform=all)
- [如何调节摄像头的焦距（变焦功能）？](https://doc-zh.zego.im/faq/express_adjust_focal?product=ExpressVideo&platform=all)

- [为什么我无法打开摄像头？](https://doc-zh.zego.im/faq/camera?product=ExpressVideo&platform=all)

- [如何在较差的网络环境中保证音视频流畅（流量控制功能）？](https://doc-zh.zego.im/faq/flowcontrol?product=ExpressVideo&platform=all)

