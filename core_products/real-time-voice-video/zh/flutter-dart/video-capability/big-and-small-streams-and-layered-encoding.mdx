---
articleID: 18030
---
# 视频大小流和分层编码

- - -

@@@Big_and_small_streams_and_Layered_Encoding_1@@@


## 示例源码下载

请参考 [下载示例源码](!DownloadDemo/DownloadDemo) 获取源码。

相关源码请查看 “/lib/topics/VideoAdvanced/encoding_and_decoding” 目录下的文件。


## 前提条件

在实现两种视频编码功能之前，请确保：

- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 已在项目中集成 ZEGO Express SDK，并实现了基本的音视频推拉流功能，详情请参考 [快速开始 - 集成](!Integration/SDK_Integration) 和 [快速开始 - 实现流程](!Integration/Solution_Implementation)。



## 实现步骤

### 分层视频编码

#### 开启分层视频编码

在调用 [startPublishingStream](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/startPublishingStream.html) 之前，调用 [setVideoConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/setVideoConfig.html) 接口，设置 [ZegoVideoConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoVideoConfig-class.html) 类中的参数 `codecID` 为 `ZegoVideoCodecIDSVC`，开启分层视频编码；并调用 [startPublishingStream](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/startPublishingStream.html) 接口开始推流。

```dart
ZegoVideoConfig videoConfig = ZegoVideoConfig.preset(ZegoVideoConfigPreset.Preset360P);
videoConfig.codecID = ZegoVideoCodecID.Svc;

ZegoExpressEngine.instance.setVideoConfig(videoConfig);
ZegoExpressEngine.instance.startPublishingStream("0012");
```

<Note title="说明">


“codecID” 设置为 “Default”、“VP8” 或 “H265” 可关闭该功能。

</Note>



#### 指定拉取的分层视频

在推流端开启了分层视频编码后，拉流端用户在拉流前后均可调用 [setPlayStreamVideoType](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePlayer/setPlayStreamVideoType.html) 接口，传入具体的拉流参数以拉取特定的视频分层。目前支持的视频分层如下：

|枚举值|说明|
|-|-|
|ZegoVideoStreamTypeDefault|（默认值）根据网络状态自动选择合适的视频分层，例如弱网只拉取基本层。|
|ZegoVideoStreamTypeSmall| 基本层，小分辨率类型。|
|ZegoVideoStreamTypeBig| 扩展层，大分辨率类型。|

```dart
ZegoExpressEngine.instance.setPlayStreamVideoType(ZegoVideoStreamType.Big, streamID);
ZegoExpressEngine.instance.startPlayingStream(self.streamID, playCanvas);
```

### 大小流视频编码

`大小流视频编码` 与 `分层视频编码` 的实现步骤基本一致，不同的是 `大小视频流编码` 功能支持在推流前，分别设置大流和小流的分辨率、帧率和码率等信息。

#### 开启大小流视频编码

在调用 [startPublishingStream](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/startPublishingStream.html) 之前，调用 [setVideoConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/setVideoConfig.html) 接口，设置 [ZegoVideoConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoVideoConfig-class.html) 类中的参数 `codecID` 为 `ZegoVideoCodecIDH264DualStream`，开启大小流视频编码。

```dart
ZegoVideoConfig videoConfig = ZegoVideoConfig.preset(ZegoVideoConfigPreset.Preset360P);
videoConfig.codecID = ZegoVideoCodecID.H264DualStream

ZegoExpressEngine.instance.setVideoConfig(videoConfig);
```

<Note title="说明">


“codecID” 设置为 “Default”、“VP8” 或 “H265” 可关闭该功能。

</Note>



#### 设置基本层、扩展层的参数

通过 [setPublishDualStreamConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/setPublishDualStreamConfig.html) 接口，分别设置大流和小流的分辨率、帧率和码率等信息，并调用 [startPublishingStream](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/startPublishingStream.html) 接口开始推流。

<Warning title="注意">


- 必须同时指定大流、小流的参数，调用 [setPublishDualStreamConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/setPublishDualStreamConfig.html) 接口才能生效。
- 设置大流、小流的分辨率的 “比例” 需要保持一致，否则调用 [setPublishDualStreamConfig](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/setPublishDualStreamConfig.html) 接口会出错。

</Warning>




```dart
List<ZegoPublishDualStreamConfig> configList = List<ZegoPublishDualStreamConfig>();

ZegoPublishDualStreamConfig big = ZegoPublishDualStreamConfig(ZegoVideoStreamType.Big, 540, 960, 15, 1200);
configList.add(big);

ZegoPublishDualStreamConfig small = ZegoPublishDualStreamConfig(ZegoVideoStreamType.Small, 180, 320, 15, 300);
configList.add(small);
ZegoExpressEngine.instance.setPublishDualStreamConfig(configList);

ZegoExpressEngine.instance.startPublishingStream("dual_streamid");
```

#### 指定拉取的视频码流

在推流端开启了视频大小流编码后，拉流端用户在拉流前后均可调用 [setPlayStreamVideoType](https://doc-zh.zego.im/unique-api/express-video-sdkhttps://doc-zh.zego.im/article/dart_flutter/zego_express_engine/ZegoExpressEnginePlayer/setPlayStreamVideoType.html) 接口，传入具体的拉流参数以拉取特定的视频分层。目前支持的视频分层如下：

|枚举值|说明|
|-|-|
|ZegoVideoStreamTypeDefault|（默认值）根据网络状态自动选择合适的视频分层，例如弱网只拉取基本层。|
|ZegoVideoStreamTypeSmall| 基本层，小分辨率类型。|
|ZegoVideoStreamTypeBig| 扩展层，大分辨率类型。|

```dart
ZegoExpressEngine.instance.setPlayStreamVideoType(ZegoVideoStreamType.Big,streamID);
ZegoExpressEngine.instance.startPlayingStream(streamID,canvans);
```

## 常见问题

1. **转推或直推 CDN，观众从 CDN 上拉流，分层视频编码和大小流是否有效？从 CDN 拉取的流码率、分辨率是多少？**

    - `视频分层编码`和 `视频大小流编码` 使用的是 ZEGO 的私有协议，拉流端只有从 ZEGO 服务器上拉取 RTC 流或 L3 流时，才能拉取到不同分层的视频流。

    - 直推 CDN 场景下，由于不经过 ZEGO 服务器，所以码流的分层无效，SDK 会回退至 H.264 编码。从 CDN 拉取的流的分辨率和码率与推流用户设置的分辨率和码率一致。

    - 转推 CDN 场景下，由于 CDN 拉流未使用 ZEGO 的私有协议，ZEGO 服务器转推到 CDN 服务器后的流不支持分层视频编码、视频大小流编码，只能从转推基本层或者转推扩展层中选择一个，CDN 拉流时的分辨率、码率和帧率取决于转推的是基本层还是扩展层。

<Warning title="注意">


        转推到 CDN 时，默认转推扩展层。如果业务需要将基本层转推至 CDN，请联系 ZEGO 技术支持配置。
        
</Warning>


