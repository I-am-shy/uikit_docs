<style>
table th:nth-of-type(1) { min-width: 120px; width: 10%; }
table th:nth-of-type(2) { min-width: 120px; width: 30%; }
table th:nth-of-type(3) { min-width: 120px; width: 30%; }
table th:nth-of-type(4) { min-width: 120px; width: 15%; }
table th:nth-of-type(5) { min-width: 120px; width: 15%; }
table {width: 100%;}
</style>

# 实时消息与信令


- - -

## 功能简介

@@@message_intro@@@


## 示例源码下载

- 微信小程序请参考 [微信小程序 - 跑通示例源码\|_blank](!DownloadDemo_WeChat)。
- 支付宝小程序请参考 [支付宝小程序 - 跑通示例源码\|_blank](!DownloadDemo_AliPay)。

相关源码请查看 “/pages/message” 目录下的文件。

## 前提条件

在发送实时消息前，请确保：

- 已在项目中集成 ZEGO Express SDK，并实现了基本的音视频推拉流功能，详情请参考：
    - [微信小程序 - 集成 SDK\|_blank](!SDK_Integration_WeChat) 和 [微信小程序 - 实现流程\|_blank](!Solution_Implementation_WeChat)。
    - [支付宝小程序 - 集成 SDK\|_blank](!SDK_Integration_AliPay) 和 [支付宝小程序 - 实现流程\|_blank](!Solution_Implementation_AliPay)。

- 已在 [ZEGO 控制台\|_blank](https://console.zego.im) 创建项目，并申请有效的 AppID 和 Server 地址，详情请参考 [控制台 - 项目信息\|_blank](#12107)。

## 使用步骤

### 收发广播消息

1. **发送广播消息**

    调用 [sendBroadcastMessage\|_blank](@sendBroadcastMessage) 接口向同一房间内的其他用户发送广播消息，长度不能超过 1024 字节。

    通过 [ZegoServerResponse \|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_wxxcx~interface~ZegoServerResponse#error-code) 中的 “errorCode” 获取消息发送结果，“0” 表示成功，非 “0” 表示失败。

    ```javascript
    try {
        const isSent = await zg.sendBroadcastMessage(this.data.roomID, this.data.inputMessage)
        console.log('>>> sendMsg success, ', isSent);
    } catch (error) {
        console.log('>>> sendMsg, error: ', error);
    };
    ```
2. **接收广播消息**

    房间内成员注册 [IMRecvBroadcastMessage\|_blank](@IMRecvBroadcastMessage) 回调，当发送方成功发送广播消息后，同一房间内的其他用户通过此回调接收相关信息，包括消息内容、消息 ID、发送时间及发送方信息。

    ```javascript
    zg.on('IMRecvBroadcastMessage', (roomID, chatData) => {
        console.log('IMRecvBroadcastMessage', roomID, chatData);
        let message = {
            ID: 'zego' + chatData[0].fromUser.userID + chatData[0].sendTime,
            name: chatData[0].fromUser.userName,
            time: format(chatData[0].sendTime),
            content: chatData[0].message + '(广播发送)'
        }
    });
    ```

### 收发弹幕消息

1. **发送弹幕消息**

    调用 [sendBarrageMessage\|_blank](@sendBarrageMessage) 接口向同一房间内的其他用户发送弹幕消息，长度不能超过 1024 字节。

    通过 [ZegoServerResponse \|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_wxxcx~interface~ZegoServerResponse#error-code) 中的 “errorCode” 获取消息发送结果，“0” 表示成功，非 “0” 表示失败。

    ```javascript
    try {
        const isSent = await zg.sendBarrageMessage(this.data.roomID, this.data.inputMessage)
        console.log('>>> barrageMessage success, ', isSent);
    } catch (error) {
        console.log('>>> barrageMessage, error: ', error);
    };   
    ```

2. **接收弹幕消息**

    房间内成员注册 [IMRecvBarrageMessage\|_blank](@IMRecvBarrageMessage) 回调，当发送方成功发送弹幕消息后，同一房间内的其他用户通过此回调接收相关信息，包括消息内容、消息 ID、发送时间及发送方信息。

    ```javascript
    zg.on('IMRecvBarrageMessage', (roomID, chatData) => {
        console.log('IMRecvBroadcastMessage', roomID, chatData);
        let message = {
            ID: 'zego' + chatData[0].fromUser.userID + chatData[0].sendTime,
            name: chatData[0].fromUser.userName,
            // @ts-ignore
            time: format(chatData[0].sendTime),
            content: chatData[0].message + '(弹幕发送)'
        }
    }); 
    ```

### 收发自定义信令

1. **发送自定义信令**

    调用 [sendCustomCommand\|_blank](@sendCustomCommand) 接口向同一房间内通过 “toUserIDList” 指定的用户发送自定义信令，长度不能超过 1024 字节。

    通过 [ZegoServerResponse \|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_wxxcx~interface~ZegoServerResponse#error-code) 中的 “errorCode” 获取消息发送结果，“0” 表示成功，非 “0” 表示失败。

    ```javascript
    try {
        const res =  await zg.sendCustomCommand(this.data.roomID, this.data.inputMessage, toUserIDList);
        console.warn('send custom success ' + res)
    } catch(error) {
        console.error(JSON.stringify(error))
    }
    ```

2. **接收自定义信令**

    房间内成员注册 [IMRecvCustomCommand\|_blank](@IMRecvCustomCommand) 回调，当发送方成功发送自定义信令后，同一房间内的指定用户通过此回调接收相关信息，包括消息内容和发送方信息。

    ```javascript
    zg.on('IMRecvCustomCommand', (roomID, fromUser, command) => {
        console.log('IMRecvCustomCommand',roomID, fromUser, command);
        let message = {
            ID: fromUser.userID,
            name: fromUser.userName,
            time: format(new Date().getTime()),
           content: command + '(自定义发送)'
        }
    });
    ```
