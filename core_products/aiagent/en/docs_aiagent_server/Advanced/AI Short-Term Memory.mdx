import MessagesStructure from '/snippets/Reuse/MessagesStructureforAIAgentEN.mdx'

# AI Short-Term Memory (Agent Context) Management

When creating an agent instance and implementing role-playing conversations, the agent can remember recent chat interactions (commonly known as short-term memory), which is implemented through the context of LLM (Large Language Model).
During voice conversations, memory has the following stages:
- Initial Memory: Whether chat history is needed when creating an instance.
  - Can be linked to [ZIM](https://www.zegocloud.com/docs/zim-android/introduction/overview) session history as initial memory;
  - Can use custom external context as initial memory. If empty, no memory will be carried.
- Memory During Voice Call: Chat history generated during voice calls is cached on the AI Agent server.
  - To get real-time memory, refer to the [Get Agent Instance Context List](#get-agent-instance-context-list) section.
  - To clear current memory, refer to the [Reset Agent Instance Context List](#reset-agent-instance-context-list) section.
- Memory Archival After Voice Call
  - Can be archived in ZIM. Refer to the [Archive Memory After Voice Call](#archive-memory-after-voice-call) section.

<Warning title="Warning">

- **Context Length Limit:** LLMs typically have a maximum length limit, exceeding which will result in an error. For example, "doubao-1.5-pro-32k" has a context length of 32k tokens.

- **Context Length vs. Inference Time:** Generally, longer context results in slower LLM output.

- **Context Length vs. Cost:** LLM pricing is usually based on context length for input billing - longer length means higher cost.
</Warning>

## Implementation Steps

### Set Initial Memory

When [creating an agent instance](./../API%20reference/Agent%20Instance%20Management/Create%20Agent%20instance.mdx), you can set the initial memory (initial context) for the agent instance. Memory sources can be either "ZIM session history" or "custom external context",
controlled through the [MessageHistory](./../API%20reference/Agent%20Instance%20Management/Create%20Agent%20instance.mdx#messagehistory) parameter of the create agent instance API. The detailed parameter structure is as follows:

<Tabs>
<Tab title="MessageHistory">

| Parameter    | Type      | Required | Description                                                                               |
|---------------|-----------|----------|------------------------------------------------------------------------------------------|
| SyncMode      | Number    | No       | Message sync mode: <ul><li>0: Sync from ZIM. <Note title="Note"><ul><li>Before using this mode, ensure your project has ZIM service enabled.</li><li>If the UserID hasn't logged in via ZIM client or isn't registered on ZIM server, the Real-Time AI Agent backend will automatically register it with ZIM service.</li><li>It's recommended to register the user in advance to complete user information settings and improve agent instance creation efficiency.</li></ul></Note></li><li>1: Sync through the following `Messages` parameter.</li></ul> |
| Messages      | Array of Object | No  | Message list.                                                                           |
| WindowSize    | Number    | No       | Number of recent historical messages to use as context when calling LLM service. Default is 20, maximum is 100. Valid range is [0, 100].                                    |
| ZIM           | Object    | No       | ZIM-related information. <Note title="Note">Only valid when `SyncMode` is 0.</Note>     |

</Tab>
<Tab title="MessageHistory.Messages">

<MessagesStructure/>

</Tab>
<Tab title="MessageHistory.ZIM">

| Parameter  | Type   | Required | Description                                                           |
|------------|--------|----------|-----------------------------------------------------------------------|
| RobotId    | String | No       | The `UserInfo.UserId` corresponding to the ZIM [register bot](https://www.zegocloud.com/docs/zim-server/bot/register-bots#request-parameters) API call. Used to load chat context between users and this ZIM bot, and synchronize messages generated during conversations to ZIM. If empty, the Real-Time AI Agent backend will generate one randomly. |
| LoadMessageCount | Number | No  | Number of messages to fetch from ZIM service as context when creating agent instance. Defaults to `WindowSize` value (upper limit). |

</Tab>
</Tabs>

#### Load Initial Memory from ZIM Session History

1. Ensure your app has [ZIM](https://www.zegocloud.com/docs/zim-android/introduction/overview) service enabled
2. When [creating an agent instance](./../API%20reference/Agent%20Instance%20Management/Create%20Agent%20instance.mdx), set `SyncMode` to 0 and fill in the corresponding `ZIM` parameters. Example:

<Note title="Note">`ZIM.RobotId` is the `UserInfo.UserId` corresponding to the ZIM [register bot](https://www.zegocloud.com/docs/zim-server/bot/register-bots#request-parameters) API call.</Note>

```json
 "MessageHistory": {
    "SyncMode": 0,
    "ZIM": {
        "RobotId": "@RBT#123",
        "LoadMessageCount": 10
    }
 }
```

#### Load Initial Memory from Custom External Context

1. Business needs to store context information itself.
2. When [creating an agent instance](./../API%20reference/Agent%20Instance%20Management/Create%20Agent%20instance.mdx), set `SyncMode` to 1 and fill in the corresponding `Messages` parameter. Example:

```json
 "MessageHistory":{
    "SyncMode": 1,
    "Messages": [
        {
            "Role": "user",
            "Content": "What's your name?"
        },
        {
            "Role": "assistant",
            "Content": "My name is Doubao."
        },
        {
            "Role": "user",
            "Content": "Tell me a story."
        },
        {
            "Role": "assistant",
            "Content": "Sure, let me tell you the story of 'The Three Little Pigs'."
        }
    ]
}
```

### Managing Memory During Voice Call

Managing memory during voice calls means managing the agent instance context. You can get the context list or clear it.

#### Get Agent Instance Context List

Call the Get Agent Instance Context List API ([GetAgentInstanceMsgList](./../API%20reference/Agent%20Instance%20Control/Get%20Agent%20Instance%20Msg%20List.mdx)) with the `AgentInstanceId` returned from the create agent instance API. The server will return the context list for that instance, with messages sorted by chat time in ascending order. Example:

```json
{
    "Code": 0,
    "Message": "success",
    "RequestId": "2537521374375652066",
    "Data": {
        "Total": 4,
        "MessageList": [
            {
                "Role": "user",
                "Content": "What's your name?"
            },
            {
                "Role": "assistant",
                "Content": "My name is Doubao."
            },
            {
                "Role": "user",
                "Content": "Tell me a story."
            },
            {
                "Role": "assistant",
                "Content": "Sure, let me tell you the story of 'The Three Little Pigs'."
            }
        ]
    }
}
```

#### Reset Agent Instance Context List

Call the Reset Agent Instance Context List API ([ResetAgentInstanceMsgList](./../API%20reference/Agent%20Instance%20Control/Reset%20Agent%20Instance%20Msg%20List.mdx)) with the `AgentInstanceId` returned from the create agent instance API. The server will reset the context list for the current instance.

### Archive Memory After Voice Call

Simply set `SyncMode` to `0` and provide a valid ZIM bot ID as `ZIM.RobotId` when creating an agent instance, and the voice call conversation records will be stored in the ZIM service. These stored chat history messages can be used as initial memory for subsequent conversations. Refer to the [Load Initial Memory from ZIM Session History](#load-initial-memory-from-zim-session-history) section. You can also maintain historical memory archives in other ways according to your business needs.

Configuration example:
```json
 "MessageHistory": {
    "SyncMode": 0,
    "ZIM": {
        "RobotId": "@RBT#123"
    }
}
```