# 展示用户和智能体状态

在与 AI Agent 进行实时语音通话时，可能需要在客户端界面上实时展示智能体实例说话和用户说话的状态变化以便提高体验。您可以通过监听相应的服务端回调来获取这些状态消息。

状态消息包括以下类型：

- 智能体实例说话状态事件： 开始说话，说话结束。
- 用户说话状态事件：开始说话，说话结束。

## 快速实现

### 监听服务端异常事件


请联系 ZEGO 技术支持配置用于接收AI Agent事件通知的回调地址。

当服务端有智能体实例说话状态事件时，服务端会将对应的事件信息通过您配置的回调通知到您。其内容示例如下：

```json
{
    "AppId": 1234567,
    "AgentInstanceId": "1912124734317838336",
    "Data": {
        "Action": "SPEAK_BEGIN",// SPEAK_BEGIN: 开始说话 SPEAK_END: 说话结束
    },
    "Event": "AgentSpeakAction",
    "Nonce": "7450395512627324902",
    "Signature": "fd9c1ce54e85bd92f48b0a805e82a52b0c0c6445",
    "Timestamp": 1745502313000,
    "AgentUserId": "123456789",
    "RoomId": "123456789",
    "Sequence": 123456789,
}
```
当服务端有用户说话状态事件时，服务端会将对应的事件信息通过您配置的回调通知到您。其内容示例如下：
```json
{
    "AppId": 1234567,
    "AgentInstanceId": "1912124734317838336",
    "Data": {
        "Action": "SPEAK_BEGIN",// SPEAK_BEGIN: 开始说话 SPEAK_END: 说话结束
    },
    "Event": "UserSpeakAction",
    "Nonce": "7450395512627324902",
    "Signature": "fd9c1ce54e85bd92f48b0a805e82a52b0c0c6445",
    "Timestamp": 1745502313000,
    "AgentUserId": "123456789",
    "RoomId": "123456789",
    "Sequence": 123456789,
}
```
更多详细信息请参考 [通用回调](/aiagent-server/callbacks/general-callback) 和 [异常事件错误码](/aiagent-server/callbacks/exception-codes)文档。

### 如何通知客户端并展示状态

当您通过服务端回调接收到智能体实例或用户的说话状态事件后，您需要将这些状态信息通知到客户端，以便客户端可以实时展示状态变化。以下是两种常用的通知方式：

#### 1. 使用自有信令通道

如果您的应用已经有自己的信令通道，如WebSocket或即时通讯系统，您可以：

- 在服务端接收到状态事件回调后，通过您的信令通道将状态信息转发给相关客户端
- 与客户端约定好消息格式，客户端根据接收到的状态信息更新UI界面
- 这种方式的优点是可以完全控制消息格式和传输逻辑，适合已有成熟信令系统的应用

示例流程：
1. 服务端接收到ZEGO回调的智能体说话状态事件
2. 服务端通过WebSocket或其他信令通道将状态转发给客户端
3. 客户端接收状态信息并更新UI（如显示说话指示器、动画等）

#### 2. 借用ZEGO RTC房间消息通道，发送自定义消息

如果您没有自己的业务信令通道，可以借用ZEGO RTC SDK提供的房间消息功能：

- 在服务端接收到状态事件回调后，调用ZEGO Server API发送自定义消息
- 客户端通过ZEGO RTC SDK监听自定义消息，接收状态变化通知
- 这种方式的优点是无需额外搭建信令系统，可以直接利用ZEGO提供的基础设施

示例流程：
1. 服务端接收到ZEGO回调的用户说话状态事件并组装信息
2. 服务端调用ZEGO Server API发送自定义消息
3. 房间内的所有客户端通过RTC SDK接收到自定义消息并更新UI

示例代码：

服务端：
```javascript
// 1. 服务端接收到ZEGO回调的用户说话状态事件并组装信息
const message = {
    eventType: 'AgentSpeakAction',
    data: {
        sequence: Sequence,
        action: Action,
    },
}

```
2. 服务端调用ZEGO Server API发送房间广播消息
https://doc-zh.zego.im/article/19553
```javascript
https://rtc-api.zego.im/?Action=SendCustomCommand
&RoomId=room
&FromUserId=userA
&ToUserId[]=user1&ToUserId[]=user2
&MessageContent=%E6%8E%A8%E9%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BF%A1%E6%81%AF-%E6%96%B0%E6%8E%A5%E5%8F%A3
&<公共请求参数>
```


客户端：
```javascript
// 3. 客户端通过ZEGO RTC SDK监听自定义消息
    zg.on("IMRecvCustomCommand", (roomID: string, fromUser: ZegoUser, command: string) => {
      try {
        const message = JSON.parse(command);
        switch (message.eventType) {
          case "AgentSpeakAction":
          case "UserSpeakAction":
            // 处理用户说话状态事件
            // 更新UI
            break;
        }
      } catch (error) {
        console.error("解析消息失败:", error);
      }
    });
```