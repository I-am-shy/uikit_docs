# 创建会话
---

##  描述
创建会话 Agent 配置，后续 IM 与 RTC 对话时使用。

## 接口原型

- 请求方法：POST
- 请求地址：`https://aigc-chat-api.zegotech.cn?Action=CreateConversation`
- 传输协议：HTTPS
- 调用频率限制：10 次/秒

## 请求参数

<Note title="说明">
下列 ID 类参数，包括 ConversationId、UserId、AgentId、AgentTemplateId 等，应当遵循以下规则：
- AgentId 的字符限制：数字、英文字符、'-'、'_'、'@'。
- 其它 ID 类参数的字符限制：数字、英文字符、'-'、'_'。
- 长度上限：
  - ConversationId、AgentTemplateId：128 字节。
  - UserId、AgentId：32 字节。
</Note>

| 参数               | 类型   | 是否必选 | 描述                                                                                                                                   |
|------------------|------|------|--------------------------------------------------------------------------------------------------------------------------------------|
| ConversationId   | String | 是    | 会话的唯一标识。需要保证全局唯一。                                                                                                               |
| UserId           | String | 是    | 用户 。                                                                                                                             |
| AgentId          | String | 是    | 智能体 ID，用于智能体登录 IM 或 RTC，必须以`@RBT`#开头。<Note title="说明">请保证 AgentId 在同一 AppID 下唯一。</Note>                                                              |
| AgentTemplateId  | String | 否    | 智能体模版 ID，对应一个智能体配置。如需了解您可用的模版 ID，请参考 [查询模板](./../Template/Describe%20Custom%20Agent%20Template.mdx)。 <Note tiIDstle="说明">至少提供以下参数：`AgentTemplateId` 或 `CustomAgentConfig`</Note>                                           |
| ChatHistoryMode  | Int    | 否    | 是否保存会话历史消息，历史消息会作为上下文输入给 LLM。可用值如下：<ul><li>0：（默认）保存会话历史消息至 [ZIM](https://doc-zh.zego.im/zim-android/introduction/overview)（您需要自行 [集成 ZIM SDK](https://doc-zh.zego.im/zim-android/send-and-receive-messages) 注册用户或者调用 ZIM 服务端接口 [注册用户](https://doc-zh.zego.im/zim-server/user/batch-register-users)）。</li><li>1：保存会话历史消息至 ZIM（AI Agent 服务端会自动注册 ZIM 用户）。</li><li>2：不保存会话历史消息。</li></ul> |
| CustomAgentConfig| Object | 否    | 自定义智能体参数，本参数结构，请见 [CustomAgentConfig](#customagentconfig)。若 `AgentTemplateId` 不为空，则在该模版基础上，根据本参数所传内容做修改。                  |
| ChatConfig       | Object | 否    | 对话配置              |


### CustomAgentConfig

| 参数              | 类型   | 是否必选 | 描述                                                                 |
|------------------|--------|----------|--------------------------------------------------------------------|
| AgentTemplateId  | String | 否       | Agent模版id。<br/>1. 创建或更新会话时无需传入。<br/>2. 创建或更新模版时必填。 |
| Name             | String | 否       | Agent名称。                                                         |
| Avatar           | String | 否       | Agent头像。可以访问的头像地址                                       |
| Intro            | String | 否       | Agent简介                                                          |
| System           | String | 否       | Agent System prompt。                                              |
| LLM              | Object | 否       | 大模型参数。见LLM                                                  |
| TTS              | Object | 否       | TTS参数。见TTS                                                     |
| Source           | String | 否       | 模版来源，查询模版列表时返回：<br/>"Zego": 表示模版由即构提供。<br/>"Customer": 表示模版由客户提供。 |
| Sex              | String | 否       | 性别。                                                             |
| WelcomeMessage   | String | 否       | 机器人的欢迎语。如果不填，按照"你好，我是某某某"的模版下发            |



**LLM:**

| 参数                 | 类型              | 是否必选 | 描述                                                                                     |
|----------------------|-------------------|----------|------------------------------------------------------------------------------------------|
| Type                 | String            | 是        | 大模型类型。可选：<br/>"WenXin"。文心一言<br/>"Doubao"。豆包<br/>"Minimax"。minimax<br/>"StepFun"。阶跃星辰<br/>"Qwen"。通义千问 |
| Model                | String            | 是        | 模型名称，不同LLM下支持的模型不同。具体请参考对应云商的官网文档。                                           |
| IgnoreBracketText    | Array of Integer  | 否        | 过滤大模型返回内容。用以兜底防止LLM输出不需要的内容。支持取值及含义如下：<br/>- 1：emoji表情                      |
| ResponseFormatType   | int               | 否        | 大模型返回内容格式。<br/>0：常规文本（默认）<br/>1：JSON                                        |
| ResponseMessageName  | String            | 否        | 大模型返回JSON时，TTS读取内容的字段名，当ResponseFormatType值为1时才有效。                          |
| ExtensionLLMParams   | string            | 否        | JSON字符串。填写大语言模型支持字段，例如temperature、top_p等<br/>\{\"temperature\":0.2,\"top_p\":0.7\} |



**TTS:**

| 参数                   | 类型              | 是否必选 | 描述                                                                                                                                   |
|------------------------|-------------------|----------|--------------------------------------------------------------------------------------------------------------------------------------|
| Type                   | String            | 是        | 语音合成类型。可选：<br/>"Aliyun"。阿里云TTS<br/>"Huoshan"。火山云TTS<br/>"Minimax"。minimax                                                                                   |
| Voice                  | String            | 是        | 音色，不同TTS下支持音色不同。具体支持的列表可参考对应语音大模型支持的音色。                                                                                                   |
| ExtensionParams        | Object            | 否        | 第三方 TTS 扩展参数。                                                                                                                 |
| IgnoreBracketText      | Array of Integer  | 否        | 过滤大模型返回内容中指定标点符号中的文字后再进行语音合成。你需要在大模型 Prompt 中自行定义哪些内容放在指定标点符号内。<br/>支持取值及含义如下：<br/>- 1：中文括号（）<br/>- 2：英文括号()<br/>- 3：中文方括号【】<br/>- 4：英文方括号[]<br/>- 5：英文花括号{}<br/>默认值：1、2，表示对（）、()、过滤。<br/>空数组：不过滤 |
| IgnoreCustomBracketText| Array of String   | 否        | 作用同IgnoreBracketText，自定义两个相同的内容中被过滤。数组大小限制最大5个。<br/>示例：配置["###"]<br/>效果：<br/>###<br/>被忽略的内容<br/>###                                   |
| SilenceDuration        | Int               | 否        | 默认为0，单位为毫秒ms。在基于ZEGO断句进行TTS时，断句停顿额外增加对应的耗时。大小限制 0-5000                                                                                   |
| ExtensionTTSParams     | String            | 否        | 第三方TTS请求参数，一般为第三方请求体。可以用于填写大语言模型支持字段，例如temperature、top_p等。<br/>目前支持第三方的参数：<br/>1. minimax 大模型tts，<br/>2. 火山大模型（单向tts）<br/>3. 火山大模型（双向tts），<br/>格式为：转义之后的json字符串<br/>比如：\{\"model\":\"model_name\",\"text\":\"text_content\",\"temperature\":0.1,\"top_p\":1.0\} |


### 各tts第三方扩展透传参数说明（ExtensionTTSParams）

<Tabs title="TTS厂商">
<Tab title="Minimax TTS">

Minimax TTS 的 json 格式:

```json
{
  "model" : "speech-01",
    "text": "",
    "stream": True,
    "timber_weights": [
      {
        "voice_id": "male-qn-qingse",
        "weight": 1
      },
      {
        "voice_id": "female-shaonv",
        "weight": 1
      }
    ],
    "voice_setting":{
        "voice_id": "",
        "speed": 1,
        "vol": 1,
        "pitch": 0,
        "emotion": "happy"
    },
    "audio_setting":{
        "sample_rate": 32000,
        "bitrate": 128000,
        "format": "mp3"
    }
  }
  ```


当前可以支持的内容:
- speed
- vol
- pitch
- emotion

[第三方官方接口文档(要使用流式)](https://platform.minimaxi.com/document/T2A%20V2?key=66719005a427f0c8a5701643)

</Tab>
<Tab title="火山TTS（大模型）单向(默认)">

火山TTS（大模型）单向(默认)的json格式：

```json
{
    "app": {
        "appid": "appid123",
        "token": "access_token",
        "cluster": "volcano_tts",
    },
    "user": {
        "uid": "uid123"
    },
    "audio": {
        "voice_type": "zh_male_M392_conversation_wvae_bigtts",
        "encoding": "pcm",
        "speed_ratio": 1.0,
    },
    "request": {
        "reqid": "uuid",
        "text": "字节跳动语音合成",
        "operation": "query",
    }
}
```

当前可以支持的内容:
- cluster
- speed_ratio

[第三方官方接口文档](https://www.volcengine.com/docs/6561/1257584)

</Tab>
<Tab title="火山TTS（大模型）双向">

火山TTS（大模型）双向的json格式：

```json
{
    "user": {
        "uid": "12345"
    },
    "event": 100,
    "req_params": {
        "text": "明朝开国皇帝朱元璋也称这本书为,万物之根",
        "speaker": "zh_female_shuangkuaisisi_moon_bigtts",
        "audio_params": {
            "format": "mp3",
            "pitch_rate": 0,
            "speech_rate": 100,
            "sample_rate": 24000
        },
      }
    }
}
```

当前可以支持的内容:
- pitch_rate
- speech_rate

[第三方官方接口文档](https://www.volcengine.com/docs/6561/1329505)

</Tab>
</Tabs>

<Warning title="注意">
使用 ExtensionTTSParams 时，需要转义为字符串（\" key/value \"）json的格式，为各第三方平台的请求体,红色部分是目前可以支持的内容
</Warning>

---

**ExtensionParams:** 

| 参数                  | 类型   | 是否必选 | 描述                                                                                                                                   |
|----------------------|--------|----------|--------------------------------------------------------------------------------------------------------------------------------------|
| Cluster              | String | 否       | 集群 id，仅适用于火山云，使用火山复刻音色时并且普通流式API时需指定。⚠️注意，此字段会被ExtensionTTSParams的Cluster替换掉。                                               |
| ApiType              | String | 否       | 第三方API类型，适用于火山云：<br/>- 普通流式API（默认）：stream<br/>- 双向流式API: bidirection                                           |
| ResourceId           | String | 否       | 资源 id，仅适用于火山云，使用火山bidirection API时需指定:<br/>- 大模型语音合成：volc.service_type.10029<br/>- 声音复刻2.0（不支持声音复刻1.0）：<br/>  - volc.megatts.default（小时版）<br/>  - volc.megatts.concurr（并发版） |



**ChatConfig:**

| 参数                  | 类型   | 是否必选 | 描述                                                                                                                                   |
|----------------------|--------|----------|--------------------------------------------------------------------------------------------------------------------------------------|
| LLMSystemMode        | int    | 否       | LLM的System输入来源，默认为0<br/>0:  会话配置CustomAgentConfig的System<br/>1: 优先使用会话配置CustomAgentConfig的System；并行业务基于ASR识别结果自定义本轮对话System（相当于编辑用户问题，LLM重新回答）<br/>2：业务基于ASR识别结果自定义本轮对话System，若5s内没有返回，则不再等待，以原逻辑进行处理，即创建会话时的system。基于ASR语音识别结果，自定义当轮对话LLM- System的处理方式，请查看章节3 |
| EnableLLMServerMessage | Int  | 否       | 是否开启服务端回调LLM结果。若开启，则按照每句话返回LLM输出结果。回调内容参考3.1章节<br/>0：不开启。（默认）<br/>1：开启。                                               |

## 请求示例

```json
{
  "ConversationId": "test_conversation_001",
  "UserId": "test_user_001",
  "AgentId": "@RBT#test_agent_001",
  "AgentTemplateId": "template_001",
  "ChatHistoryMode": 1,
  "CustomAgentConfig": {
    "Name": "AI助手",
    "Avatar": "https://example.com/avatar.png",
    "Intro": "我是一个AI助手",
    "System": "你是一个专业的AI助手",
    "LLM": {
      "Type": "WenXin",
      "Model": "ERNIE-Bot-4",
      "IgnoreBracketText": [1],
      "ResponseFormatType": 0
    },
    "TTS": {
      "Type": "Aliyun",
      "Voice": "xiaogang",
      "IgnoreBracketText": [1, 2],
      "SilenceDuration": 500
    }
  },
  "ChatConfig": {
    "LLMSystemMode": 0,
    "EnableLLMServerMessage": 0
  }
}
```

## 响应参数

| 参数 | 类型 | 描述 |
|------|------|------|
| Code | Int | 返回码。0表示成功，其他值表示失败 |
| Message | String | 返回信息描述 |

## 响应示例

```json
{
    "Code": 0,
    "Message": "success"
}
```

