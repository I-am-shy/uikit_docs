# 快速开始
--- 
## 准备环境
在开始集成 ZEGO AIAgent SDK 前，请确保开发环境满足以下要求：

- Android Studio 2020.3.1 或以上版本。
- Android SDK 25、Android SDK Build-Tools 25.0.2、Android SDK Platform-Tools 25.x.x 或以上版本。
- Android 4.4 或以上版本，且支持音视频的 Android 设备。
- Android 设备已经连接到 Internet。

## 前提条件
- 已在 [ZEGO 控制台](https://console.zego.im) 创建项目，并申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目信息](https://doc-zh.zego.im/article/12107)。
- 联系 ZEGO 技术支持，开通 AI Agent 相关服务。
- 已经集成了 [ZEGO Express SDK](https://doc-zh.zego.im/article/195)。


## 集成SDK

### 复制 SDK AAR 文件手动集成
1. 下载 SDK
2. 将解压后的 AAR 文件中的 “xxx.aar” 文件拷贝至您的项目目录下，如 “app/libs”。
3. 在项目的 app 级别的 build.gradle 文件的 android 节点下添加以下代码：
```java
android{
    // ...
     sourceSets {
        main {
            jniLibs.srcDirs = ['libs']
        }
    }
}
```
在 dependencies 节点下添加以下代码：
```java
// 集成 AI agent SDK 到项目中
dependencies {
    api fileTree(dir: 'libs', include: ['*.jar'])
    // 需要用到这两个库
    api "com.squareup.picasso:picasso:2.8"
    api "com.google.code.gson:gson:2.9.1"
}
```


## 核心能力实现

### 初始化用户信息和 SDK 参数
1. 在开始使用 AI Agent 之前，您需要完成以下步骤：
    - 完成 RTC 初始化

    <Warning title="注意">
    在实现 AI Agent 的功能之前，请确保已经集成了 [ZEGO Express Web SDK](https://doc-zh.zego.im/article/195)。
    </Warning>

    - 已经预先创建并且获得 AI 模版
    - 已经获取到用户信息包含id,name
    - 已经获取到用于 SDK 鉴权的 appid,appSign,token
2. 初始化SDK
    ```java
    UserProfile userProfile = new UserProfile("userid", "username");
    String token =  // 用于SDK鉴权的 token;
    AuthData authData = new AuthData(appID, appSign, token);
    ZegoAIAgent.instance().initSDK(getApplication(), authData, userProfile);
    ```
3. 进入语音聊天之前，需要申请语音权限
    ```java
    private final ActivityResultLauncher<String> requestPermissionLauncher = registerForActivityResult(
        new ActivityResultContracts.RequestPermission(), new ActivityResultCallback<Boolean>() {
            @Override
            public void onActivityResult(Boolean isGranted) {
                if (isGranted) {
                    // 同意权限
                } else {
                }
            }
        });

    // 通过以下代码触发申请语音权限弹窗
    requestPermissionLauncher.launch(Manifest.permission.RECORD_AUDIO);
    ```


### 创建会话
在获取语音权限以后，需要根据预先创建并且获得的AI模版来创建会话,实现逻辑如下：
1. 使用 SDK 接口 `ZegoAIAgent.instance().queryConversationList` 查询当前用户是否已经创建过会话，如果已经创建过会话，则不用再创建。
2. 如果没有创建过会话，则需要使用 SDK 接口 `ZegoAIAgent.instance().createConversation` 来创建会话。
```java
private void createConversationIfNeed() {
    CustomAgentConfig xiaoZhiConfig ; // 预先创建并且获得的AI模版
    ZegoAIAgent.instance()
        .queryConversationList(new QueryConversationConfig(), new QueryConversationListCallback() {
            @Override
            public void onResult(int errorCode, String message, String requestId,
                QueryConversationListData conversationListData) {
                if (errorCode == 0) {
                    if (conversationListData != null && conversationListData.conversationList != null
                        && conversationListData.conversationList.length > 0) {
                        Conversation conversation = conversationListData.conversationList[0];
                        onConversationReady(conversation, userProfile);
                    } else {
                        ZegoAIAgent.instance().createConversation(xiaoZhiConfig, new CreateConversationCallback() {
                            @Override
                            public void onResult(int errorCode, String message, String requestId,
                                Conversation conversation) {
                                if (errorCode == 0) {
                                    onConversationReady(conversation, userProfile);
                                }
                            }
                        });
                    }
                }
            }
        });
}
```

### 实现 AI 语音互动
创建会话以后，就可以继续以下步骤来进行语音互动了：
1. 初始化 ZegoExpress SDK 并且登录房间 和推流，具体过程见 [](https://doc-zh.zego.im/article/7627#4)
2. 推流成功后，调用 AIAgentSDK 接口 `ZegoAIAgent.instance().startChat`来开启会话，并且在开启会话成功以后，主动去拉 AI 的语音流：
```java
// ...
ZegoExpressEngine.createEngine(zegoEngineProfile, null);
// ...
ZegoRoomConfig roomConfig = new ZegoRoomConfig();
roomConfig.isUserStatusNotify = true;
ZegoExpressEngine.getEngine().loginRoom(roomID, new ZegoUser(userID, userName), roomConfig, callBack);

String roomID ; // 房间 ID 由用户传入
ZegoExpressEngine.getEngine()
    .loginRoom(userProfile.userID, userProfile.userName, roomID, new IZegoRoomLoginCallback() {
        @Override
        public void onRoomLoginResult(int errorCode, JSONObject extendedData) {
            if (errorCode == 0) {

                String userSteamID ; // 用户推流 ID 由用户传入
                ZZegoExpressEngine.getEngine().startPublishingStream(userSteamID);

                String agentStreamID ; // 拉AI流的 ID 由用户传入
                ZegoAIAgent.instance()
                    .startChat(conversation.conversationId, roomID, userSteamID, agentStreamID,
                        new StartRTCChatCallback() {
                            @Override
                            public void onResult(int errorCode, String message, String requestId) {
                                // 开启会话成功以后，主动去拉 AI 的语音流：
                                if (errorCode == 0) {
                                    ZegoExpressEngine.getEngine().startPlayStream(agentStreamID);
                                    onVoiceChatReady();
                                }
                            }
                        });
            }

        }
    });
```
3. 此时会话已经成功建立，用户可以通过 Express SDK 的 `onIMRecvCustomCommand` 回调来获取并且展示语音聊天的文本内容,具体的展示逻辑见 [获取AI状态 & 字幕]()
```java
ZegoExpressEngine.getEngine().setEventHandler(new IZegoEventHandler() {

    @Override
    public void onIMRecvCustomCommand(String roomID, ZegoUser fromUser, String command) {
        super.onIMRecvCustomCommand(roomID, fromUser, command);
        Log.d(TAG, "onIMRecvCustomCommand() called with: roomID = [" + roomID + "], fromUser = [" + fromUser
            + "], command = [" + command + "]");

        try {
            AudioChatTextMessage roomMessage = gson.fromJson(command, AudioChatTextMessage.class);

            switch (roomMessage.cmd) {
                case 1:
                    if (roomMessage.seq_id < lastCMD1Seq) {
                        return;
                    }
                    if (roomMessage.data.speak_status == 1) {
                        // AI_LISTEN 正在听
                    } else if (roomMessage.data.speak_status == 2) {
                        // AI_THINKING 正在想
                    }
                    lastCMD1Seq = roomMessage.seq_id;
                    break;
                case 2:
                    if (roomMessage.data.speak_status == 1) {
                        // AI_SPEAKING 正在说
                    } else if (roomMessage.data.speak_status == 2) {
                        // AI_LISTEN 正在听
                    }
                    break;
                case 3:
                    //  收到 asr 文本（右边），更新聊天信息
                    aiChatListView.onAsrChatMsgRecved(roomMessage);
                    break;
                case 4:
                    // 收到 LLM 文本(左边)，更新聊天信息
                    aiChatListView.onLLMChatMsgRecved(roomMessage);
                    break;
                default:
                    break;
            }
        } catch (Exception e) {

        }
    }
});
```

### 结束会话
用户选择结束会话时，需要按照以下步骤处理：
1. 调用 AIAgent SDK 接口 `ZegoAIAgent.instance().stopChat` 结束会话。
2. Express SDK 也需要退出房间并且销毁。
```java
ZegoAIAgent.instance().stopChat(conversation.conversationId, null);
ZegoExpressEngine.getEngine().logoutRoom();
ZegoExpressEngine.getEngine().destroyEngine();
```
