# 和精品照片数字人搭配使用

---

精品照片数字人是 AI Agent SDK 的一项高级功能，它能让您的 AI 助手拥有逼真的数字人形象，提供更加自然和沉浸式的交互体验。本文将指导您如何在 AI Agent SDK 中使用精品照片数字人功能。

## 前提条件

在开始使用精品照片数字人功能之前，请确保：

1. 已完成 AI Agent SDK 的初始化，包括配置认证信息和用户信息。
2. 已创建基础会话，了解基本的会话管理流程。
3. 已在控制台开通精品照片数字人相关服务。

## 功能特点

- 高品质视觉效果：提供逼真的面部表情和动作。
- 灵活的布局控制：支持自定义数字人显示位置、大小和图层。
- 视频输出控制：支持设置视频分辨率和格式。

## 实现AI数字人互动
参考 [快速开始 -  创建会话](../Quick%20Start/Based%20on%20%20SDK.mdx#创建会话)，创建会话完成后，即可开启数字人会话功能。

### 开启数字人会话
<Steps>
<Step title="初始化 ZegoExpress SDK">
通过 [createEngine](https://doc-zh.zego.im/article/api?doc=express-audio-sdk_API~java_android~class~ZegoExpressEngine#create-engine) 接口初始化 Zego Express SDK
```java
private void initExpressSDK() {
    ZegoEngineConfig config = new ZegoEngineConfig();
    HashMap<String, String> advanceConfig = new HashMap<>();
    advanceConfig.put("notify_remote_device_unknown_status", "true");
    advanceConfig.put("notify_remote_device_init_status", "true");

    /**下面的设置用来做应答延迟优化的，需要集成对应版本的ZegoExpressEngine sdk，请联系即构同学**/
    advanceConfig.put("enforce_audio_loopback_in_sync", "true");  // 应答延迟优化
    /*********************************************************************************************************/
    advanceConfig.put("sideinfo_callback_version", "3");  // 让 sei 和 frame 一一对应
    config.advancedConfig = advanceConfig;
    ZegoExpressEngine.setEngineConfig(config);

    ZegoEngineProfile zegoEngineProfile = new ZegoEngineProfile();
    zegoEngineProfile.appID = KeyCenter.appID;
    zegoEngineProfile.appSign = KeyCenter.appSign;
    zegoEngineProfile.scenario = ZegoScenario.STANDARD_VOICE_CALL;
    zegoEngineProfile.application = getApplication();
    ZegoExpressEngine.createEngine(zegoEngineProfile, null);
    }
```
</Step>
<Step title="登录 Express 房间">
完成 Zego Express SDK 初始化后，调用 [loginRoom](https://doc-zh.zego.im/article/api?doc=express-audio-sdk_API~java_android~class~ZegoExpressEngine#login-room-2) 登录 Express 房间

```java

String roomId ; // 由用户自己定义
ZegoRoomConfig roomConfig = new ZegoRoomConfig();
roomConfig.isUserStatusNotify = true;
ZegoExpressEngine.getEngine().loginRoom(roomID, new ZegoUser(userProfile.userID, userProfile.userName), roomConfig, new IZegoRoomLoginCallback() {
    @Override
    public void onRoomLoginResult(int errorCode, JSONObject extendedData) {
    }
});
```
</Step>

<Step title="开启会话并且拉流">
进入房间成功以后，调用 AIAgentSDK 接口 [startChat](../Client%20API/API%20reference.mdx#startchat) 开启数字人会话,开启成功以后设置 ZEGO Express SDK 自定义渲染并且监听回调，调用 [startPublishingStream](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoExpressEngine#start-publishing-stream) 和 [startPlayingStream](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoExpressEngine#start-playing-stream-2) 推拉流。
```java
// .. 参考上一步
Conversation conversation;  // 当前页面的会话信息
ZegoPreviewView previewView  ; // 用户自己创建，用来渲染数字人的view
String roomId; // 房间ID，用户可以自定义生成规则
String userStreamID ;  // 用户推流ID，用户可以自定义生成规则
String agentStreamId ;  // AI语音流ID，用户可以自定义生成规则
String metaHumanStreamID // 数字人的流ID，用户可以自定义生成规则
String metaHumanID ;     // 
ZegoExpressEngine.getEngine().loginRoom(...,new IZegoRoomLoginCallback() {
    @Override
    public void onRoomLoginResult(int errorCode, JSONObject extendedData) 
    {
        if(errorCode == 0){
            customRender();
      
            ZegoAIAgent.instance().startChat(conversation.conversationId,roomId,userStreamID,agentStreamId,metaHumanStreamId,metaHumanID,previewView, new StartRTCVideoChatCallback() {
                @Override
                public void onResult(int errorCode1, String message1,String requestId1) {
                    if (errorCode1 == 0) {
                        // 设置拉流缓冲大小
                        ZegoExpressEngine.getEngine().setPlayStreamBufferIntervalRange(metaHumanStreamID, 100, 2000);
                        // 开始拉流
                        ZegoExpressEngine.getEngine().startPlayingStream(metaHumanStreamID);
                    } 
                }

                @Override
                public void onSurfaceFirstFrameDraw() {
                    // 开始推流
                    ZegoExpressManager.getInstance().startPublishingStream(publishStreamID);
                }
            });
        }
    }
});

pulic void customRender(){
     // 开启自定义渲染
    ZegoCustomVideoRenderConfig renderConfig = new ZegoCustomVideoRenderConfig();
    renderConfig.bufferType = ZegoVideoBufferType.RAW_DATA;
    renderConfig.frameFormatSeries = ZegoVideoFrameFormatSeries.RGB;
    renderConfig.enableEngineRender = false;
    ZegoExpressEngine.getEngine().enableCustomVideoRender(true, renderConfig);
    // 监听视频帧回调
    ZegoExpressEngine.getEngine()setCustomVideoRenderHandler(new IZegoCustomVideoRenderHandler() {
        @Override
        public void onRemoteVideoFrameRawData(ByteBuffer[] data, int[] dataLength, ZegoVideoFrameParam param,String streamID) {
            IAIAgentZegoExpressEventHandler.ZegoAIAgentVideoFrameParam aiAgentParam = new IAIAgentZegoExpressEventHandler.ZegoAIAgentVideoFrameParam();
            aiAgentParam.format = IAIAgentZegoExpressEventHandler.ZegoVideoFrameFormat.getZegoVideoFrameFormat(param.format.value());
            aiAgentParam.height = param.height;
            aiAgentParam.width = param.width;
            aiAgentParam.rotation = param.rotation;
            for (int i = 0; i < 4; i++) {
                aiAgentParam.strides[i] = param.strides[i];
            }
            // 需要把数据传给 AI Agent SDK.
            ZegoAIAgent.instance().onRemoteVideoFrameRawData(data, dataLength, aiAgentParam, streamID);
        }

        @Override
        public void onRemoteVideoFrameEncodedData(ByteBuffer data, int dataLength, ZegoVideoEncodedFrameParam param,long referenceTimeMillisecond, String streamID) {
        }
    });

    // 监听 SEI 回调
    mExpressEventListener = new IZegoEventHandler() {
        @Override
        public void onPlayerSyncRecvSEI(String streamID, byte[] data) {
            // 需要把数据传给 AI Agent SDK.
            ZegoAIAgent.instance().onPlayerSyncRecvSEI(streamID, data);
        }
    };
    ZegoExpressEngine.getEngine().setEventHandler(mExpressEventListener)
    }
```
</Step>

</Steps>

### 结束数字人会话

用户选择结束会话时，需要按照以下步骤处理：
1. 调用 AI Agent SDK 接口 [stopChat](../Client%20API/API%20reference.mdx#stopchat) 结束会话。
2. ZEGO Express SDK 也需要调用 [logoutRoom](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoExpressEngine#logout-room-2) 和 [destroyEngine](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoExpressEngine#destroy-engine) 退出并且销毁房间。
```java
Conversation conversation;  // 当前页面的会话信息
ZegoAIAgent.instance().stopChat(conversation.conversationId, null);
ZegoExpressEngine.getEngine().logoutRoom();
ZegoExpressEngine.getEngine().destroyEngine();
```

## 注意事项

1. 确保在调用 [startChat](../Client%20API/API%20reference.mdx#startchat) 之前已经完成 SDK 初始化和会话创建。
2. 数字人相关的配置参数（如 metaHumanId 等）需要从[数字人 PaaS 服务](https://doc-zh.zego.im/article/18584)获取。