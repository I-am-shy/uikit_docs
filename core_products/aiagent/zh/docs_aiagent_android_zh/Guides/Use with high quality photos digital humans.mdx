# 和精品照片数字人搭配使用

---

精品照片数字人是 AI Agent SDK 的一项高级功能，它能让您的 AI 助手拥有逼真的数字人形象，提供更加自然和沉浸式的交互体验。本文将指导您如何在 AI Agent SDK 中使用精品照片数字人功能。

## 前提条件

在开始使用精品照片数字人功能之前，请确保：

1. 已完成 AI Agent SDK 的初始化，包括配置认证信息和用户信息。
2. 已创建基础会话，了解基本的会话管理流程。
3. 已在控制台开通精品照片数字人相关服务。

## 功能特点

- 高品质视觉效果：基于精品照片的数字人形象，提供逼真的面部表情和动作。
- 灵活的布局控制：支持自定义数字人显示位置、大小和图层。（待定）
- 丰富的语音配置：可调节音调、语速和音量，实现个性化的语音表现。（待定）
- 视频输出控制：支持设置视频分辨率和格式。（待定）

## 实现AI数字人互动
参考 快速开始 -  创建会话，创建会话完成以后，就可以准备开启数字人会话了。

### 开启数字人会话
1. 初始化 ZegoExpress SDK :
```java
     
private void initExpressSDK() {
    ZegoEngineConfig config = new ZegoEngineConfig();
    HashMap<String, String> advanceConfig = new HashMap<>();
    advanceConfig.put("notify_remote_device_unknown_status", "true");
    advanceConfig.put("notify_remote_device_init_status", "true");

    /**下面的设置用来做应答延迟优化的，需要集成对应版本的ZegoExpressEngine sdk，请联系即构同学**/
    advanceConfig.put("enforce_audio_loopback_in_sync", "true");  // 应答延迟优化
    /*********************************************************************************************************/
    advanceConfig.put("sideinfo_callback_version", "3");  // 让 sei 和 frame 一一对应
    config.advancedConfig = advanceConfig;
    ZegoExpressEngine.setEngineConfig(config);

    ZegoEngineProfile zegoEngineProfile = new ZegoEngineProfile();
    zegoEngineProfile.appID = KeyCenter.appID;
    zegoEngineProfile.appSign = KeyCenter.appSign;
    zegoEngineProfile.scenario = ZegoScenario.STANDARD_VOICE_CALL;
    zegoEngineProfile.application = getApplication();
    ZegoExpressEngine.createEngine(zegoEngineProfile, null);
    }
```

2. 登录 Express 房间,具体过程见 [](https://doc-zh.zego.im/article/7627#4)。
```java

String roomId ; // 由用户自己定义
ZegoRoomConfig roomConfig = new ZegoRoomConfig();
roomConfig.isUserStatusNotify = true;
ZegoExpressEngine.getEngine().loginRoom(roomID, new ZegoUser(userProfile.userID, userProfile.userName), roomConfig, new IZegoRoomLoginCallback() {
    @Override
    public void onRoomLoginResult(int errorCode, JSONObject extendedData) {
    }
});
```
3. 进入房间成功以后，设置RTC自定义渲染并且监听回调，然后调用 AIAgentSDK 接口 `ZegoAIAgent.instance().startChat`开启数字人会话：
```java
// .. 参考上一步
Conversation conversation;  // 当前页面的会话信息
ZegoPreviewView previewView  ; // 用户自己创建，用来渲染数字人的view
ZegoExpressEngine.getEngine().loginRoom(...,new IZegoRoomLoginCallback() {
    @Override
    public void onRoomLoginResult(int errorCode, JSONObject extendedData) 
    {
        if(errorCode == 0){
            customRender();
            String metaHumanStreamID // 数字人的流ID，由客户自定义规则生成;
            ZegoAIAgentKit.getInstance().startChat(conversation.conversationId, previewView, new StartRTCVideoChatCallback() {
                @Override
                public void onResult(int errorCode1, String message1,String requestId1) {
                    if (errorCode1 == 0) {
                        // 设置拉流缓冲大小
                        ZegoExpressEngine.getEngine().setPlayStreamBufferIntervalRange(metaHumanStreamID, 100, 2000);
                        // 开始拉流
                        ZegoExpressEngine.getEngine().startPlayStream(metaHumanStreamID);
                    } 
                }

                @Override
                public void onSurfaceFirstFrameDraw() {
                    // 在首帧过来的时候才认为 AIAgent 启动成功，startRTC success 的时候还没有创建成功，后台启动数字人需要时间。
                    // 开始推流
                    ZegoExpressManager.getInstance().startPublishingStream(publishStreamID);
                }
            });
        }
    }
});

pulic void customRender(){
     // 开启自定义渲染
    ZegoCustomVideoRenderConfig renderConfig = new ZegoCustomVideoRenderConfig();
    renderConfig.bufferType = ZegoVideoBufferType.RAW_DATA;
    renderConfig.frameFormatSeries = ZegoVideoFrameFormatSeries.RGB;
    renderConfig.enableEngineRender = false;
    ZegoExpressEngine.getEngine().enableCustomVideoRender(true, renderConfig);
    // 监听视频帧回调
    ZegoExpressEngine.getEngine()setCustomVideoRenderHandler(new IZegoCustomVideoRenderHandler() {
        @Override
        public void onRemoteVideoFrameRawData(ByteBuffer[] data, int[] dataLength, ZegoVideoFrameParam param,String streamID) {
            IAIAgentZegoExpressEventHandler.ZegoAIAgentVideoFrameParam aiAgentParam = new IAIAgentZegoExpressEventHandler.ZegoAIAgentVideoFrameParam();
            aiAgentParam.format = IAIAgentZegoExpressEventHandler.ZegoVideoFrameFormat.getZegoVideoFrameFormat(param.format.value());
            aiAgentParam.height = param.height;
            aiAgentParam.width = param.width;
            aiAgentParam.rotation = param.rotation;
            for (int i = 0; i < 4; i++) {
                aiAgentParam.strides[i] = param.strides[i];
            }
            // 需要把数据传给 AI Agent SDK.
            ZegoAIAgent.instance().onRemoteVideoFrameRawData(data, dataLength, aiAgentParam, streamID);
        }

        @Override
        public void onRemoteVideoFrameEncodedData(ByteBuffer data, int dataLength, ZegoVideoEncodedFrameParam param,long referenceTimeMillisecond, String streamID) {
        }
    });

    // 监听 SEI 回调
    mExpressEventListener = new IZegoEventHandler() {
        @Override
        public void onPlayerSyncRecvSEI(String streamID, byte[] data) {
            ZegoAIAgent.instance().onPlayerSyncRecvSEI(streamID, data);
        }
    };
    ZegoExpressEngine.getEngine().setEventHandler(mExpressEventListener)
    }
```

### 2. 结束数字人会话

用户选择结束会话时，需要按照以下步骤处理：
1. 调用 AIAgent SDK 接口 `ZegoAIAgent.instance().stopChat` 结束会话。
2. ZEGO Express SDK 也需要退出房间并且销毁。
```java
Conversation conversation;  // 当前页面的会话信息
ZegoAIAgent.instance().stopChat(conversation.conversationId, null);
ZegoExpressEngine.getEngine().logoutRoom();
ZegoExpressEngine.getEngine().destroyEngine();
```
```

## 注意事项

1. 确保在调用 `startChat` 之前已经完成 SDK 初始化和会话创建。
2. 数字人相关的配置参数（如 metaHumanId等）需要从[数字人PaaS 服务](https://doc-zh.zego.im/article/18584)获取。
3. 视频分辨率设置需要考虑实际的显示区域和性能需求。(如果这些参数需要用户传，是否需要根据不同场景设置推荐？才能达到最佳体验)
4. 音频参数调节要在合理范围内，避免影响用户体验。（待定）