import { getPlatformData } from "/snippets/utils-content-parser.js"

export const onUserStatusUpdatedMap = {
  'Android': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~java_android~class~ZIMEventHandler#on-user-status-updated' target='_blank'>onUserStatusUpdated</a>,
  'iOS': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_ios~protocol~ZIMEventHandler#zim-user-status-updated' target='_blank'>userStatusUpdated</a>,
  'mac': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_macos~protocol~ZIMEventHandler#zim-user-status-updated' target='_blank'>userStatusUpdated</a>,
  'window': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~cpp_windows~class~ZIMEventHandler#on-user-status-updated' target='_blank'>onUserStatusUpdated</a>,
  'Flutter': <a href='https://pub.dev/documentation/zego_zim/latest/zego_zim/ZIMEventHandler/onUserStatusUpdated.html' target='_blank'>onUserStatusUpdated</a>,
  'web': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~javascript_web~interface~ZIMEventHandler#user-status-updated' target='_blank'>userStatusUpdated</a>,
}
export const subscribeUsersStatusMap = {
  'Android': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~java_android~class~ZIM#subscribe-users-status' target='_blank'>subscribeUsersStatus</a>,
  'iOS': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_ios~protocol~ZIM#subscribe-users-status-config-callback' target='_blank'>subscribeUsersStatus</a>,
  'mac': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_macos~protocol~ZIM#subscribe-users-status-config-callback' target='_blank'>subscribeUsersStatus</a>,
  'window': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~cpp_windows~class~ZIM#subscribe-users-status' target='_blank'>subscribeUsersStatus</a>,
  'Flutter': <a href='https://pub.dev/documentation/zego_zim/latest/zego_zim/ZIM/subscribeUsersStatus.html' target='_blank'>subscribeUsersStatus</a>,
  'web': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~javascript_web~class~ZIM#subscribe-users-status' target='_blank'>subscribeUsersStatus</a>,
}
export const querySubscribedUserStatusListMap = {
  'Android': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~java_android~class~ZIM#query-subscribed-user-status-list' target='_blank'>querySubscribedUserStatusList</a>,
  'iOS': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_ios~protocol~ZIM#query-subscribed-user-status-list-with-config-callback' target='_blank'>querySubscribedUserStatusListWithConfig</a>,
  'mac': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~objective-c_macos~protocol~ZIM#query-subscribed-user-status-list-with-config-callback' target='_blank'>querySubscribedUserStatusListWithConfig</a>,
  'window': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~cpp_windows~class~ZIM#query-subscribed-user-status-list' target='_blank'>querySubscribedUserStatusList</a>,
  'Flutter': <a href='https://pub.dev/documentation/zego_zim/latest/zego_zim/ZIM/querySubscribedUserStatusList.html' target='_blank'>querySubscribedUserStatusList</a>,
  'web': <a href='https://doc-zh.zego.im/article/api?doc=zim_API~javascript_web~class~ZIM#query-subscribed-user-status-list' target='_blank'>querySubscribedUserStatusList</a>,
}



# 订阅用户在线状态

---

## 功能简介

在一些场景中（如社交聊天、会议等），您可能需要订阅用户的在线状态，判断用户的状态是 在线，离线，还是登出。

本文介绍了如何使用 ZIM SDK 订阅用户在线状态。

## 前提条件

已在项目中集成了 ZIM SDK 并实现了基本收发消息的功能，详情请参考 [快速开始 - 实现基本收发消息](../Send%20and%20receive%20messages.mdx)。

## 获取用户在线状态

有以下两种方式可以获取用户在线状态：
**实时获取用户在线状态**
- userA 通过 {getPlatformData(props,subscribeUsersStatusMap)} 接口订阅了 userB 的在线状态并且监听了 userB 的在线状态更新事件。
- userB 的在线状态更新后（比如用户从在线状态变为离线状态），userA 会收到 {getPlatformData(props,onUserStatusUpdatedMap)} 回调通知获取 userB 最新的在线状态。

**主动查询用户在线状态**
- 通过 {getPlatformData(props,querySubscribedUserStatusListMap)} 接口可以主动查询已订阅用户当前的在线状态。

## 实现方式

### 订阅用户并监听已订阅用户的在线状态变更事件

<Note title="说明">此方法适合实时获取已订阅用户的在线状态。</Note>

通过 {getPlatformData(props,subscribeUsersStatusMap)} 接口订阅需要关注在线状态的用户。

:::if{props.platform=undefined}
```java
ZIMUserStatusSubscribeConfig config = new ZIMUserStatusSubscribeConfig();
config.setSubscriptionDuration(60 * 24); // 1 天
zim.subscribeUsersStatus(Arrays.asList("userIdA", "userIdB"), config, (errorUserList, errorInfo) -> {
    
});

```
:::
:::if{props.platform="iOS|mac"}
```objc
ZIMUserStatusSubscribeConfig *config = [[ZIMUserStatusSubscribeConfig alloc] init];

config.subscriptionDuration = 60 *24; // 订阅持续时间（以分钟为单位），有效范围为1到43200（30天）

[[ZIM getInstance] subscribeUsersStatus:@[@"userIdA",@"userIdB"] //请传入实际需要订阅的用户

                   config:config

                 callback:^(NSArray<ZIMErrorUserInfo *> *_Nonnull errorUserList,

                            ZIMError *_Nonnull errorInfo) {}];
                            
```
:::
:::if{props.platform="window"}
```cpp
ZIMUserStatusSubscribeConfig config;
config.subscriptionDuration = 60 * 24; // 1 天
zim->subscribeUsersStatus({"userIdA", "userIdB"}, config, [](const std::vector<ZIMErrorUserInfo>& errorUserList, const ZIMError& errorInfo){
    
});


```
:::
:::if{props.platform="flutter"}
```dart
final config = ZIMUserStatusSubscribeConfig();
config.subscriptionDuration = 60 * 24;
zim.subscribeUsersStatus(["userIdA", "userIdB"], config).then((errorUserList) {
});

```
:::
:::if{props.platform="web"}
```ts
const config = { subscriptionDuration: 60 * 24 }; // 1 天
zim.subscribeUsersStatus(['userIdA','userIdB'], config)
   .then((errorUserList) => {
       
});
```
:::


监听用户在线状态变更事件，已订阅用户的在线状态变更都将通过 {getPlatformData(props,onUserStatusUpdatedMap)} 返回。
:::if{props.platform=undefined}
```java
// 定义用户在线状态数据
Map<String, ZIMUserStatus> myUserStatusMap = new HashMap<>();

// 用户状态更新回调
public void onUserStatusUpdated(ArrayList<ZIMUserStatus> userStatusList) {
    for (ZIMUserStatus status : userStatusList) {
        myUserStatusMap.put(status.getUserID(), status);
    }
    // TODO: 刷新 UI
}
```
:::
:::if{props.platform="iOS|mac"}
```objc
// 定义用户在线状态数据
NSMutableDictionary<NSString *,ZIMUserStatus *> myUserStatusMap;

// 用户状态更新回调
- (void)zim:(ZIM *)zim userStatusUpdated:(NSArray<ZIMUserStatus *> *)userStatusList {
    for (ZIMUserStatus *userStatus in userStatusList) {
        // 直接用 userID 作为 key，存在则替换，不存在则添加
        myUserStatusList[userStatus.userID] = userStatus;
    }
    //此时可以刷新 UI 或其他操作
}

```
:::
:::if{props.platform="window"}
```cpp
// 定义用户在线状态数据
std::unordered_map<std::string, ZIMUserStatus> myUserStatusMap;

// 用户状态更新回调
void onUserStatusUpdated(const std::vector<ZIMUserStatus>& userStatusList) {
    for (const auto& status : userStatusList) {
        myUserStatusMap[status.userID] = status;
    }
    // TODO: 刷新 UI
};
```
:::
:::if{props.platform="flutter"}
```dart
// 定义用户在线状态数据
final Map<String, ZIMUserStatus> myUserStatusMap = {};

// 用户状态更新回调
ZIMEventHandler.onUserStatusUpdated = (List<ZIMUserStatus> userStatusList) {
  for (var status in userStatusList) {
    myUserStatusMap[status.userID] = status;
  }
  // TODO: 刷新 UI
};
```
:::
:::if{props.platform="web"}
```ts
// 定义用户在线状态数据
const myUserStatusMap: Record<string, ZIMUserStatus> = {};

// 用户状态更新回调
zim.on('userStatusUpdated', (userStatusList: ZIMUserStatus[]) => {
  userStatusList.forEach(status => {
    myUserStatusMap[status.userID] = status;
  });
  // TODO: 刷新 UI
});
```
:::

### 查询用户的在线状态

<Note title="说明">此方法适合单次获取已订阅用户当前的在线状态。</Note>

通过 {getPlatformData(props,querySubscribedUserStatusListMap)} 接口可以主动查询已订阅用户的在线状态。

:::if{props.platform=undefined}
```java
// 查询订阅列表
ZIMSubscribedUserStatusQueryConfig queryConfig = new ZIMSubscribedUserStatusQueryConfig();
queryConfig.setUserIDs(Arrays.asList("userIdA", "userIdB"));
zim.querySubscribedUserStatusList(queryConfig, (userStatusSubscriptionList, errorInfo) -> {
    for (ZIMUserStatusSubscription subscription : userStatusSubscriptionList) {
        myUserStatusMap.put(subscription.getUserStatus().getUserID(), subscription.getUserStatus());
    }
    // TODO: 刷新 UI
});
```
:::
:::if{props.platform="iOS|mac"}
```objc
ZIMSubscribedUserStatusQueryConfig *config = [[ZIMSubscribedUserStatusQueryConfig alloc] init];

// 查询的目标用户ID（单次查询最多200个用户）
// 当userIDs为空时，表示获取完整的订阅表信息
// 当userIDs不为空时，表示检查目标用户是否在订阅列表中
// 如果是，结果回调将包括他们的状态信息
// 如果不是，结果回调将不包括任何相关信息
config.userIDs = @[@"userIdA",@"userIdB"]; //请传入实际需要订阅的用户
```
:::
:::if{props.platform="window"}
```cpp
ZIMSubscribedUserStatusQueryConfig queryConfig;
queryConfig.userIDs = {"userIdA", "userIdB"};
zim->querySubscribedUserStatusList(queryConfig, [&](const std::vector<ZIMUserStatusSubscription>& subscriptions, const ZIMError& errorInfo){
    for (const auto& sub : subscriptions) {
        myUserStatusMap[sub.userStatus.userID] = sub.userStatus;
    }
    // TODO: 刷新 UI
});
```
:::
:::if{props.platform="flutter"}
```dart
// 查询订阅列表
final queryConfig = ZIMSubscribedUserStatusQueryConfig(userIDs: ["userIdA", "userIdB"]);
zim.querySubscribedUserStatusList(queryConfig).then((result) {
  for (var sub in result.userStatusSubscriptionList) {
    myUserStatusMap[sub.userStatus.userID] = sub.userStatus;
  }
  // TODO: 刷新 UI
});
```
:::
:::if{props.platform="web"}
```ts
// 查询订阅列表
const queryConfig = { userIDs: ['userIdA','userIdB'] };
zim.querySubscribedUserStatusList(queryConfig)
   .then(result => {
       result.userStatusSubscriptionList.forEach(sub => {
           myUserStatusMap[sub.userStatus.userID] = sub.userStatus;
       });
       // TODO: 刷新 UI
   });
```
:::


