---
articleID: 4967
---
# 混流
---
articleID: 4967
---
# 混流
- - - 
## 1 功能简介
混流是把多路音视频流从云端混合成单流的技术。

### 1.1 混流优点
1. 降低了开发实现上的复杂性。比如当有 N 个主播进行连麦，如果采用混流，观众端不必同时拉 N 路视频流，开发实现上省去了拉 N 路流并布局的步骤。
2. 降低了对设备的性能要求，减少设备的性能开销和网络带宽的负担。比如当连麦方过多时，观众端需要拉 N 路视频流，需要设备硬件上能支持同时拉 N 路流。
3. 转推多路 CDN 实现简单，只需要在混流配置时按需增加输出流。
4. 观众端需要回放多主播连麦视频时，仅需要在 CDN 上开启录制的配置。
5. 鉴黄时只需要观察一个画面，不必再同时查看多个画面。


### 1.2 应用场景
1. 当设备不支持同时拉 N 路流时使用混流。
2. 需要多个视频画面合成一个视频时使用混流，比如教育类场景，直播老师和学生的画面。

### 1.3 使用说明
主播端和观众端均可主动触发混流。SDK 既支持音视频混流，也支持纯音频混流。  

SDK 对设置混流的时机没有硬性要求，建议开发者在“拉流/推流”后，或根据需求，在其他合适时机进行混流。
  
### 1.4 系统架构图
![](/Pics/iOS/ZegoLiveRoom/ZegoLiveRoom-MixStream/structure.png)


本文档以“主播端/观众端”推流后的混流为例，其他场景下设置混流的步骤类似，不再赘述。

## 2 前提条件

在实现多路混流功能之前，请确保：

@@@Express_Audio_Prerequisites_Web@@@

## 3 使用步骤

<div class="mk-hint">

由于主播端和观众端均可主动触发混流，以下步骤的操作方均为主播端或观众端，请开发者在实际使用中注意区分接口调用方。
</div>

混流的主要流程：

1. 进入房间并推拉流。
2. 开始混流。
3. 将混流成功后的 url 地址通过后台做下发。
4. 观众获取到 url 地址后进行播放。

按照上述流程，SDK API 调用过程如下文所示。

### 3.1 推流
主播端推流后混流的前置条件为推流，请参考 [快速开始 - 实现流程\|_blank](7638#3_3) 的 “3.3 推流”。

#### 3.1.1 混流配置参数

“inputList” 为输入流列表，列表中是 “ZegoMixStreamInfo” 对象。表示流 ID 为 “streamID” 的流，根据所需的输入流个数构建 N 个 “ZegoMixStreamInfo” 放入输入流列表。 

<div class="mk-warning">

- “taskID” 为混流任务 ID，由开发者自定义，须保证是唯一的。  
- SDK对混流画面布局采用输入流列表中的输入流排序，按照叠放的方式布局，为了避免大布局遮挡小布局，将输入流信息放进列表时需将大布局的输入流排在小布局输入流前面。例如，想在 A 布局上放置一个小布局 B，输入流列表就应写 `ZegoMixStreamInfo[] inputStreamInfo = {streamInfoA, streamInfoB}`。  
</div>

“ZegoMixStreamInfo” 的使用示例：

假设指定某条流的左上角坐标为 (50, 300)，右下角坐标为 (200, 450)，这条流在最终的输出混流中的位置如下图所示：
![](/Pics/iOS/ZegoLiveRoom/ZegoLiveRoom-MixStream/mixStreamInfo.png)


``` javascript
 /**
     *  原点在左上角，top/bottom/left/right 定义如下：
     *
     *  (left, top)-----------------------
     *  |                                |
     *  |                                |
     *  |                                |
     *  |                                |
     *  -------------------(right, bottom)
     */

const streamList = [
    {
        streamID: publishStreamId,
        layout: {
            top: 0,
            left: 0,
            bottom: 240,
            right: 320,
        },
    },
];
if (useLocalStreamList.length !== 0) {
    streamList.push({
        streamID: useLocalStreamList[0].streamID,
        layout: {
            top: 240,
            left: 0,
            bottom: 480,
            right: 320,
        },
    });
}

```
<div class="mk-hint">

“streamList” 里的一个元素为输入流的参数配置，包括了 “streamID” 和“布局”，布局 “layout” 包括了 “top”、“left”、“bottom”、“right”。   
</div>


#### 3.1.2 输出流类型

在混流参数 “outputList” 中，输出流的 target 可为流名 “streamID” 或 “url”。如果需要将流推到 CDN 上，采用 “url”；不需要将流推到 CDN 上时，由调用者决定采用 “url” 或者 “streamID”。

### 3.2 开始混流

在推流成功后，调用 [startMixerTask|_blank](/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#start-mixer-task) 将混流配置发送至 ZEGO 混流服务器，并触发混流。

<div class="mk-warning">

当混流信息发生变更（例如：混流的输入流列表发生增减、调整混流视频输出码率等），开发者需要在合适的时机调用本接口，更新 ZEGO 混流服务器上的混流配置。 
</div>

```javascript
try {
    const streamList = [
        {
            streamID: publishStreamId,
            contentType: '',
            layout: {
                top: 0,
                left: 0,
                bottom: 240,
                right: 320,
            },
        },
    ];
    if (useLocalStreamList.length !== 0) {
        streamList.push({
            streamID: useLocalStreamList[0].streamID,
            contentType: '',
            layout: {
                top: 240,
                left: 0,
                bottom: 480,
                right: 320,
            },
        });
    }

    const res = await zg.startMixerTask({
        taskID,
        inputList: streamList,
        outputList: [{
                target: this.data.mixStreamID,
        }],
        outputConfig: {
            outputBitrate: 300,
            outputFPS: 15,
            outputWidth: 320,
            outputHeight: 480,
        },
    });
    if (res.errorCode == 0) {
        $('#stopMixStream').removeAttr('disabled');
        const result = JSON.parse(res.extendedData).mixerOutputList;
        if (
            navigator.userAgent.indexOf('iPhone') !== -1 &&
            getBrowser() == 'Safari' &&
            result &&
            result[0].hlsURL
        ) {
            hlsUrl = result[0].hlsURL.replace('http', 'https');
            mixVideo.src = hlsUrl;
        } else if (result && result[0].flvURL) {
            const flvUrl = result[0].flvURL.replace('http', 'https');
            console.log('mixStreamId: ' + mixStreamID);
            console.log('mixStreamUrl:' + flvUrl);
            alert('混流开始。。。');
            if (flvjs.isSupported()) {
                flvPlayer = flvjs.createPlayer({
                    type: 'flv',
                    url: flvUrl,
                });
                flvPlayer.attachMediaElement(mixVideo);
                flvPlayer.load();
            }
        }
        mixVideo.muted = false;
    }

    $('#mixVideo').css('display', '');
} catch (err) {
    alert('混流失败。。。');
    console.error('err: ', err);
}
```

<div class="mk-hint">

如果要混流纯音频数据，部分参数配置需要特殊处理：

- 输入流 “inputList” 纯音频配置规则：“top”、“left”、“bottom”、“right” 不能全设置为 “0”，或全设置为 “1”。推荐配置：“top = 0, left = 0, bottom = 1, right = 1”。
- “outputConfig” 纯音频配置规则：“outputFPS”、“outputBitrate” 不能设置为 “0”。推荐配置：“outputFPS = 1, outputBitrate = 1, outputResolution = (1,1)”。 
</div>


### 3.3 混流配置更新通知

混流请求发送成功后，调用者可在成功回调中获取混流配置的结果及混流 ID。

<div class= 'mk-warning'>

更新混流任务的配置时，“taskID” 不可更改。 
</div>

常见错误码及含义如下：

错误码 | 说明
-----|------
 errorCode = 150 | 混流的输入流不存在，请检查输入流是否正常。
 errorCode = 151 | 混流失败，请检查混流流程是否处理正常。
 errorCode = 152 | 停止混流失败，请检查混流流程是否处理正常。
 errorCode = 153 | 输入参数错误，请检查输入参数是否正确。
 errorCode = 154 | 输出参数错误，请检查输出参数是否正确。
 errorCode = 155 | 输入分辨率格式错误，请检查输入分辨率格式是否正确。
 errorCode = 156 | 输出分辨率格式错误，请检查输出分辨率格式是否正确。
 errorCode = 157 | 混流没开，请检查是否开启混流模式。


### 3.4 停止混流

停止混流是通过调用 [stopMixerTask\|_blank](@stopMixerTask) 实现。

<div class="mk-warning">

开始混流和停止混流使用的 “taskID” 需要保持一致。 
</div>

```javascript
try {
    await zg.stopMixerTask(taskID);
    alert('停止混流成功。。。');
    if (flvPlayer) {
        flvPlayer.destroy();
        flvPlayer = null;
    }
    console.log('stopMixStream success: ');
    $('#stopMixStream').attr('disabled', 'disabled');
    $('#mixVideo').css('display', 'none');
} catch (err) {
    alert('停止混流失败。。。');
    console.log('stopMixStream err: ', err);
}
```
