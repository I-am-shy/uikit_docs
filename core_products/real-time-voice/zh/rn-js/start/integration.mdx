# 实现流程  

---
@@@Common_usage_introduction@@@
## 2 前提条件  

在实现基本的实时音视频功能之前，请确保：  
- 已在项目中集成 ZEGO Express SDK，详情请参考 [快速开始 - 集成](#4835)。
- 已在 [ZEGO 控制台\|_blank](https://console.zego.im) 创建项目，申请有效的 AppID 和 AppSign，详情请参考 [控制台 - 项目管理\|_blank](#1265)。


## 3 使用步骤 

以用户 A 拉取用户 B 的流为例，流程如下图：

![/Pics/Common/ZegoExpressEngine/common_usage.png](http://doc.oa.zego.im/Pics/Common/ZegoExpressEngine/common_usage.png)

整个推拉流过程的 API 调用时序如下图：

<img src="/Pics/QuickStart/quickstart_uml_react.png" alt="时序图">

### 3.1 创建引擎 

**1. 创建界面（可选）**

<details class="zg-primary">
    <summary>添加界面元素</summary>

在创建引擎之前，ZEGO 推荐开发者添加以下界面元素，方便实现基本的实时音视频功能。

- 本地预览窗口
- 远端视频窗口
- 结束按钮

<img src="/Pics/QuickStart/UI.jpg" alt="界面图">



</details>  

**2. 创建引擎** 

调用 [createEngine \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#createengine) 接口，将申请到的 AppID 和 AppSign 分别传入参数 “appID” 和 “appSign”，创建引擎。


如果需要注册回调方法，开发者可根据实际需要，实现 [ZegoEventListener](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html) 中的某些方法，创建引擎后可通过调用 [on](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#on) 接口设置回调。

@@@Express_isTestEnv@@@

```javascript
// 导入
import ZegoExpressEngine from 'zego-express-engine-reactnative';

const appID = ;  // 请通过官网注册获取，格式为：1234567890
const appSign = ;  //请通过官网注册获取，格式为：'0123456789012345678901234567890123456789012345678901234567890123'（共64个字符）

// 创建引擎，使用测试环境，通用场景接入
ZegoExpressEngine.createEngine(appID, appSign, true, 0);
```

</details>

### 3.2 登录房间

**1. 登录**  

传入用户 ID 参数 “userID” 创建 ZegoUser 用户对象后，调用 [loginRoom \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口，传入房间 ID 参数 “roomID” 和用户参数 “user”，登录房间。

<div class="mk-warning">
    
1. 同一个AppID内，需保证 “roomID” 全局唯一。  
2. 同一个AppID内，需保证 “userID” 全局唯一，建议开发者将其设置为一个有意义的值，可将 “userID” 与自己业务账号系统进行关联。   
3. “userID” 与 “userName” 不能为 “nil”，否则会导致登录房间失败。  

</div>

```javascript
// 开始登录房间
ZegoExpressEngine.instance().loginRoom('room1', {'userID': 'id1', 'userName': 'user1'});
```

**2. 监听登录房间后的事件回调** 

可根据实际应用需要，在登录房间后监听想要关注的事件通知，比如房间状态更新、用户状态更新、流状态更新等。
- [roomStateUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstateupdate)：房间状态更新回调，登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK 会通过该回调通知。
- [roomUserUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate)：用户状态更新回调，登录房间后，当房间内有用户新增或删除时，SDK 会通过该回调通知。

    只有调用 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口登录房间时传入 [ZegoRoomConfig\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressdefines_.zegoroomconfig.html) 配置，且 “isUserStatusNotify” 参数取值为 “true” 时，用户才能收到 [onRoomUserUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate) 回调。

- [roomStreamUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstreamupdate)：流状态更新回调，登录房间后，当房间内有用户新推送或删除音视频流时，SDK 会通过该回调通知。

<div class="mk-warning">

- 只有调用 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#loginroom) 接口登录房间时传入 [ZegoRoomConfig\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressdefines_.zegoroomconfig.html) 配置，且 “isUserStatusNotify” 参数取值为 “true” 时，用户才能收到 [onRoomUserUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomuserupdate) 回调。
- 通常情况下，如果某个用户想要播放其他用户推送的视频，可以在收到流状态更新（新增）的回调中，调用 [startPlayingStream\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startplayingstream) 接口拉取远端推送的音视频流。
</div>

```javascript

// 以下为常用的房间相关回调

ZegoExpressEngine.instance().on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
  // 房间状态更新回调，登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK会通过该回调通知
}); ;


ZegoExpressEngine.instance().on('roomUserUpdate', (roomID, updateType, userList) => {
  // 用户状态更新，登录房间后，当房间内有用户新增或删除时，SDK会通过该回调通知
});

ZegoExpressEngine.instance().on('roomStreamUpdate', (roomID, updateType, streamList) => {
  // 流状态更新，登录房间后，当房间内有用户新推送或删除音视频流时，SDK会通过该回调通知
});

```

### 3.3 推流

**1. 开始推流**

调用 [startPublishingStream \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startpublishingstream) 接口，传入流 ID 参数 “streamID”，向远端用户发送本端的音视频流。

<div class="mk-warning"> 
    
同一个 AppID 内，需保证 “streamID” 全局唯一。如果同一个 AppID 内，不同用户各推了一条 “streamID” 相同的流，会导致后推流的用户推流失败。  
</div>

```javascript
/** 开始推流 */
ZegoExpressEngine.instance().startPublishingStream("streamID");
```

**2. 启动本地预览（可选）**

<details class="zg-primary">
    <summary>设置预览视图并启动本地预览</summary> 

如果希望看到本端画面，可调用 [startPreview \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startpreview) 接口设置预览视图，并启动本地预览。

```javascript
import { findNodeHandle } from 'react-native';

// 取一个react 的 ref
let localViewRef = findNodeHandle(this.refs.zego_preview_view);

// 启动本地预览
ZegoExpressEngine.instance().startPreview({
    'reactTag': localViewRef,
    'viewMode': 0,
    'backgroundColor': 0
});

// react render
render() {
    return (
        <View>
            <ZegoTextureView ref='zego_preview_view'/>
        </view>
    )
}
```
</details>

**3. 监听推流后的事件回调** 

根据实际应用需要，在推流后监听想要关注的事件通知，比如推流状态更新等。

[PublisherStateUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#publisherstateupdate)：推流状态更新回调，调用推流接口成功后，当推流状态发生变更，如出现网络中断导致推流异常等情况，SDK 在重试推流的同时，会通过该回调通知。

```javascript
    ZegoExpressEngine.instance().on("PublisherStateUpdate", (streamID, state, errorCode, extendedData) => {
    // 调用推流接口成功后，当推流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试推流的同时，会通过该回调通知
    //....
});
```
 

### 3.4 拉流  

**1. 开始拉流**  

调用 [startPlayingStream \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#startplayingstream) 接口，根据传入的流 ID 参数 “streamID”，拉取远端推送的音视频流。

远端用户推送的 “streamID” 可以从 [onRoomStreamUpdate](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstreamupdate) 回调中获取。

<div class="mk-warning">
    
需保证 “streamID” 全局唯一。

</div>

```javascript
import { findNodeHandle } from 'react-native';

// 取一个react 的 ref
let remoteViewRef = findNodeHandle(this.refs.zego_play_view);

// 开始拉流
ZegoExpressEngine.instance().startPlayingStream("streamID", {
    'reactTag': remoteViewRef,
    'viewMode': 0,
    'backgroundColor': 0
});

// react render
render() {
    return (
        <View>
            <ZegoTextureView ref='zego_play_view'/>
        </view>
    )
}

```

**2. 监听拉流后的事件回调** 

根据实际应用需要，在拉流后监听想要关注的事件通知，比如拉流状态更新等。

[PlayerStateUpdate\|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#playerstateupdate)：拉流状态更新回调，调用拉流接口成功后，当拉流状态发生变更，如出现网络中断导致推流异常等情况，SDK 在重试拉流的同时，会通过该回调通知。

```javascript
ZegoExpressEngine.instance().on("PlayerStateUpdate", (streamID, state, errorCode, extendedData) => {
    /** 调用拉流接口成功后，当拉流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试拉流的同时，会通过该回调通知 */
    //....
});
```

### 3.5 体验实时音视频功能

@@@Experience_Real-time_Audio_and_Video_Functions@@@


### 3.6 停止推拉流

**1. 停止推流/预览**

调用 [stopPublishingStream \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#stoppublishingstream) 接口停止发送本地的音视频流，结束通话。

```javascript
/** 停止推流 */
ZegoExpressEngine.instance().stopPublishingStream();
```

如果启用了本地预览，开发者可以在停止推流后根据业务需要调用 [stopPreview \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#stoppreview) 接口停止预览。

```javascript
// 停止本地预览
ZegoExpressEngine.instance().stopPreview();

```

**2. 停止拉流**

调用 [stopPlayingStream \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#stopplayingstream) 接口，停止拉取远端的音视频流。

```javascript
// 停止拉流
ZegoExpressEngine.instance().stopPlayingStream("streamID");

```


**3. 退出房间**  

调用 [logoutRoom \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#logoutroom) 接口退出房间，本端会收到 [onRoomStateUpdate \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/interfaces/_zegoexpresseventhandler_.zegoeventlistener.html#roomstateupdate) 回调通知调用结果，并停止其所有推拉流以及本地预览。


```javascript
// 退出房间
ZegoExpressEngine.instance().logoutRoom('room1');
```

### 3.7 销毁引擎

调用 [destroyEngine \|_blank](/unique-api/express-video-sdk/zh/javascript_react-native/classes/_zegoexpressengine_.zegoexpressengine.html#destroyengine) 接口销毁引擎，用于释放 SDK 使用的资源。


```javascript
ZegoExpressEngine.destroyEngine();
```

<div class="mk-hint">

根据实际需要，可在销毁引擎时通过 “await” 关键字，进行异步等待以确保设备硬件资源被释放完成。   
</div>
