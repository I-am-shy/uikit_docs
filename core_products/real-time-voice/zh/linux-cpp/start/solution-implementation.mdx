# 实现音频通话
---
articleID: 8228
---
# 实现音频通话

---
@@@Common_usage_introduction@@@

## 2 前提条件

在实现基本的音频通话之前，请确保：

@@@Express_Video_Implementation_Process_Prerequisites@@@

## 3 使用步骤

以用户 A 拉取用户 B 的流为例，流程如下图：

![/Pics/Common/ZegoExpressEngine/common_usage.png](http://doc.oa.zego.im/Pics/Common/ZegoExpressEngine/common_usage_new.png)



整个推拉流过程的 API 调用时序如下图：

<img src="/Pics/QuickStart/quickstart_uml_audio.png" alt="时序图" width="80%">

<a id="CreateEngine"> </a>  

### 3.1 创建引擎

**1. 引入头文件**

在项目中引入 ZegoExpressEngine 头文件。

```C++
#include "ZegoExpressSDK.h"
using namespace ZEGO::EXPRESS;
```

**2. 创建引擎**
     
调用 [createEngine ](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-zego-express-sdk#create-engine) 接口，将申请到到 AppID 传入参数 “appID”。

根据 App 实际的音视频业务选择一个合适的场景，请参考 [场景化音视频配置](!video_proflie) 文档，把选择好的场景枚举传入参数 "scenario"。


```C++
ZegoEngineProfile profile;
// 和 AppSign 由 ZEGO 分配给各 App；其中，为了安全考虑，建议将 AppSign 存储在 App 的业务后台，需要使用时从后台获取
profile.appID = appID;
profile.appSign = appSign;
profile.scenario = ZegoScenario::ZEGO_SCENARIO_BROADCAST;
// 创建引擎实例
auto engine = ZegoExpressSDK::createEngine(profile, nullptr);
```  

**3. 关闭摄像头**

<div class="mk-warning">

Express Linux SDK 不提供裁剪了视频模块的纯音频包，因此 Linux “实时语音” SDK 实际上是 “实时音视频” SDK。

</div>

若要实现纯音频场景，请在创建引擎后调用 [enableCamera](@enableCamera) 关闭摄像头，以避免启动引擎的视频模块。摄像头关闭后，将不需要再申请摄像头权限，并且不会推视频流。

```cpp
engine->enableCamera(false);
```

更多信息请参考文档 [实时音视频 SDK 与实时语音 SDK 的差异](!SDK_difference_audio)。

若您对 Express Linux SDK 包体大小有较高要求，可联系技术支持进行定制裁包，关于 SDK 包大小数据请参考 [概述](!Overview/Overview) 文档。


**4. 设置回调**

您可以通过实例化实现 [IZegoEventHandler ](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler) 接口的类，并实现需要的回调方法，以监听并处理所关注的事件回调。然后将实例化对象作为`eventHandler`参数传递给 [createEngine ](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-zego-express-sdk#create-engine) 或者传递给 [setEventHandler ](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#set-event-handler) 注册回调。

<div class="mk-warning">

建议在创建引擎时或创建引擎后就立即注册回调，避免延后注册错过事件通知。
</div>


### 3.2 登录房间  

**1. 登录**

传入用户 ID 参数 “userID” 和 “userName” 创建 ZegoUser 用户对象后，调用 [loginRoom](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#login-room)，传入房间 ID 参数 “roomID” 和用户参数 “user”，登录房间。如果房间不存在，调用该接口时会创建并登录此房间。 

- 同一个 AppID 内，需保证 “roomID” 全局唯一。  
- 同一个 AppID 内，需保证 “userID” 全局唯一，建议开发者将其设置成一个有意义的值，可将 “userID” 与自己业务账号系统进行关联。  
- “userID” 不能为空，否则会导致登录房间失败。  


```C++
// 创建用户对象
ZegoUser user("user1", "user1");
// 只有传入 “isUserStatusNotify” 参数取值为 “true” 的 ZegoRoomConfig，才能收到 onRoomUserUpdate 回调。
ZegoRoomConfig roomConfig;
// 如果您使用 appsign 的方式鉴权，token 参数不需填写；如果需要使用更加安全的 鉴权方式： token 鉴权，请参考[如何从 AppSign 鉴权升级为 Token 鉴权](https://doc-zh.zego.im/faq/token_upgrade?product=ExpressVideo&platform=all)
// roomConfig.token = "xxxx";
roomConfig.isUserStatusNotify = true;
// 登录房间
engine->loginRoom(roomID, user, roomConfig, [=](){
    // (可选回调) 登录房间结果，如果仅关注登录结果，关注此回调即可
});
```

**2. 监听登录房间后的事件回调**

根据实际需要，在登录房间后监听想要关注的事件通知，比如房间状态更新、用户状态更新、流状态更新等。  
- [onRoomStateChanged](@onRoomStateChanged)：房间状态更新回调。登录房间后，当房间连接状态发生变更（如出现房间断开，登录认证失败等情况），SDK 会通过该回调通知。
- [onRoomUserUpdate](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-room-user-update)：用户状态更新回调。登录房间后，当房间内有用户新增或删除时，SDK 会通过该回调通知。

    @@@Notes_on_onRoomUserUpdate@@@

- [onRoomStreamUpdate](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-room-stream-update)：流状态更新回调。登录房间后，当房间内有用户新推送或删除音视频流时，SDK 会通过该回调通知。

<div class="mk-warning">

- 只有调用 [loginRoom](@loginRoom) 接口登录房间时传入 [ZegoRoomConfig](@-ZegoRoomConfig) 配置，且 “isUserStatusNotify” 参数取值为 “true” 时，用户才能收到 [onRoomUserUpdate](@onRoomUserUpdate) 回调。
- 通常情况下，如果某个用户想要播放其他用户推送的视频，可以在收到流状态更新（新增）的回调中，调用 [startPlayingStream](@startPlayingStream) 接口拉取远端推送的音视频流。
- 请注意，请勿在 SDK 回调线程中调用任何 SDK 接口，需要手动切换为其他线程，否则会产生死锁。
</div>

```C++
// 房间状态更新回调
void onRoomStateChanged(const std::string &roomID, ZegoRoomStateChangedReason reason, int errorCode, const std::string &extendedData) {
    if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_LOGINING)
    {
        // 登录中
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_LOGINED)
    {
        // 登录成功
        // 请注意，请勿在 SDK 回调线程中调用任何 SDK 接口，需要手动切换为其他线程，否则会产生死锁
        // 只有当房间状态是登录成功或重连成功时，推流（startPublishingStream）、拉流（startPlayingStream）才能正常收发音视频
        //将自己的音视频流推送到 ZEGO 音视频云
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_LOGIN_FAILED)
    {
        // 登录失败
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_RECONNECTING)
    {
        // 重连中
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_RECONNECTED)
    {
        // 重连成功
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_RECONNECT_FAILED)
    {
        // 重连失败
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_KICK_OUT)
    {
        // 被踢出房间
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_LOGOUT)
    {
        // 登出成功
    }
    else if(reason == ZEGO_ROOM_STATE_CHANGED_REASON_LOGOUT_FAILED)
    {
        // 登出失败
    }
}

// 用户状态更新回调
void onRoomUserUpdate(const std::string& roomID, ZegoUpdateType updateType, const std::vector<ZegoUser>& userList) override {
    // 根据需要实现事件回调
}

// 流状态更新回调
void onRoomStreamUpdate(const std::string& roomID, ZegoUpdateType updateType, const std::vector<ZegoStream>& streamList, const std::string& extendedData) override {
    // 根据需要实现事件回调    
}
```

<a id="publishingStream"></a> 

### 3.3 推流

**1. 开始推流**  
      
调用 [startPublishingStream](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#start-publishing-stream)，传入流 ID 参数 “streamID”，向远端用户发送本端的音视频流。 

<div class="mk-warning">

- 同一个 AppID 内，需保证 “streamID” 全局唯一。如果同一个 AppID 内，不同用户各推了一条 “streamID” 相同的流，会导致后推流的用户推流失败。
- 开始推流前，建议开发者先对推流参数进行配置。如果没有配置，SDK 将采用默认配置。SDK 支持丰富的推流参数配置，主要包含：视频帧率、码率、分辨率、音频码率等。
</div>

```C++
// 开始推流
engine->startPublishingStream("streamID");
```

**2. 监听推流后的事件回调**

根据实际应用需要，在推流后监听想要关注的事件通知，比如推流状态更新等。

[onPublisherStateUpdate](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-publisher-state-update)：推流状态更新回调。调用推流接口成功后，当推流状态发生变更（如出现网络中断导致推流异常等情况），SDK 在重试推流的同时，会通过该回调通知。


```C++
// 推流状态更新回调
virtual void onPublisherStateUpdate(const std::string& streamID, ZegoPublisherState state, int errorCode, const std::string& extendedData) {
    // 根据需要实现事件回调
}
```


### 3.4 拉流  
  
**1. 开始拉流**  
  
调用 [startPlayingStream](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#start-playing-stream) 接口，根据传入的流 ID 参数 “streamID”，拉取远端推送的音视频流。

远端用户推送的 “streamID” 可以从 [ZegoEventHandler](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler) 中的 [onRoomStreamUpdate](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-room-stream-update) 回调中获得。

```C++
// 开始拉流
engine->startPlayingStream("streamID", nullptr);
```

**2. 监听拉流后的事件回调**

根据实际应用需要，在拉流后监听想要关注的事件通知，比如拉流状态更新等。

[onPlayerStateUpdate](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-event-handler#on-player-state-update)：拉流状态更新回调。调用拉流接口成功后，当拉流状态发生变更（如出现网络中断导致推流异常等情况），SDK 在重试拉流的同时，会通过该回调通知。

```C++
// 拉流状态变更回调
virtual void onPlayerStateUpdate(const std::string& streamID, ZegoPlayerState state, int errorCode, const std::string& extendedData) {
    // 根据需要实现事件回调
}
```

### 3.5 体验实时音视频功能

@@@New_Experience_RTC_Functions@@@


### 3.6 停止推拉流

**1. 停止推流**  

调用 [stopPublishingStream](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#stop-publishing-stream) 停止向远端用户发送本端的音视频流。    

```C++
// 停止推流
engine->stopPublishingStream();
```     

**2. 停止拉流**  

调用 [stopPlayingStream](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#stop-playing-stream) 停止拉取远端推送的音视频流。

@@@Express_stopPlayingStream_time@@@

```C++
// 停止拉流
engine->stopPlayingStream("streamID");
```


### 3.7 退出房间

调用 [logoutRoom](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-i-zego-express-engine#logout-room) 接口退出房间。

```C++
// 退出房间
engine->logoutRoom("roomID");
```

### 3.8 销毁引擎

调用 [destroyEngine](/zh/api?doc=Express_Video_SDK_API~CPP_linux~class~zego-express-zego-express-sdk#destroy-engine) 接口销毁引擎，用于释放 SDK 使用的资源。

- 如果需要监听回调，来确保设备硬件资源释放完成，可在销毁引擎时传入 “callback”。该回调只用于发送通知，开发者不可以在回调内释放与引擎相关的资源。

- 如果不需要监听回调，可传入 “nullptr”。

```C++
// 销毁引擎实例
ZegoExpressSDK::destroyEngine(engine, nullptr);
```
