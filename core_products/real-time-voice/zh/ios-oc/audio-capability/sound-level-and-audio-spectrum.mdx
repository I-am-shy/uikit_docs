# 音频频谱与音量变化
---
articleID: 5075
---
# 音频频谱与音量变化

- - -

## 1 功能简介

- 音量变化：指某条流的音量大小，下文简称为“声浪”。
  
    主要应用场景，在推拉流过程中，判断麦上的用户谁在说话，并做 UI 展示，例如：
    <img src="/Pics/Android/ZegoLiveRoom/SoundLevel.png">

- 音频频谱：即数字音频信号在各频点的能量值。

    主要应用场景，在主播 K 歌场景中，已经推流或拉流的前提下，让主播或观众看到音调与音量变化的动画，例如：
    <img src="/Pics/Android/ZegoLiveRoom/FrequencySpectrum.png" >

## 2 示例源码下载

请参考 [下载示例源码](#3126) 获取源码。

相关源码请查看 “/ZegoExpressExample/Topics/SoundLevel” 目录下的文件。


## 3 前提条件

在实现音频频谱与声浪功能之前，请确保：

@@@Express_Audio_Prerequisites@@@

## 4 使用步骤

### 4.1 监听声浪与音频频谱的回调接口

- 接口原型

    - 本地采集的声浪回调接口：

        ```objc
        /// 本地采集音频声浪回调
        ///
        /// @param soundLevel 本地采集的声浪值，取值范围为 0.0 ~ 100.0
        - (void)onCapturedSoundLevelUpdate:(NSNumber *)soundLevel;
        ```

    - 远端音频声浪回调接口：
    
        ```objc
        /// 远端音频声浪回调
        ///
        /// @param soundLevels 远端的声浪键值对，key 为流 ID，value 为对应的流的声浪值，value 取值范围为 0.0 ~ 100.0
        - (void)onRemoteSoundLevelUpdate:(NSDictionary<NSString *, NSNumber *> *)soundLevels;
        ```

    - 本地采集的音频频谱回调接口：

        ```objc
        /// 本地采集音频频谱回调
        ///
        /// @param audioSpectrum 本地采集的音频频谱值数组，频谱值范围为 [0-2^30]
        - (void)onCapturedAudioSpectrumUpdate:(NSArray<NSNumber *> *)audioSpectrum;
        ```

    - 远端拉流音频频谱回调接口：

        ```objc
        /// 远端拉流音频频谱回调
        ///
        /// @param audioSpectrums 远端音频频谱键值对，key 是流 ID，value 为对应的流的音频频谱值数组，频谱值范围为 [0-2^30]
        - (void)onRemoteAudioSpectrumUpdate:(NSDictionary<NSString *, NSArray<NSNumber *> *> *)audioSpectrums;
        ```

- 调用示例

    远端拉流声浪和远端音频频谱的回调给的是 NSDictionary，“key” 是当前房间内正在推流的其他用户的流 ID，“value” 是对应这条流的声浪/音频频谱数据。

    可先通过 [onRoomStreamUpdate ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~protocol~zego-event-handler#on-room-stream-update-stream-list-room-id) 回调方法获取到当前房间内存在的流列表并保存起来，然后通过保存的流列表来索引 NSDictionary 取得每条流对应的声浪/音频频谱数据。

    以下示例将掩饰如何从回调方法中获取到声浪/音频频谱的数据并传递给 UI。具体上下文请参考示例源码中 “/ZegoExpressExample-iOS-OC/Topics/SoundLevel” 目录下的文件。

    ```objc
    // Sound level callback for local stream
    - (void)onCapturedSoundLevelUpdate:(NSNumber *)soundLevel {
        ZGSoundLevelTableViewCell *cell = [self.tableView cellForRowAtIndexPath:[NSIndexPath indexPathForRow:0 inSection:0]];
        cell.soundLevel = soundLevel;
    }

    // Sound level callback for remote streams, key is stream ID, value is the sound level data corresponding to stream ID
    - (void)onRemoteSoundLevelUpdate:(NSDictionary<NSString *,NSNumber *> *)soundLevels {
        NSInteger rowCount = [self.tableView numberOfRowsInSection:1];
        for (NSInteger row = 0; row < rowCount; row++) {
            ZGSoundLevelTableViewCell *cell = [self.tableView cellForRowAtIndexPath:[NSIndexPath indexPathForRow:row inSection:1]];
            if ([soundLevels objectForKey:cell.streamID]) {
                cell.soundLevel = soundLevels[cell.streamID];
            }
        }
    }

    // Audio frequency spectrum callback for local stream
    - (void)onCapturedAudioSpectrumUpdate:(NSArray<NSNumber *> *)audioSpectrum {
        ZGSoundLevelTableViewCell *cell = [self.tableView cellForRowAtIndexPath:[NSIndexPath indexPathForRow:0 inSection:0]];
        cell.spectrumList = audioSpectrum;
    }

    // Audio frequency spectrum callback for remote streams, key is stream ID, value is the spectrum data corresponding to stream ID
    - (void)onRemoteAudioSpectrumUpdate:(NSDictionary<NSString *,NSArray<NSNumber *> *> *)audioSpectrums {
        NSInteger rowCount = [self.tableView numberOfRowsInSection:1];
        for (NSInteger row = 0; row < rowCount; row++) {
            ZGSoundLevelTableViewCell *cell = [self.tableView cellForRowAtIndexPath:[NSIndexPath indexPathForRow:row inSection:1]];
            if ([audioSpectrums objectForKey:cell.streamID]) {
                cell.spectrumList = audioSpectrums[cell.streamID];
            }
        }
    }
    ```

### 4.2 启动监听音频频谱与声浪的回调的开关

可分别针对音频频谱或声浪，调用启动监听对应回调的接口。

- 启动声浪的监听：

    ```objc
    /// 启动声浪监控
    ///
    - (void)startSoundLevelMonitor;
    ```

    在调用上述接口之后，[onCapturedSoundLevelUpdate](@onCapturedSoundLevelUpdate) 回调方法会立刻触发，未推流时的回调值为 0；[onRemoteSoundLevelUpdate](@onRemoteSoundLevelUpdate) 需要在调用 [startPlayingStream](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-playing-stream-canvas) 开始拉流接口之后，才会有回调。

- 启动频谱的监听：

    ```objc
    /// 启动音频频谱监控
    ///
    - (void)startAudioSpectrumMonitor;
    ```

    在调用上述接口之后，[onCapturedAudioSpectrumUpdate](@onCapturedAudioSpectrumUpdate) 回调方法会立刻触发，未推流时的回调值为 0；[onRemoteAudioSpectrumUpdate](@onRemoteAudioSpectrumUpdate) 需要在调用 [startPlayingStream ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-playing-stream-canvas) 开始拉流接口之后，才会有回调。

### 4.3 停止监听音频频谱与声浪的回调的开关

可分别针对音频频谱或声浪，调用停止监听对应回调的开关。

- 停止声浪的监听:

    ```objc
    /// 停止声浪监控
    ///
    - (void)stopSoundLevelMonitor;
    ```

    在调用上述接口之后，[onCapturedSoundLevelUpdate](@onCapturedSoundLevelUpdate) 与 [onRemoteSoundLevelUpdate](@onRemoteSoundLevelUpdate) 不再回调。

- 停止频谱的监听:

    ```objc
    /// 停止音频频谱监控
    ///
    - (void)stopAudioSpectrumMonitor;
    ```

    在调用上述接口之后，[onCapturedAudioSpectrumUpdate](@onCapturedAudioSpectrumUpdate) 与 [onRemoteAudioSpectrumUpdate](@onRemoteAudioSpectrumUpdate) 将不再回调。

## 5 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [startSoundLevelMonitor ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-sound-level-monitor) | 启动声浪监控 |
| [stopSoundLevelMonitor ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#stop-sound-level-monitor) | 停止声浪监控 |
| [startAudioSpectrumMonitor ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-audio-spectrum-monitor) | 启动音频频谱监控 |
| [stopAudioSpectrumMonitor ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#stop-audio-spectrum-monitor) | 停止音频频谱监控 |
| [onCapturedSoundLevelUpdate ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~protocol~zego-event-handler#on-captured-sound-level-update) | 本地采集音频声浪回调 |
| [onRemoteSoundLevelUpdate ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~protocol~zego-event-handler#on-remote-sound-level-update) | 远端音频声浪回调接口 |
| [onCapturedAudioSpectrumUpdate](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~protocol~zego-event-handler#on-captured-audio-spectrum-update) | 本地采集频谱回调 |
| [onRemoteAudioSpectrumUpdate](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~protocol~zego-event-handler#on-remote-audio-spectrum-update) | 远端音频频谱回调接口 |

## 6 常见问题

1. **开启了声浪和频谱的监控开关之后，为什么没有收到相关回调？**

    本地采集的回调会立刻触发，未推流时的回调值为 0；远端拉流的回调在拉流[startPlayingStream ](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-playing-stream-canvas)成功之后才会触发。
