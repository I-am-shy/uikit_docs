# 自定义音频采集与渲染

- - -

## 1 功能简介

### 1.1 自定义音频采集

以下场景中，建议使用自定义音频采集功能：

- 开发者需要从现有音频流、音频文件、或者定制的采集系统中获得采集后输入，交给 SDK 传输。
- 开发者有自己对 PCM 输入源做特殊的音效处理的需求，在音效处理后输入，交给 SDK 传输。

### 1.2 自定义音频渲染

当开发者有自己渲染的需求，例如对拉取到的原始 PCM 数据做特殊应用或者处理后再渲染，建议使用 SDK 的自定义音频渲染功能。


<div class = 'mk-warning'>

- 自定义音频采集和渲染是一体的，启用该功能后开发者需要同时实现音频采集和渲染功能。
- 开发者采用外部采集和渲染后，SDK 内部不负责声音增强、噪音抑制、回音消除等功能，需要开发者自行实现。
</div>


## 2 示例源码下载

请参考 [下载示例源码\|_blank](#3126) 获取源码。

相关源码请查看 “/ZegoExpressExample/Topics/CustomAudioIO” 目录下的文件。

## 3 前提条件

在实现自定义音频采集与渲染之前，请确保：

@@@Express_Audio_Prerequisites@@@


## 4 使用步骤

### 4.1 初始化 SDK

请参考 [快速开始 - 实现流程\|_blank](7628#2_1) 的 “2.1 创建引擎”。

### 4.2 开启自定义音频采集渲染功能

```objc
// 设置音频源为自定义采集渲染
ZegoCustomAudioConfig *audioConfig = [[ZegoCustomAudioConfig alloc] init];
audioConfig.sourceType = ZegoAudioSourceTypeCustom;

[[ZegoExpressEngine sharedEngine] enableCustomAudioIO:YES config:audioConfig];
```

### 4.3 登录房间后推/拉流

请参考 [快速开始 - 实现流程\|_blank](7628#2_2) 的 “2.2 登录房间”、“2.3 推流” 和 “2.4 拉流”。

### 4.4 采集音频数据

打开音频采集设备，将采集到的音频数据通过 [sendCustomAudioCaptureAACData\|_blank](@sendCustomAudioCaptureAACData) 或 [sendCustomAudioCapturePCMData\|_blank](@sendCustomAudioCapturePCMData) 传递给引擎。

### 4.5 渲染音频数据

打开音频渲染设备，使用 [fetchCustomAudioRenderPCMData\|_blank](@fetchCustomAudioRenderPCMData) 从引擎中获取要渲染的数据，拿到音频数据后再通过渲染设备播放。


## 5 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [enableCustomAudioIO \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#enable-custom-audio-io-config) | 开启自定义音频采集渲染 |
| [sendCustomAudioCaptureAACData \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#send-custom-audio-capture-aac-data-data-length-config-length-timestamp-param) | 向 SDK 发送自定义采集的 AAC 数据 |
| [sendCustomAudioCapturePCMData \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#send-custom-audio-capture-pcm-data-data-length-param) | 向 SDK 发送自定义采集的 PCM 数据 |
| [fetchCustomAudioRenderPCMData \|_blank](/zh/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#fetch-custom-audio-render-pcm-data-data-length-param) | 从 SDK 获取要自定义渲染的 PCM 数据 |

## 6 常见问题

1. **调用自定义音频采集渲染相关接口的时机？**

    各接口的调用时机如下：
    - [enableCustomAudioIO\|_blank](@enableCustomAudioIO)：应该在引擎启动前开始调用，即开始预览、推拉流之前。
    - [sendCustomAudioCaptureAACData\|_blank](@sendCustomAudioCaptureAACData)/[sendCustomAudioCapturePCMData\|_blank](@sendCustomAudioCapturePCMData)：应该在开始预览和推流后调用。如果在开始预览、推流前调用，SDK 内部会直接丢弃收到的数据。
    - [fetchCustomAudioRenderPCMData\|_blank](@fetchCustomAudioRenderPCMData)：应该在调用了开始拉流后调用，在开始拉流前获取到的都是无效的静音数据。

2. **调用自定义音频采集渲染相关接口的频率？**

    最优的方式是按照物理音频设备的时钟驱动，在物理采集设备采集到数据的时候调用 [sendCustomAudioCaptureAACData\|_blank](@sendCustomAudioCaptureAACData) 和 [sendCustomAudioCapturePCMData\|_blank](@sendCustomAudioCapturePCMData)；在物理渲染设备需要数据时调用 [fetchCustomAudioRenderPCMData\|_blank](@fetchCustomAudioRenderPCMData)。

    如果开发者的实际场景中没有具体的物理设备来驱动，建议每 10 ms ～ 20 ms 调用一次上述接口。

3. **调用 [fetchCustomAudioRenderPCMData\|_blank](@fetchCustomAudioRenderPCMData)，如果 SDK 内部数据不足 "dataLength" 时，SDK 如何处理？**

    在保证 "param" 填写正常的情况下，当 SDK 内部的数据不足 "dataLength" 时，不足的剩余长度按照静音数据补齐。
