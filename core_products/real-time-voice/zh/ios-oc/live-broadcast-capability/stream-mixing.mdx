---
articleID: 4984
---
# 混流
---
articleID: 4984
---
# 混流

- - -

## 1 功能简介

混流是把多路音视频流从云端混合成单流的技术。

### 1.1 混流优点

1. 降低了开发实现上的复杂性。比如当有 N 个主播进行连麦，如果采用混流，观众端不必同时拉 N 路视频流，开发实现上省去了拉 N 路流并布局的步骤。
2. 降低了对设备的性能要求，减少设备的性能开销和网络带宽的负担。比如当连麦方过多时，观众端需要拉 N 路视频流，需要设备硬件上能支持同时拉 N 路流。
3. 转推多路 CDN 实现简单，只需要在混流配置时按需增加输出流。
4. 观众端需要回放多主播连麦视频时，仅需要在 CDN 上开启录制的配置。
5. 鉴黄时只需要观察一个画面，不必再同时查看多个画面。

### 1.2 应用场景

1. 当设备不支持同时拉 N 路流时使用混流。
2. 需要多个视频画面合成一个视频时使用混流，比如教育类场景，直播老师和学生的画面。

### 1.3 使用说明

SDK 既支持音视频混流，也支持纯音频混流。

开发者在“拉流/推流”成功后开始混流。比如主播 A 与观众 B 成功连麦后，成功拉取到观众 B 的画面时，即开始混主播 A 的流和观众 B 的流；也可以根据需求，在其他合适时机进行混流。

### 1.4 系统架构图

使用混流功能时，SDK 将流推到 ZEGO 服务器上，ZEGO 服务器将指定流混成一路流后再推到 CDN 上，观众从 CDN 上拉混流观看。

![](/Pics/iOS/ZegoExpressEngine/Mixer/mixer-structure.png)

## 2 示例源码下载

请参考 [下载示例源码](#3126) 获取源码。

相关源码请查看 “/ZegoExpressExample/Topics/Mixer/ZGMixerViewController.m” 文件。

## 3 前提条件

在实现多路混流功能之前，请确保：

@@@Express_Audio_Prerequisites@@@


## 4 使用步骤

### 4.1 初始化并登录房间

请参考 [快速开始 - 实现流程](7628#3_1) 的 “3.1 创建引擎” 和 “3.2 登录房间” 完成房间登录。

<div class = 'mk-warning'>

- 混流的前置条件为房间内需要有已存在的流。
- 发起混流的设备可以混房间内已有的其他设备推的流而自己不用推流，也可以自己推流后再混自己推的流。
</div>


### 4.2 设置混流配置

[ZegoMixerTask](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-task) 是 SDK 中定义的混流任务配置对象，其中包含输入流布局、输出流等信息。

```objc
/// 混流任务对象
@interface ZegoMixerTask : NSObject

- (instancetype)init NS_UNAVAILABLE;

/// 通过 TaskID 构造一个混流任务对象
- (instancetype)initWithTaskID:(NSString *)taskID;

/// 混流任务ID
@property (nonatomic, copy, readonly) NSString *taskID;

/// 设置混流任务对象的音频配置
- (void)setAudioConfig:(ZegoMixerAudioConfig *)audioConfig;

/// 设置混流任务对象的视频配置
- (void)setVideoConfig:(ZegoMixerVideoConfig *)videoConfig;

/// 设置混流任务对象的输入流列表
- (void)setInputList:(NSArray<ZegoMixerInput *> *)inputList;

/// 设置混流任务对象的输出列表
- (void)setOutputList:(NSArray<ZegoMixerOutput *> *)outputList;

/// 设置混流任务对象的水印
- (void)setWatermark:(ZegoWatermark *)watermark;

/// 设置混流任务对象的背景图片
- (void)setBackgroundImageURL:(NSString *)backgroundImageURL;

@end
```

#### 4.2.1 创建混流任务对象

通过构造函数 [initWithTaskID](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-task#init-with-task-id) 新建一个混流任务对象，然后调用实例方法分别设置输入、输出等参数。

```objc
ZegoMixerTask *task = [[ZegoMixerTask alloc] initWithTaskID:@"task-1"];

// 保存该混流任务对象
self.mixerTask = task;
```

#### 4.2.2 （可选）设置混流视频配置

<details class="zg-primary">
    <summary>混流视频配置设置</summary>

如果要混的流都是纯音频，则不用进行设置。

视频的帧率、码率、分辨率的默认值分别为 15 fps，600 kbps，360p。

```objc
ZegoMixerVideoConfig *videoConfig = [ZegoMixerVideoConfig defaultConfig];
[task setVideoConfig:videoConfig];
```
</details>


#### 4.2.3 （可选）设置混流音频配置


<details class="zg-primary">
    <summary>流音频配置设置</summary>

音频的码率默认值为 48 kbps。

```objc
[task setAudioConfig:[ZegoMixerAudioConfig defaultConfig]];
```
</details>


#### 4.2.4 设置混流输入流

默认支持最多输入 9 路流，如果需要输入更多路流，请联系 ZEGO 技术支持确认和配置。

<div class="mk-warning">

当混入的流为音频流时（即 “ContentType” 参数设置为音频混流类型），SDK 内部不处理布局字段，此时无需关注 “layout” 参数。
</div>

以下代码将展示混两路流，和上下布局：

```objc
CGRect firstRect = CGRectMake(0, 0, videoConfig.resolution.width, videoConfig.resolution.height/2);
ZegoMixerInput *firstInput = [[ZegoMixerInput alloc] initWithContentType:ZegoMixerInputContentTypeVideo streamID:@"stream-1" layout:firstRect];

CGRect secondRect = CGRectMake(0, videoConfig.resolution.height/2, videoConfig.resolution.width, videoConfig.resolution.height/2);
ZegoMixerInput *secondInput = [[ZegoMixerInput alloc] initWithContentType:ZegoMixerInputContentTypeVideo streamID:@"stream-2" layout:secondRect];

NSArray<ZegoMixerInput *> *inputArray = @[firstInput, secondInput];

[task setInputList:inputArray];
```

#### 4.2.5 设置混流输出

混流输出最多可设置 3 个。

以下代码演示输出到 ZEGO 服务器（流 ID 为 “output-stream”）：

```objc
NSArray<ZegoMixerOutput *> *outputArray = @[[[ZegoMixerOutput alloc] initWithTarget:@"output-stream"]];
[task setOutputList:outputArray];
```

#### 4.2.6 （可选）设置混流水印

<details class="zg-primary">
    <summary>混流水印设置</summary>

如果需要水印图片的 URL，请联系 ZEGO 技术支持获取。

以下代码演示设置一个 ZEGO 的水印放置于画面左上角：

```objc
ZegoWatermark *watermark = [[ZegoWatermark alloc] initWithImageURL:@"preset-id://zegowp.png" layout:CGRectMake(0, 0, videoConfig.resolution.width/2, videoConfig.resolution.height/20)];
[task setWatermark:watermark];
```
</details>



#### 4.2.7 （可选）设置混流背景图片

<details class="zg-primary">
    <summary>混流背景图片设置</summary>

如果需要背景图片的 URL，请联系 ZEGO 技术支持获取。

```objc
[task setBackgroundImageURL:@"preset-id://zegobg.png"];
```
</details>


#### 4.2.8 （可选）设置高级配置

<details class="zg-primary">
    <summary>高级配置设置</summary>

高级配置适用于一些定制化需求，例如：配置视频编码格式。

如果需要了解具体支持的配置项信息，请联系 ZEGO 技术支持。

<div class="mk-hint">

普通场景无需设置高级配置。  
</div>

```ojbc
// 指定混流输出视频格式为 vp8 ，使用特定的推流协议才能生效。
NSDictionary *config = @{@"video_encode": @"vp8"};
[task setAdvancedConfig: config];

// 如果混流输出视频格式设为 vp8，请同步设置音频编码格式为LOW3，设置方可生效。
ZegoMixerAudioConfig *audioConfig = [ZegoMixerAudioConfig defaultConfig];
audioConfig.codecID = ZegoAudioCodecIDLow3;
[task setAudioConfig:audioConfig];
```
</details>

### 4.3 开始混流任务

完成了 [ZegoMixerTask](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-task) 混流任务对象的配置后，调用开始混流的接口以启动这个混流任务，并在回调 Block 中处理启动混流任务失败的逻辑。

- 接口原型

```objc
/// 开始混流任务
/// @param task 混流任务对象
/// @param callback 开始混流任务结果通知
- (void)startMixerTask:(ZegoMixerTask *)task callback:(nullable ZegoMixerStartCallback)callback;
```

- 调用示例

```objc
[self.engine startMixerTask:task callback:^(ZegoMixerStartResult * _Nonnull result) {
    if (result.errorCode == 0) {
        NSLog(@"Start mixer task success");
    } else {
        NSLog(@"Start mixer task fail");
    }
}];
```

### 4.4 更新混流任务的配置

当混流信息发生变更时，例如混流的输入流列表发生增减、调整混流视频输出码率等，修改该混流任务对象的参数，然后再调用一次 [startMixerTask](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-express-engine#start-mixer-task-callback) 接口即可更新配置。

<div class= 'mk-warning'>

更新混流任务的配置时，“taskID” 不可更改。 
</div>


以下代码演示进行混流任务途中添加一条输入流，上中下布局：

```objc
CGRect firstRect = CGRectMake(0, 0, videoConfig.resolution.width, videoConfig.resolution.height/3);
ZegoMixerInput *firstInput = [[ZegoMixerInput alloc] initWithContentType:ZegoMixerInputContentTypeVideo streamID:@"stream-1" layout:firstRect];

CGRect secondRect = CGRectMake(0, videoConfig.resolution.height/3, videoConfig.resolution.width, videoConfig.resolution.height*(2/3));
ZegoMixerInput *secondInput = [[ZegoMixerInput alloc] initWithContentType:ZegoMixerInputContentTypeVideo streamID:@"stream-2" layout:secondRect];

CGRect thirdRect =CGRectMake(0, videoConfig.resolution.height*(2/3), videoConfig.resolution.width, videoConfig.resolution.height);
ZegoMixerInput *thirdInput = [[ZegoMixerInput alloc] initWithContentType:ZegoMixerInputContentTypeVideo streamID:@"stream-3" layout:thirdRect];

NSArray<ZegoMixerInput *> *inputArray = @[firstInput, secondInput, thirdInput];

// 重新设置之前保存的混流对象的输入流列表
[self.mixerTask setInputList:inputArray];

// 再调用一次启动混流任务接口，即可更新混流配置
[self.engine startMixerTask:self.mixerTask callback:^(ZegoMixerStartResult * _Nonnull result) {
    if (result.errorCode == 0) {
        NSLog(@"Start mixer task success");
    } else {
        NSLog(@"Start mixer task fail");
    }
}];
```

### 4.5 停止混流

- 接口原型

```objc
/// 停止混流任务
/// @param taskID 混流任务 ID
- (void)stopMixerTask:(NSString *)taskID;
```

- 调用示例

```objc
// 传入正在混流中的 taskID 以停止该混流任务
[self.engine stopMixerTask:self.mixerTask.taskID];
```

## 5 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [startMixerTask](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#start-mixer-task-callback) | 开始混流任务 |
| [stopMixerTask](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-express-engine#stop-mixer-task) | 停止混流任务 |
| [initWithTaskID](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#init-with-task-id) | 创建混流任务对象 |
| [setInputList](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-input-list) | 设置混流任务对象的输入流列表 |
| [setOutputList](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-output-list) | 设置混流任务对象的输出列表 |
| [setAudioConfig](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-audio-config) | 设置混流任务对象的音频配置 |
| [setVideoConfig](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-video-config) | 设置混流任务对象的视频配置 |
| [setWatermark](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-watermark) | 设置混流任务对象的水印 |
| [setBackgroundImageURL](/zh/api?doc=Express_Video_SDK_API~ObjectiveC~class~zego-mixer-task#set-background-image-url) | 设置混流任务对象的背景图片 |

## 6 常见问题

1. **能将混流推到第三方 CDN 吗？如何转推多路 CDN？**

  若需要将混流推到第三方 CDN，可在 [ZegoMixerOutput](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-output) 的 “target” 参数填写 CDN 的 URL。

  填写的 URL 格式需要为 RTMP 格式：“rtmp://xxxxxxxx”。

  推多路 CDN 就创建 N 个输出流对象 [ZegoMixerOutput](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-output) 放入 [ZegoMixerTask](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-task) 中的 “outputList” 输出列表中。

2. **如何设置混流中每条流的布局？**

  [ZegoMixerInput](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-input) 的 “layout” 参数使用示例：

    - 假设指定某条流的左上角坐标为 (50，300)，右下角坐标为 (200，450)，即 “layout” 参数为 “CGRectMake(50, 300, 200, 450);”。
    - 假设 [ZegoMixerTask](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-task) 的 “videoConfig” 参数中的分辨率 “resolution” 为 “CGSizeMake(375, 667)”。

  那么这条流在最终的输出混流中的位置如下所示：
  ![](/Pics/iOS/ZegoExpressEngine/Mixer/mixer-layout.png)

3. **混流输入对象 “ZegoMixerInput” 的 “CGRect” 布局的比例与这条流本身的分辨率不相符时，画面将如何裁剪？**

  SDK 会做等比缩放。假设一条输入流的分辨率为 “720 × 1280”，即比例为 “9：16”，同时这条流的 [ZegoMixerInput](/article/api?doc=Express_Video_SDK_API~ObjectiveC_ios~class~zego-mixer-input) 的 “layout” 参数为 “CGRectMake(0, 0, 100, 100);”，即比例为 “1：1” 时，画面将会显示这条流的中间部分，即上下部分被裁剪掉。

4. **参与连麦的主播们想让各自的观众看到自己的视频在混流后的画面布局中位于大窗口，如何混流？**

  主播们各自布局再各自发起混流。

  例如：主播 A 设置自己推的流 A 画面布局的宽高大于拉主播 B 的流 B 的布局宽高，然后发起一个混流任务输出一个流 “A_Mix”；主播 B 设置自己推的流 B 画面布局的宽高大于拉主播 A 的流 A 的布局宽高，然后发起混流输出一个流 “B_Mix”。

  即总共需要发起两个混流任务。

5. **混流的两种方式：“单主播开始直播后就马上开始混流”和“当第二主播加入连麦的时候才开始混流”，这两种方式有什么区别？优劣势是什么？**

  从单主播直播开始就启动混流的优点是实现简单，缺点是会多一些额外的混单流时间的 CDN 成本开销。

  从单主播直播开始仅推流，等第二路主播加入连麦时才启动混流。优点是节约成本；缺点是开发实现上会复杂一些，观众端需要先拉取单主播流，主播们连麦开启混流后需要停止拉单主播流，然后改为拉取混流。而上述从头开始混流的方式，观众端不需要做从拉单主播流再到拉混流的一个切换。

6. **混流是否支持圆形或者方形的画面？**

  不支持圆形，方形可通过布局实现。
