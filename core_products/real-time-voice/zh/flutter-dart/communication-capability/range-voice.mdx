# 游戏语音

- - -

## 1 功能简介

### 1.1 概念解释

- 范围：收听者接收音频的范围。
- 方位：指收听者在游戏世界坐标中的位置和朝向，详情可参考 [4.5 初始化设置\|_blank](15214#4_5) 中的“步骤 1”。
- 收听者：房间内接收音频的用户
- 发声者：房间内发送音频的用户。

### 1.2 功能描述

ZEGO Express SDK 从 **2.11.0** 版本起，新增游戏语音模块，主要包括：范围语音、3D 音效、小队语音。适用于吃鸡类游戏、元宇宙类场景。

在吃鸡类游戏中，小队语音提供编队功能，在游戏开始前和开始后都可以更换小队，开发者无需关注流分组以及推拉流的实现，直接实现小队语音功能。

在吃鸡游戏和元宇宙场景中，提供 3D 音效能力，在收听发声者音效时，有方向感距离感，让场景感受更真实。

#### 范围语音

房间内的收听者对音频的接收距离有范围限制，若发声者与自己的距离超过该范围，则无法听到声音。为保证语音清晰，附近超过 20 人发声时，只能听到离自己最近的 20 个发声者的声音。

假如设置音频接收距离的最大范围为 R，若发声者离收听者的距离为 r，则：

a. 当 r < R 时，表示发声者在正常范围内，收听者可以听到声音。

b. 当 r ≥ R 时，表示发声者超出了最大范围，收听者无法听到声音。

<div class="mk-hint">

下图仅以范围语音模式为“全世界”时为例，更多不同模式组合关系下的声音可达情况请参考 [4.9 （可选）设置小队语音功能\|_blank](15214#4_9) 中的“步骤 2”。
</div>

![](http://doc.oa.zego.im/Pics/Common/RangeAudio/AudioRange.png)


#### 3D 音效

声音有 3D 空间感且按距离衰减。

#### 小队语音

玩家可以选择加入小队，并支持在房间内自由切换“全世界”模式、“仅小队”模式、“隐秘小队”模式。

- 全世界：包含房间内的所有成员，该模式下，收听者能接收到房间内所有在音频接收范围内且为全世界模式的发声者的声音。
- 仅小队：只包含加入到某个队伍中的成员，该模式下的收听者只能听到同一个小队内其他成员发出的声音。
- 隐秘小队：只包含加入到某个队伍中的成员，该模式下，收听者能接收到房间内所有在音频接收范围内且为全世界模式的发声者的声音。

## 2 前提条件

在实现范围语音之前，请确保：

@@@Express-Video_Prerequisites@@@

## 3 注意事项

<div class="mk-warning">


使用范围语音功能时请务必关注如下注意事项，以免影响接入。
</div>

如果您已经使用 ZEGO Express SDK 的实时音视频功能，需要注意以下事项：

- 由于范围语音功能模块是基于 ZegoExpressEngine 的推拉流接口功能来实现的，使用时无需关注推拉流的概念。在范围语音场景下，推音频流的概念转变为“开启麦克风”，拉音频流的概念转变为“开启扬声器”。建议您不要在接入范围语音功能的同时再使用 [startPublishingStream\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEnginePublisher/startPublishingStream.html)、[startPlayingStream\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEnginePlayer/startPlayingStream.html) 接口做推拉流操作，避免效果冲突。
- 范围语音功能模块中推拉流的相关回调（[onPublisherStateUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onPublisherStateUpdate.html) 、[onPlayerStateUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onPlayerStateUpdate.html)、[onPublisherQualityUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onPublisherQualityUpdate.html) 和 [onPlayerQualityUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onPlayerQualityUpdate.html)）不再生效。


## 4 使用步骤

### 4.1 创建引擎

调用 [createEngineWithProfile\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/createEngineWithProfile.html) 接口，将申请到到 AppID 传入参数 appID，创建引擎单例对象。

```dart
/** 请通过官网注册获取，格式为 123456789 */
int appID = appID;
/** 请通过官网注册获取，格式为 '0123456789012345678901234567890123456789012345678901234567890123'（共64个字符） */
String appSign = appSign;
/** 通用场景接入 */
ZegoScenario scenario = ZegoScenario.General;

var profile = ZegoEngineProfile(appID, scenario, appSign: appSign);

/** 创建引擎 */
ZegoExpressEngine.createEngineWithProfile(profile);
```

### 4.2 创建范围语音模块 

调用的 [createRangeAudio \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRangeAudio/createRangeAudio.html) 方法创建范围语音实例。

```dart
var rangAudio = await ZegoExpressEngine.instance.createRangeAudio();
if (rangAudio == null) {
    print("创建范围语音实例模块失败");
}
```

### 4.3 监听范围语音事件回调 

可以根据需要实现 [ZegoExpressEngine.onRangeAudioMicrophoneStateUpdate \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRangeAudioMicrophoneStateUpdate.html) 麦克风设置事件回调，用于监听麦克风的开启状态通知。

```dart
// set range audio event handler
ZegoExpressEngine.onRangeAudioMicrophoneStateUpdate = (ZegoRangeAudio rangeAudio, ZegoRangeAudioMicrophoneState state, int errorCode) {
};
```


### 4.4 登录房间

传入用户 ID 参数 userID 和 userName 创建 ZegoUser 用户对象后，调用 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/loginRoom.html) 接口，传入房间 ID 参数 roomID 和用户参数 user，登录房间。  

<div class="mk-warning">

- 同一个 AppID 内，需保证 roomID 全局唯一。  
- 同一个 AppID 内，需保证 userID 全局唯一，建议开发者将其设置成一个有意义的值，可将 userID 与自己业务账号系统进行关联。  
- userID 与 userName 不能为空，否则会导致登录房间失败。
</div>

```dart
/** 创建用户 */
var user = ZegoUser.id("user1");

/** 开始登录房间 */
ZegoExpressEngine.instance.loginRoom("room1", user);
```

<div class="mk-hint">


当用户已成功登录房间后，如果应用异常退出，在重启应用后，开发者需先调用 [logoutRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/logoutRoom.html) 接口退出房间，再调用 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/loginRoom.html) 接口重新登录房间。

</div>


### 4.5 初始化设置

**1. 设置听者自身所在位置和朝向**

开发者可以通过调用 [updateSelfPosition\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/updateSelfPosition.html) 接口，设置听者自身的所在位置和方位，或者在自身方位发生变化时更新自己在世界坐标系中的位置和朝向。

<div class="mk-hint">

- 在调用 [enableSpeaker\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableSpeaker.html) 打开扬声器之前如果没有调用该接口设置位置信息，则无法接收除小队以外其他人的声音。
- 自身坐标系三个轴的坐标值可以通过第三方 3D 引擎的旋转角度换算矩阵得到。
</div>

<table>
  <colgroup>
    <col width="20%">
    <col width="80%">
  </colgroup>
  <tbody><tr>
    <td>参数名</td>
    <td>描述</td>
  </tr>
  <tr>
    <td>position</td>
    <td>自身在世界坐标系中的坐标，参数是长度为 3 的 float 数组，三个值依次表示前、右、上的坐标值。</td>
  </tr>
  <tr>
    <td>axisForward</td>
    <td>自身坐标系前轴的单位向量，参数是长度为 3 的 float 数组，三个值依次表示前、右、上的坐标值。</td>
  </tr>
  <tr>
    <td>axisRight</td>
    <td>自身坐标系右轴的单位向量，参数是长度为 3 的 float 数组，三个值依次表示前、右、上的坐标值。</td>
  </tr>
  <tr>
    <td>axisUp</td>
    <td>自身坐标系上轴的单位向量，参数是长度为 3 的 float 数组，三个值依次表示前、右、上的坐标值。</td>
  </tr>
</tbody></table>

<img src="/Pics/Common/RangeAudio/Coordinate_System.png" width="60%"/>

```dart
// 自身在世界坐标系中的坐标，顺序是前、右、上。
var position = Float32List.fromList(<double>[100.0, 100.0, 100.0]);
// 自身坐标系前朝向的单位向量。
var axisForward = Float32List.fromList(<double>[1.0,0.0,0.0]);
// 自身坐标系右朝向的单位向量。
var axisRight = Float32List.fromList(<double>[0.0,1.0,0.0]);
// 自身坐标系上朝向的单位向量。
var axisUp = Float32List.fromList(<double>[0.0,0.0,1.0]);

rangAudio?.updateSelfPosition(position, axisForward, axisRight, axisUp);
``` 

**2. （可选）设置音频接收距离的最大范围**

调用 [setAudioReceiveRange\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setAudioReceiveRange.html) 接口设置听者接收音频距离的最大范围，即以自身为起点，3D 空间中以设置的距离为立体空间。设置该范围后，在开启 3D 音效的情况下，声音将会随距离的增加而衰减，直至超出所设置的范围，则不再有声音。小队内的语音，不会受到该值的限制，也不会有 3D 音效。

<div class="mk-hint">

如果不设置，则表示只能接收本小队内的成员声音，无法接收小队外的所有声音。
</div>

```dart
rangAudio?.setAudioReceiveRange(1000);
```  

**3. （可选）设置是否开启 3D 音效**

调用 [enableSpatializer\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableSpatializer.html) 接口设置 3D 音效，enable 取值为 true 时表示开启 3D 音效，此时房间内非小队成员的音频，会随着发声者离自身的距离和方向的变化而产生空间感的变化，为 false 时表示关闭 3D 音效。（可随时开启或关闭）

<div class="mk-warning">

该功能只对小队以外的人生效。
</div>

```dart
rangAudio?.enableSpatializer(true);
``` 


### 4.6 添加或更新发声者位置信息

登录房间成功后，可以通过调用 [updateAudioSource\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/updateAudioSource.html) 接口，添加或更新发声者的位置信息。

- userID：为房间内其他发声用户的 ID。
- position：发声者在世界坐标系中的坐标，参数是长度为 3 的 float 数组，三个值依次表示前、右、上的坐标值。

```dart
// 用户在世界坐标系中的坐标，顺序是前、右、上。
var position = Float32List.fromList(<double>[100.0, 100.0, 100.0]);
// 添加/更新用户位置
rangAudio?.updateAudioSource("abc",position);
``` 

### 4.7 设置是否开启麦克风

登录房间成功后调用 [enableMicrophone\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableMicrophone.html) 接口设置是否开启麦克风，当 enable 取值为 true 时表示开启，此时 SDK 将会自动使用主通道推音频流，为 false 时表示关闭。（可随时开启或关闭）

需要通过监听 [onRangeAudioMicrophoneStateUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRangeAudioMicrophoneStateUpdate.html) 事件回调来获取麦克风更新后的状态。

```dart
rangAudio?.enableMicrophone(true);
```  

### 4.8 设置是否开启扬声器

登录房间成功后调用 [enableSpeaker\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableSpeaker.html) 接口设置是否开启扬声器，enable 取值为 true 时表示开启，此时将会自动拉取房间内的音频流，为 false 时表示关闭。（可随时开启或关闭）

<div class="mk-warning">


当超过最大拉流数限制（目前为 20 路）时，会优先拉取小队内成员音频流（需设置小队模式），再拉取世界内距离自身范围最近的音频流。  
</div>


```dart
rangAudio?.enableSpeaker(true);
``` 

### 4.9 （可选）设置小队语音功能

**1. 设置队伍 ID**

调用 [setTeamID\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setTeamID.html) 接口可根据需要设置想要加入的小队 ID（可随时变更 ID），设置 ID 后即可直接加入。加入小队后，与同一小队内队员之间的交流不受范围语音和 3D 音效的限制。

```dart
rangAudio?.setTeamID("123");
```  

**2. 设置语音模式**

调用 [setRangeAudioMode\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setRangeAudioMode.html) 接口设置范围语音模式（可随时切换模式），mode 参数取值为 ZegoRangeAudioModeWorld 或 ZegoRangeAudioSecretTeam 时表示可以听到所有处于世界模式的人的声音，取值为 ZegoRangeAudioModeTeam 时表示只能听到同一小队内其他成员的声音。


<table>
  <colgroup>
    <col width="20%">
    <col width="30%">
    <col width="50%">
  </colgroup>
  <tbody><tr>
    <th>语音模式</th>
    <th>参数取值</th>
    <th>功能描述</th>
  </tr>
  <tr>
    <td>全世界</td>
    <td>World</td>
    <td>设置该模式后，此用户能听到附近一定范围的人的语音，不影响小队内成员互相通话。</td>
  </tr>
  <tr>
    <td>仅小队</td>
    <td>Team</td>
    <td>设置该模式后，此用户只能听到与自己同一小队的语音，且不受距离限制。</td>
  </tr>
  <tr>
    <td>隐秘小队</td>
    <td>SecretTeam</td>
    <td>设置该模式后，此用户能听到与自己同一小队的语音，且不受距离限制，同时可以听到一定范围内处于世界模式的人的声音。</td>
  </tr>
</tbody></table>

```dart
rangAudio?.setRangeAudioMode(ZegoRangeAudioMode.World);
```

@@@RangeVoice_Mode_Combination@@@

### 4.10 销毁范围语音模块

当不再使用范围语音模块时可调用 [destroyRangeAudio \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRangeAudio/destroyRangeAudio.html) 接口销毁，释放范围语音模块占用的资源。

```dart
ZegoExpressEngine.instance.destroyRangeAudio(rangAudio!);
```

### 4.11 退出房间 

调用 [logoutRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/logoutRoom.html) 接口退出房间，退出后将自动关闭麦克风和扬声器（即无法发送自己的音频，也无法收听别人的声音），并清空发声者信息列表。

```dart
// 退出房间
ZegoExpressEngine.instance.logoutRoom("roomID");
```

## 5 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [createEngineWithProfile \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/createEngineWithProfile.html) | 创建引擎 |
| [loginRoom \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/loginRoom.html) | 登录房间 |
| [createRangeAudio \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRangeAudio/createRangeAudio.html) | 创建范围语音模块 |
| [setRangeAudioMode\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setRangeAudioMode.html) | 设置语音模式 |
| [setAudioReceiveRange\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setAudioReceiveRange.html) | 设置音频接收范围 |
| [setTeamID\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/setTeamID.html) | 设置小队 ID |
| [enableMicrophone \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableMicrophone.html)  | 设置是否开启麦克风 |
| [enableSpeaker \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableSpeaker.html) | 设置是否开启扬声器 |
| [enableSpatializer \|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/enableSpatializer.html) | 设置是否开启3D音效|
| [updateAudioSource\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/updateAudioSource.html) | 更新房间内发声者位置 |
| [updateSelfPosition\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/updateSelfPosition.html) | 更新自己的位置 |

## 6 常见问题


1. **收听范围内的流最多支持同时拉多少路？**

为保证语音清晰，附近超过 20 人发声时，只能听到离自己最近的 20 个发声者的声音。如果超过 20 人且距离一样，则按照调用 [updateAudioSource\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRangeAudio/updateAudioSource.html) 接口时，每个 userID 首次传入的先后顺序而定。

2. **范围语音的“范围”指的是收听范围还是发声范围？**

范围语音的“范围”指的是收听范围。

3. **小队语音中的成员连麦有 3D 音效吗？**

小队中的语音是普通连麦的效果，暂无 3D 音效。

4. **若本身就在调用推流接口，此时需要使用范围语音会存在冲突吗？**

范围语音当前使用主路发送音频，如果客户已经使用主路，则会存在冲突。
