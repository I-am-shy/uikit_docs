# 房间连接状态说明

- - -

用户在使用 ZEGO Express SDK 进行音视频通话或直播时，需要先加入房间才能收到来自于同一房间内的其他用户的流新增/删除、用户进出等回调通知。所以用户在房间内的连接状态就决定了用户是否能正常使用音视频业务。

本文主要介绍如何判断用户在房间内的连接状态，以及各个连接状态的转化过程。

## 监听房间连接状态

用户可通过监听 [onRoomStateChanged\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRoomStateChanged.html) 回调实时监控自己在本房间内的连接状态。当用户连接状态发生改变时，SDK 会触发该回调，并在回调中明确当前的连接状态和相关错误码。

如果因为网络质量不佳导致房间连接中断，SDK 内部会自动进行重试。

#### 房间状态说明

<img src="/Pics/Express/Android/express_roomstate_change_android.png" style="width:80%"/>

房间连接状态会互相转化，开发者可通过 reason 判断各种情况，并在必要时结合 errorCode 处理相应的逻辑。reason 为 [ZegoRoomStateChangedReason\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoRoomStateChangedReason.html) 数据，具体说明如下所列：

<table>
  <colgroup>
    <col width="20%">
    <col width="30%">
    <col width="50%">
  </colgroup>
  <tbody><tr>
    <th>状态</th>
    <th>含义</th>
    <th>触发进入该状态的常见事件</th>
  </tr>
  <tr>
    <td>Logining</td>
    <td>正在登录房间。当调用 [loginRoom] 登录房间或 [switchRoom] 切换到目标房间时，进入该状态，表示正在请求连接服务器。通常通过该状态进行应用界面的展示。</td>
    <td><ol><li>调用 [loginRoom] 登录房间，此时会先进入该状态，此时 errorCode 为 0。</li><li>调用 [switchRoom] 切换到目标房间时，SDK 内部请求登录目标房间，此时 errorCode 为 0。</li></ol></td>
  </tr>
  <tr>
    <td>Logined</td>
    <td>登录房间成功。当登录房间或切换房间成功后，进入该状态，表示登录房间已经成功，用户可以正常收到房间内的其他用户和所有流信息增删的回调通知。</td>
    <td><ol><li>调用 [loginRoom] 登录房间成功，此时 errorCode 为 0。</li><li>调用 [switchRoom] 切换到目标房间时，SDK 内部登录目标房间成功，此时 errorCode 为 0。</li></ol></td>
  </tr>
  <tr>
    <td>LoginFailed</td>
    <td>登录房间失败。当登录房间或切换房间失败后，进入该状态，表示登录房间或切换房间已经失败，例如 AppID 或 Token 不正确等。</td>
    <td><ol><li>当使用 Token 鉴权功能时，传入的 Token 错误，此时 errorCode 为 1002033。</li><li>当因为网络问题导致登录房间超时，此时 errorCode 为 1002053。</li><li>当切换到目标房间时，SDK 内部登录目标房间失败，此时 errorCode 请参考以上登录错误说明。</li></ol></td>
  </tr>
  <tr>
    <td>Reconnecting</td>
    <td>房间连接临时中断。如果因为网络质量不佳产生的中断，SDK 会进行内部重试。</td>
    <td>当因为网络质量不佳导致房间连接临时中断并进行重连，此时 errorCode 为 1002051。</td>
  </tr>
  <tr>
    <td>Reconnected</td>
    <td>房间重新连接成功。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，重连成功后进入该状态。</td>
    <td>当因为网络质量不佳导致房间连接临时中断后重连成功，此时 errorCode 为 0。</td>
  </tr>
  <tr>
    <td>ReconnectFailed</td>
    <td>房间重新连接失败。如果因为网络质量不佳产生的中断，SDK 会进行内部重试，重连失败后进入该状态。</td>
    <td>当因为网络质量不佳导致房间连接临时中断后重连失败，此时 errorCode 为 1002053。</td>
  </tr>
  <tr>
    <td>KickOut</td>
    <td>被服务器踢出房间。例如有相同用户名在其他地方登录房间导致本端被踢出房间，会进入该状态。</td>
    <td><ol><li>用户被踢出房间（由于 userID 相同的用户在其他地方登录），此时 errorCode 为 1002050。</li><li>用户被踢出房间（开发者主动调用后台的 <a target="_blank" href="/article/8784">踢出房间用户</a> 接口），此时 errorCode 为 1002055。</li></ol></td>
  </tr>
  <tr>
    <td>Logout</td>
    <td>登出房间成功。没有登录房间前默认为该状态，当调用 [logoutRoom] 登出房间成功或 [switchRoom] 内部登出当前房间成功后，进入该状态。</td>
    <td><ol><li>当调用 [logoutRoom] 登出房间成功后，此时 errorCode 为 0。</li><li>当调用 [switchRoom] 切换房间时，SDK 内部登出当前房间成功。</li></ol></td>
  </tr>
  <tr>
    <td>LogoutFailed</td>
    <td>登出房间失败。当调用 [logoutRoom] 登出房间失败或 [switchRoom] 内部登出当前房间失败后，进入该状态。</td>
    <td>在多房间场景下，当调用 [logoutRoom] 登出某个房间时，房间 ID 不存在，此时 errorCode 为 1002002。</td>
  </tr>
</tbody></table>



## 常见业务事件的处理

#### 1. 第一次登录房间中

当 reason 为 Logining 时，表示开发者主动登录房间，并且正在连接中，此时 errorCode 为 0。

#### 2. 第一次登录房间成功

当 reason 为 Logined 时，表示第一次登录房间成功，此时 errorCode 为 0。

#### 3. 第一次登录房间失败

当 reason 为LoginFailed 时，表示第一次登录房间失败，此时 errorCode 详情可参考 [常见错误码\|_blank](!Error_Code/Error_Code)。

#### 4. 房间临时断线，正在重连中

当 reason 为 Reconnecting 时，表示房间连接临时中断，SDK 正在重连中，此时 errorCode 为 1002051。

#### 5. 房间临时断线后，重连成功

当 reason 为 Reconnected 时，表示房间连接临时中断后，SDK 重连成功，此时 errorCode 为 0。

#### 6. 房间临时断线后，重连失败

当 reason 为 ReconnectFailed 时，表示房间连接临时中断后，SDK 重连失败，此时 errorCode 为 1002053。

#### 7. 被服务器踢出房间

当 reason 为 KickOut 时，表示用户被踢出房间。
- 由于 userID 相同的用户在其他地方登录导致被踢出时，errorCode 为 1002050。
- 由于开发者主动调用后台的 [踢出房间用户\|_blank](#8784) 接口导致被踢出时，errorCode 为 1002055。

#### 8. 登出房间成功

当 reason 为 Logout 时，表示登出房间成功。

#### 9. 登出房间失败

当 reason 为 LogoutFailed 时，表示登出房间失败。仅在多房间场景下，登出房间 ID 不存在时出现，此时错误码为 1002002。


开发者可参考以下代码处理常见业务事件：

```dart
    int appID = 1234567890;//需在Zego中进行申请
    String appSign = "1234567890";//需在Zego中进行申请
    var scenario = ZegoScenario.General;//因需设置
    var profile = ZegoEngineProfile(appID, scenario, appSign: appSign);
    ZegoExpressEngine.createEngine(profile);
    ZegoExpressEngine.onRoomStateChanged = (String roomID, ZegoRoomStateChangedReason reason, int errorCode, Map<String, dynamic> extendedData) {
        if(reason == ZegoRoomStateChangedReason.Logining)
        {
            // 登录中
            // 代表开发者主动调用 loginRoom 触发的连接中的回调
        }
        else if(reason == ZegoRoomStateChangedReason.Logined)
        {
            // 登录成功
            // 当前是开发者主动调用 loginRoom 登录成功触发的回调，这里可以处理首次登录房间成功的业务逻辑，比如拉取聊天室、直播间基础信息。
        }
        else if(reason == ZegoRoomStateChangedReason.LoginFailed)
        {
            // 登录失败
            if (errorCode == 1002033) {
                //当使用登录房间鉴权的功能时，传入的 token 出错导
            }
        }
        else if(reason == ZegoRoomStateChangedReason.Reconnecting)
        {
             // 重连中
             // 当前是 SDK 断线重连成功触发的回调，这里建议展示一些重连的 UI
        }
        else if(reason == ZegoRoomStateChangedReason.Reconnected)
        {
             // 重连成功
        }
        else if(reason == ZegoRoomStateChangedReason.ReconnectFailed)
        {
             // 重连失败
             // 当房间连接彻底断开时，SDK 不会再进行重连，开发者如果需要再次登录房间，可以主动调用 loginRoom 接口
             // 此时可以在业务中退出房间/直播间/课堂，或者手动调用接口再次登录
        }
        else if(reason == ZegoRoomStateChangedReason.KickOut)
        {
             // 被踢出房间
             if (errorCode == 1002050) {
                 // 用户被踢出房间（由于 userID 相同的用户在其他地方登录）
             }
             else if (errorCode == 1002055) {
                 // 用户被踢出房间（开发者主动调用后台的踢人接口）
             }
         }
         else if(reason == ZegoRoomStateChangedReason.Logout)
         {
              // 登出成功
              // 开发者主动调用 logoutRoom 登出房间
              // 开发者可以在这里处理主动登出房间回调的逻辑
         }
         else if(reason == ZegoRoomStateChangedReason.LogoutFailed)
         {
              // 登出失败
              // 登出房间 ID 错误
         }
    };
```


## 房间断线重连

用户登录房间后，因网络信号问题/网络类型切换问题导致的与房间断开连接的情况，SDK 内部会进行自动重连。下图描述了用户 A 和用户 B 已登录同一个房间的情况下，用户 A 的房间连接状态变化。

![](/Pics/FAQ/ReconnectTimeSeq.png)

<div class="mk-warning">


如果用户 A 短暂断线，但是在 90 秒内重连成功了，那么用户 B 不会收到 [onRoomUserUpdate\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRoomUserUpdate.html) 的回调通知。
</div>


其中：
- T0 = 0s：ClientA 的 SDK 收到客户端发起的 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/loginRoom.html) 请求。
- T1 ≈ T0 + 120ms：通常在调用 [loginRoom\|_blank](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngineRoom/loginRoom.html) 120 毫秒后，客户端可以加入房间。加入房间过程中，ClientA 的客户端会收到 `onRoomStateChanged(roomID, ZegoRoomStateChangedReason.Logining, 0, extendedData)` 和 `onRoomStateChanged(roomID, ZegoRoomStateChangedReason.Logined, 0, extendedData)` 回调，分别通知客户端正在连接房间以及连接房间成功。
- T2 ≈ T1 + 100ms：因网络传输延迟，ClientB 约在 100ms 后收到 `onRoomUserUpdate(roomID, ZegoUpdateType.Add, userList)` 回调以通知客户端 ClientA 加入房间。
- T3：某个时间点，ClientA 因网络断开等原因导致上行网络变差。SDK 会尝试重新加入房间，同时客户端会收到 `onRoomStateChanged(roomID, ZegoRoomStateChangedReason.Reconnecting, 1002051, extendedData)` 回调以通知客户端 ClientA 正在断线重连。
- T4 ≈ T3 + 90S：ClientB 此时收到 `onRoomUserUpdate(roomID, ZegoUpdateType.Delete, userList)` 回调以通知 ClientA 已断线。
- T5 = T3 + time（小于20分钟）：ClientA 在重连时间内恢复网络，重连成功。此时客户端会收到 `onRoomStateChanged(roomID, ZegoRoomStateChangedReason.Reconnected, 0, extendedData)` 回调以通知客户端 ClientA 重连成功。
- T6 ≈ T5 + 100ms：因网络传输延迟，ClientB 约在 100ms 后收到 `onRoomUserUpdate(roomID, ZegoUpdateType.Add, userList)` 回调以通知客户端 ClientA 重连成功。
- T7 = T3 + 20min：如果 ClientA 连续 20 分钟无法重新加入房间，SDK 不再继续尝试重新连接。ClientA 将会收到 `onRoomStateChanged(roomID, ZegoRoomStateChangedReason.ReconnectFailed, 1002053, extendedData)` 回调以通知客户端断开连接。




## 相关文档

[SDK 是否支持断线重连机制？\|_blank](http://doc-zh.zego.im/faq/reconnect?product=ExpressVideo&platform=flutter)
