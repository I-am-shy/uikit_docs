# 通过 URL 拉流
---
articleID: 15708
---
# 通过 URL 拉流

---

## 1 功能简介

当推流端使用第三方推流工具（例如 OBS 软件、网络摄像头 IP Camera 等）将流推到 CDN 时，或通过使用 ZEGO SDK 转推 CDN 功能将音视频画面推送到第三方 CDN 上时，可使用直接传入 URL 地址的方式进行拉流。

## 2 前提条件

在实现 URL 拉流功能之前，请确保：

@@@Express-Video_Prerequisites@@@
- 你已将音视频流推送到 CDN，并知晓相应的 URL，详情请参考 [使用 CDN 直播](!ExpressVideoSDK-Publisher_Player_Advanced/RelayToCDN)。

## 3 使用步骤

### 3.1 配置拉流参数

直接通过 CDN 的 URL 地址拉流，需要使用 [ZegoCDNConfig](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoCDNConfig-class.html) 对象来填入 URL 参数，如果对应的 CDN 配置了拉流鉴权，还需要通过 “authParam” 字段填入鉴权参数。  

<div class = 'mk-hint'>

- 鉴权参数，即 URL 的 “?” 之后的字符串（不包括 “?”）。例如从 CDN 拉流的 URL 为 “rtmp://xxxx.yyy.zzz?a=qqq&b=www” 时，则鉴权参数为 “a=qqq&b=www”。  
- 拉流 URL 的鉴权参数主要用于防盗链，具体鉴权规则请联系具体的 CDN 厂商或 ZEGO 技术支持咨询。若无鉴权参数，请忽略 “authParam” 字段。
</div>


- 接口原型

    ```dart
    /**
     * CDN 配置对象
     *
     * 包括 CDN 的 URL 以及鉴权参数字符串
     */
    class ZegoCDNConfig {

        /** CDN 的 URL */
        public String url = "";

        /** URL 的鉴权参数 */
        public String authParam;

        ZegoCDNConfig(this.url, this.authParam);

    }
    ```

- 调用示例

    ```dart
    /** 设置 CDN 参数 */
    // URL 需要开发者根据实际情况填写
    String url = "rtmp://xxxxxxxx";
    // 如果需要鉴权则要设置鉴权参数，如果不需要鉴权可以不设置（鉴权参数不能带"?"字符）
    String authParam = "xxx";
    var config = ZegoCDNConfig(url, authParam);
    
    var zegoPlayerConfig = ZegoPlayerConfig.defaultConfig();
    zegoPlayerConfig.cdnConfig = config;
    ```

### 3.2 开始拉流

<div class= 'mk-warning'>

- 通过 URL 拉流时，不能直接通过填入流 ID 进行拉流，实际拉流画面以 URL 为准。
- 虽此时流 ID 不能用于拉流，但 SDK 内部仍以流 ID 作为唯一标识，用于后续拉流相关回调中。因此流 ID 仍需要在整个 AppID 内全局唯一。
</div>

- 调用示例

    ```dart
    /** 开始拉流 */
    // URL 需要开发者根据实际情况填写
    String url = "rtmp://xxxxxxxx";
    // 如果需要鉴权则要设置鉴权参数，如果不需要鉴权可以不设置（鉴权参数不能带"?"字符）
    String authParam = "xxx";
    var config = ZegoCDNConfig(url, authParam);
    
    var zegoPlayerConfig = ZegoPlayerConfig.defaultConfig();
    zegoPlayerConfig.cdnConfig = config;
    // 开始拉流
    // 填写了 URL 参数后，SDK 会从 URL 拉取音视频流，但此时依然需要传递一个唯一的 streamID 到 SDK，SDK 内部会以该 streamID 标识这条流
    ZegoExpressEngine.instance.startPlayingStream("STREAM_ID", canvas: ZegoCanvas(viewID), config: zegoPlayerConfig);

    /** 停止拉流时传递的是拉流时传入的 streamID */
    ZegoExpressEngine.instance.stopPlayingStream("STREAM_ID");
    ```

拉流时，如果出现错误，请参考 [常见错误码 - 1004xxx 拉流相关的错误码](!Error_Code/Error_Code#5)。


### 3.3 （可选）监听拉流相关事件通知

<details class="zg-primary">
    <summary>监听拉流相关事件通知</summary>

可以通过 [onPlayerStateUpdate](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onPlayerStateUpdate.html) 来监听从 CDN 拉流的结果。

<div class = 'mk-warning'>

如果不是使用 ZEGO SDK 进行推流，而是使用第三方推流工具直接进行推流、但是使用 ZEGO SDK 进行拉流，这种场景下推流方没有使用 ZEGO SDK 加入房间，拉流方默认收不到 [onRoomStreamUpdate](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRoomStreamUpdate.html) 的回调，可以使用 [后台流增加](#1333) 与 [后台流删除](#1331) 的功能，让拉流端可以收到 [onRoomStreamUpdate ](/unique-api/express-video-sdk/zh/dart_flutter/zego_express_engine/ZegoExpressEngine/onRoomStreamUpdate.html) 的回调。
</div>


- 接口原型

    ```dart
    class ZegoExpressEngine {

    ...

    /**
     * 拉流状态变更回调
     *
     * 在拉流成功后，可以通过该回调接口获取拉流状态变更的通知。
     * 开发者可根据 state 参数是否在 [正在请求拉流状态] 来大体判断用户的拉流网络情况。
     * @param streamID 流 ID
     * @param state 拉流状态
     * @param errorCode 拉流状态变更对应的错误码。请参考常见错误码文档 [https://doc-zh.zego.im/zh/5641.html]
     * @param extendedData 扩展信息
     */
    static void Function(String streamID, ZegoPlayerState state, int errorCode, Map<String, dynamic> extendedData)? onPlayerStateUpdate;

    ...
    
    }
    ```

- 调用示例

    ```dart
    ZegoExpressEngine.onPlayerStateUpdate(String streamID, ZegoPlayerState state, int errorCode, Map<String, dynamic> extendedData) = {
            /** 调用拉流接口成功后，当拉流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试拉流的同时，会通过该回调通知 */
            // 1. 当收到该回调通知且 state 为 Playing 时，表示拉流成功
            // 2. 当收到该回调通知且 state 为 PlayRequesting 时，表示可能是正在拉流或者由于网络中断等原因导致 SDK 正在重试拉流
            // 3. 当收到该回调通知且 state 为 NoPlay 时，表示拉流停止
            // 4. 通过 URL 拉流时，回调参数中的 streamID 即为调用拉流 API 时的流 ID，用于唯一标识当次拉流事件。
    };
    ```
</details>
