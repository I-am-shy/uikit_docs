---
articleID: 5034
---
# 通过 URL 拉流

---

## 1 功能简介

当推流端使用第三方推流工具（例如 OBS 软件、网络摄像头 IP Camera 等）将流推到 CDN 时，或通过使用 ZEGO SDK 转推 CDN 功能将音视频画面推送到第三方 CDN 上时，可使用直接传入 URL 地址的方式进行拉流。

## 2 示例源码下载

请参考 [下载示例源码\|blank](#3125) 获取源码。

相关源码请查看 “/ZegoExpressExample/CustomCdnPublish” 目录下的文件。

## 3 前提条件

在实现 URL 拉流功能之前，请确保：

@@@Express_Audio_Prerequisites@@@
- 已联系 ZEGO 技术支持开通 URL 拉流功能。   
- 已将音视频流推送到 CDN，并知晓相应的 URL，详情请参考 [使用 CDN 直播\|_blank](!ExpressVideoSDK-Publisher_Player_Advanced/RelayToCDN)。


## 4 使用步骤

### 4.1 配置拉流参数

直接通过 CDN 的 URL 地址拉流，需要使用 [ZegoCDNConfig\|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-entity-zego-cdn-config) 对象来填入 URL 参数，当从 CDN 拉流时存在拉流鉴权时，还需要通过 “authParam” 字段填入鉴权参数。  

<div class = 'mk-hint'>

- 鉴权参数，即 URL 的 “?” 之后的字符串（不包括 “?”）。例如从 CDN 拉流的 URL 为 “rtmp://xxxx.yyy.zzz?a=qqq&b=www” 时，则鉴权参数为 “a=qqq&b=www”。  
- 拉流 URL 的鉴权参数主要用于防盗链，具体鉴权规则请联系具体的 CDN 厂商或 ZEGO 技术支持咨询。若无鉴权参数，请忽略 “authParam” 字段。
</div>


- 接口原型

    ```java
    /**
     * CDN 配置对象
     *
     * 包括 CDN 的 URL 以及鉴权参数字符串
     */
    public class ZegoCDNConfig {

        /** CDN 的 URL */
        public String url = "";

        /** URL 的鉴权参数 */
        public String authParam;

    }
    ```

- 调用示例

    ```java
    /** 设置 CDN 参数 */
    ZegoCDNConfig config = new ZegoCDNConfig();
    // URL 为 CDN 拉流地址
    config.URL = "rtmp://xxxxxxxx";
    // 如果需要鉴权则要设置鉴权参数，如果不需要鉴权可以不设置（鉴权参数不能带"?"字符）
    config.authParam = "xxx";
    ZegoPlayerConfig zegoPlayerConfig = new ZegoPlayerConfig();
    zegoPlayerConfig.cdnConfig = config;
    ```

### 4.2 开始拉流

<div class= 'mk-warning'>

- 通过 URL 拉流时，不能直接通过填入流 ID 进行拉流，实际拉流画面以 URL 为准。
- 虽此时流 ID 不能用于拉流，但 SDK 内部仍以流 ID 作为唯一标识，用于后续拉流相关回调中。因此流 ID 仍需要在整个 AppID 内全局唯一。
</div>


- 接口原型

    ```java
    /**
     * 开始拉流
     *
     * 除了可通过此接口让用户可以从 ZEGO 实时音视频云拉取远端用户的音视频流进行互通外，还可以通过此接口让用户可以从第三方 URL 拉取远端用户的音视频流。
     * 在开始拉流前，需要先加入房间，可通过监听 [onRoomStreamUpdate] 事件回调来获取该房间内 streamID 的新增。
     * 在网络质量不佳的情况下，用户拉流可能出现中断， SDK 会尝试重新连接，可通过监听 [onPlayerStateUpdate] 事件来获知当前拉流状态以及错误信息。
     * 拉取不存在的流 ID，执行本接口后 SDK 持续尝试拉取，在该流 ID 被成功推送后，音视频流可以真正被拉取到。
     * 开发者可通过再次调用此接口实现更新拉流 Canvas 的操作（流 ID 必须一样）。
     * @param streamID 流 ID，长度不超过256的字符串。不可以包含 URL 关键字，否则推拉流失败。仅支持数字、英文字符和 "-"、"_"。
     * @param canvas 用于显示拉流画面的视图，视图设置为 [null] 则不进行显示
     * @param config 拉流进阶配置
     */
    public void startPlayingStream(String streamID, @Nullable ZegoCanvas canvas, ZegoPlayerConfig config)
    ```

- 调用示例

    ```java
    /** 开始拉流 */
    ZegoCDNConfig config = new ZegoCDNConfig();
    // URL 为 CDN 拉流地址
    config.URL = "rtmp://xxxxxxxx";
    // 如果需要鉴权则要设置鉴权参数，如果不需要鉴权可以不设置（鉴权参数不能带"?"字符）
    config.authParam = "xxx";
    ZegoPlayerConfig zegoPlayerConfig = new ZegoPlayerConfig();
    zegoPlayerConfig.cdnConfig = config;
    // 开始拉流
    engine.startPlayingStream("STREAM_ID", new ZegoCanvas(play_view), zegoPlayerConfig);

    /** 停止拉流 */
    engine.stopPlayingStream("STREAM_ID");
    ```

拉流时，如果出现错误，请参考 [常见错误码 - 1004xxx 拉流相关的错误码\|_blank](4378#5)。


### 4.3 （可选）监听拉流相关事件通知

<details class="zg-primary">
    <summary>监听拉流相关事件通知</summary>

可以通过 [onPlayerStateUpdate\|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-callback-i-zego-event-handler#on-player-state-update) 来监听从 CDN 拉流的结果。

<div class = 'mk-warning'>

如果不是使用 ZEGO SDK 进行推流，而是使用第三方推流工具直接进行推流、但是使用 ZEGO SDK 进行拉流，这种场景下推流方没有使用 ZEGO SDK 加入房间，拉流方默认收不到 [onRoomStreamUpdate\|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-callback-i-zego-event-handler#on-room-stream-update) 的回调，可以使用 [后台流增加\|_blank](#1333) 与 [后台流删除\|_blank](#1331) 的功能，让拉流端可以收到 [onRoomStreamUpdate \|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-callback-i-zego-event-handler#on-room-stream-update) 的回调。
</div>


- 接口原型

    ```java
    /**
     * 拉流状态变更回调
     *
     * 在拉流成功后，可以通过该回调接口获取拉流状态变更的通知。
     * 开发者可根据 state 参数是否在 [正在请求拉流状态] 来大体判断用户的拉流网络情况。
     * @param streamID 流 ID
     * @param state 拉流状态
     * @param errorCode 拉流状态变更对应的错误码。请参考常见错误码文档 [https://doc-zh.zego.im/zh/4378.html]
     * @param extendedData 扩展信息
     */
    public void onPlayerStateUpdate(String streamID, ZegoPlayerState state, int errorCode, JSONObject extendedData){

    }
    ```

- 调用示例

    ```java
    engine.setEventHandler(new IZegoEventHandler(){

        // 重写的其他回调
        ...

        @Override
        public void onPlayerStateUpdate(String streamID, ZegoPlayerState state, int errorCode, JSONObject extendedData) {
            /** 调用拉流接口成功后，当拉流器状态发生变更，如出现网络中断导致推流异常等情况，SDK在重试拉流的同时，会通过该回调通知 */
            // 1. 当收到该回调通知且 state 为 PLAYING 时，表示拉流成功
            // 2. 当收到该回调通知且 state 为 PLAY_REQUESTING 时，表示可能是正在拉流或者由于网络中断等原因导致 SDK 正在重试拉流
            // 3. 当收到该回调通知且 state 为 NO_PLAY 时，表示拉流停止
            // 4. 通过URL拉流时，回调参数中的stream_id即为调用拉流API时的流ID，用于唯一标识当次拉流事件。
        }

        // 重写的其他回调
        ...

    });
    ```
</details>


## 5 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [startPlayingStream \|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-zego-express-engine#start-playing-stream) | 开始通过 URL 拉流 |
| [stopPlayingStream \|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-zego-express-engine#stop-playing-stream) | 停止拉流 |
