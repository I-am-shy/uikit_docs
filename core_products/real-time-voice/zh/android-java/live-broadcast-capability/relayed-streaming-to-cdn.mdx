# 转推 CDN

---

## 1 功能简介

转推 CDN（Content Delivery Network，内容分发网络）指的是将音视频流从 ZEGO 实时音视频云推送到 CDN 的过程。开发者基于此功能可进行更大规模的内容分发，且用户可直接通过 URL 拉流地址从网页或第三方播放器进行观看。  

![/Pics/Common/ZegoExpressEngine/relay_cdn.png](https://storage.zego.im/sdk-doc/Pics/Common/ZegoExpressEngine/relay_cdn.png)
  
默认情况下，ZEGO 支持自有的 CDN 进行分发，开发者在 App 需要上线并支持大规模音视频流进行分发时与 ZEGO 技术支持进行沟通配置即可。当配置后，当推往 ZEGO 实时云的音视频流会默认转推到 ZEGO 自有 CDN。  
  
如果开发者与第三方 CDN 有业务合作，想要使用原有的第三方 CDN 流媒体网络的分发服务的同时又想使用 SDK 进行低延迟连麦，可参考本文档。

为防止攻击者盗取或伪造您的推流 URL 地址，您可以参考 [CDN 推流鉴权\|_blank](!CDN_StreamPublishing_Authentication)，提升您推流使用的安全性。


## 2 前提条件

在实现转推 CDN 之前，请确保：

@@@Express_Audio_Prerequisites@@@


## 3 使用步骤

### 3.1 开始推流

请参考 [快速开始 - 实现流程\|_blank](7627#2_) 的 “2.3 推流”。

### 3.2 转推CDN

当推流成功后，调用 [addPublishCdnUrl\|_blank](@addPublishCdnUrl) 增加动态转推至 CDN 的 URL，即可将已经成功推向 ZEGO 实时云的音视频流动态向第三方 CDN 进行转推。

调用 [removePublishCdnUrl\|_blank](@removePublishCdnUrl) 即可删除动态转推至 CDN 的 URL。

<div class = 'mk-warning'>

- 若开发者有转推到多家第三方 CDN 厂商的需求，可使用同一个流ID多次调用 [addPublishCdnUrl\|_blank](@addPublishCdnUrl)（URL 需要不同）。
- 若开发者转推到多家第三方 CDN 后，停止转推时也同样需要调用多次来停止所有转推的流。
- 若开发者转推到多家第三方 CDN 后，可从 CDN 回调状态通知 [onPublisherRelayCDNStateUpdate\|_blank](@onPublisherRelayCDNStateUpdate) 的列表参数中获取到每条转推流的状态变更通知。
</div>


- 接口原型

    ```java
    /**
     * 增加转推至 CDN 的 URL
     *
     * 调用此接口，将已推往 ZEGO 实时音视频云的音视频流转推至延迟高但是支持高并发拉流的自定义的 CDN 内容分发网络。
     * 由于调用该接口时本质上是将推往 ZEGO 音视频云端的音视频流动态转推至不同的 CDN ，因此此接口需要在推流成功后调用。
     * 由于 ZEGO 的音视频云服务本身可配置支持 CDN 内容分发网络，该接口主要为自身拥有 CDN 内容分发服务的开发者使用。
     * 可以同时在使用 ZEGO 的 CDN 音视频流内容分发服务的同时通过调用此接口再使用开发者自身拥有 CDN 内容分发服务的开发者使用。
     * 该接口支持动态转推至 CDN 内容分发网络，因此开发者可以使用该接口来作为 CDN 内容分发服务的一个容灾方案。
     * 当调用 [enablePublishDirectToCDN] 接口设置为 true 将流直推到 CDN 时，再调用本接口将无效。
     * @param streamID 流 ID
     * @param targetURL CDN 转推地址，支持的转推地址格式为 rtmp。
     * @param callback 添加 CDN 转推结果通知
     */
    public void addPublishCdnUrl(String streamID, String targetURL, IZegoPublisherUpdateCdnUrlCallback callback)
    ```

    ```java
    /**
     * 删除转推至 CDN 的 URL
     *
     * 当已经添加了某个 CDN 转推地址，需要将流停止转推至该接口时调用此接口。
     * 该接口并不会停止推往 ZEGO 音视频云的音视频流。
     * @param streamID 流 ID
     * @param targetURL CDN 转推地址，支持的转推地址格式为 rtmp。
     * @param callback 移除 CDN 转推结果通知
     */
    public void removePublishCdnUrl(String streamID, String targetURL, IZegoPublisherUpdateCdnUrlCallback callback)
    ```

- 调用示例

    ```java
    /** 推流成功后，开始转推到CDN */

    // 推流时使用的流ID
    String streamID = "STREAM_ID";
    // 需要转推的CDN地址，请开发者按照实际URL填入
    String URL = "rtmp://xxxxxxxx";
    engine.addPublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCDNURLCallback() {
        @override
        public void onPublisherUpdateCdnUrlResult(int errorCode) {
            if(errorCode == 0) {
                // 转推成功
            } else {
                // 转推失败，可能由于网络原因转推请求发送失败
            }
        }
    });
    ```

    ```java
    /** 停止推流前，先停止转推CDN */

    // 推流时使用的流ID
    String streamID = "STREAM_ID";
    // 需要停止转推的CDN地址，请开发者按照实际URL填入
    String URL = "rtmp://xxxxxxxx";
    engine.removePublishCdnUrl(streamID, URL, new IZegoPublisherUpdateCDNURLCallback() {
        @override
        public void onPublisherUpdateCdnUrlResult(int errorCode) {
            if(errorCode == 0) {
                // 停止转推成功
            } else {
                // 停止转推失败，可能由于网络原因停止转推请求发送失败
            }
        }
    });

    ```

### 3.3 （可选）监听 CDN 回调的状态通知

<details class="zg-primary">
    <summary>监听 CDN 回调的状态通知</summary>

- 接口原型

    ```java
    /**
     * 添加/删除转推 CDN 地址状态回调
     *
     * 在 ZEGO 实时音视频云将音视频流转推到 CDN 后，如果 CDN 转推状态发生变化，例如出现转推停止或转推重试，将会收到此回调。
     * 开发者可根据该回调判断转推 CDN 的音视频流是否正常，若不正常根据异常原因进一步定位转推 CDN 的音视频流异常的原因，以及做对应的容灾策略。
     * 若对异常的原因不了解，可联系 ZEGO 技术支持分析具体异常的原因。
     * @param streamID 推流的流 ID
     * @param infoList 当前 CDN 正在转推的信息列表
     */
    public void onPublisherRelayCDNStateUpdate(String streamID, ArrayList<ZegoStreamRelayCDNInfo> infoList){

    }
    ```

- 调用示例

    ```java
    engine.setEventHandler(new IZegoEventHandler(){

        // 重写的其他回调
        ...

        @Override
        public void onPublisherRelayCDNStateUpdate(String streamID, ArrayList<ZegoStreamRelayCDNInfo> infoList){
            // 转推 CDN 结果的通知，开发者可以通过 ZegoStreamRelayCDNInfo 来监控转推 CDN 的情况
            ...
        }

        // 重写的其他回调
        ...

    });
    ```
</details>



### 3.4 SDK 通过 URL 进行拉流

当音视频流转推 CDN 成功后，开发者希望用户从 CDN 进行拉流时，需要使用传入 URL 的自定义拉流方式进行拉流，而不能通过流 ID 进行拉流，具体操作请参考 [推拉流进阶 - 通过 URL 拉流\|_blank](#1182)。

## 4 API 参考列表

| 方法 | 描述 |
|-------|--------|
| [startPublishingStream\|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-zego-express-engine#start-publishing-stream) | 开始推流 |
| [addPublishCDNURL\|_blank](@addPublishCDNURL) | 增加转推至 CDN 的 URL |
| [removePublishCDNURL\|_blank](@removePublishCDNURL) | 删除转推至 CDN 的 URL |
| [startPlayingStream\|_blank](/zh/api?doc=Express_Video_SDK_API~Java~class~im-zego-zegoexpress-zego-express-engine#start-playing-stream) | 开始拉流 |
