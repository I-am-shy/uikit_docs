export const DriveIdNote = () => (
  <Note title="说明">请在每次使用 WebSocket 驱动时，都重新调用 DriveByWsStream 接口获取新的 DriveId。</Note>
);

# WebSocket 驱动数字人说话

- - -

## 简介

本文介绍如何使用 WebSocket 传输 PCM 音频数据驱动数字人说话。

## 前提条件

在使用 WebSokcet 驱动之前，请确保：
- 已 [创建数字人视频流任务](./../server-apis/digital-human-streaming/create-digital-human-stream-task.mdx)。

## 实现流程

```mermaid
sequenceDiagram
    participant 业务后台
    participant 数字人后台

    业务后台->>数字人后台: 获取 WebSocket 驱动信息
    数字人后台-->>业务后台: 返回 WebSocket 驱动信息

    业务后台->>数字人后台: 建立 WebSocket 连接
    业务后台->>数字人后台: 发送 Start 开始驱动指令
    业务后台->>数字人后台: 发送 PCM 音频数据
    数字人后台 ->> 数字人后台: 数字人开口说话
    业务后台->>数字人后台: 发送 PCM 音频数据
    数字人后台 ->> 数字人后台: 数字人开口说话
    业务后台->>数字人后台: 发送 PCM 音频数据
    数字人后台 ->> 数字人后台: 数字人开口说话
    业务后台->>数字人后台: 发送 PCM 音频数据 (音频数据发送完毕)
    数字人后台 ->> 数字人后台: 数字人开口说话
    业务后台->>数字人后台: 发送 Stop 停止驱动指令
    
    业务后台->>数字人后台: 断开 WebSocket 连接
```

### 1 获取 WebSocket 驱动信息

调用 [DriveByWsStream](./../server-apis/digital-human-streaming/drive-by-ws-stream.mdx) 接口获取 WebSocket 驱动信息，该接口返回 WebSocket 驱动信息，包含 WebSocket 地址（包含鉴权信息）、驱动任务 ID。

### 2 建立 WebSocket 连接

<Note title="说明">
对于同一个数字人视频流任务，请不要同时建立多个连接，并在不同的连接上并行发送数据。
</Note>
通过 WebSocket 地址（包含鉴权信息）建立 WebSocket 连接。

### 示例代码

```
补充建立连接的代码块
```

### 3 发送 Start 开始驱动指令

WebSocket 连接建立后，通过该连接发送开始驱动指令。协议如下：

#### 请求参数
| 参数               | 类型   | 是否必填 | 描述             |
|------------------|------|------|-------------------------|
| Action      | String | 是    | 固定传：`Start`  |
| Payload      | Object | 是    | 请求体。         |
| └DriveId      | String   | 是    | 通过 [获取 WebSocket 驱动信息](./../server-apis/digital-human-streaming/drive-by-ws-stream.mdx) 接口的响应参数获取。<DriveIdNote /> |
| └SampleRate      | Number  | 否   | 音频采样率，目前支持以下两种采样率：<ul><li>`16000Hz`</li><li>`24000Hz`</li></ul> 如果不填，取值为 `16000`。 |

#### 请求示例
```json
{
    "Action": "Start",
    "Payload": {
        "DriveId": "xxxxxxxxxxx",
        "SampleRate": 16000
    }
}
```

### 示例代码

```
补充发送 start 指令的代码块
```


### 4 发送 PCM 音频数据

通过 WebSocket 连接发送原生的 PCM 二进制音频数据给数字人 API 平台服务。

### 示例代码

```
补充发送 PCM 音频数据的代码块
```

### 5 发送 Stop 停止驱动指令

当 PCM 音频数据发送完毕之后，请及时发送 `Stop` 指令，避免造成数字人卡顿。协议如下：

<Note title="说明">
如果未及时发送 Stop 指令，数字人后台会误判仍有剩余 PCM 数据未接收，从而持续等待，导致数据不足以完成推理，进而出现数字人卡顿的问题。
</Note>

#### 请求参数
| 参数               | 类型   | 是否必填 | 描述             |
|------------------|------|------|-------------------------|
| Action      | String | 是    | 固定传：`Stop`  |
| Payload      | Object | 是    | 请求体。         |
| └DriveId      | String   | 是    | 通过 [获取 WebSocket 驱动信息](../server-apis/digital-human-streaming/drive-by-ws-stream.mdx) 接口的响应参数获取。<DriveIdNote /> |

#### 请求示例
```json
{
    "Action": "Stop",
    "Payload": {
        "DriveId": "xxxxxxxxxxx"
    }
}
```

### 示例代码

```
补充发送 stop 指令的代码块
```

### 6 断开 WebSocket 连接

如果后续没有 WebSocket 驱动的请求，请及时断开连接。

### 示例代码

```
补充断开连接的代码块
```