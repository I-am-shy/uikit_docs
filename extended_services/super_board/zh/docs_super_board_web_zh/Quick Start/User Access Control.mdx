# 使用 Token 鉴权

---

## 1 功能简介

@@@Introduction_to_Token_Authentication_Native@@@

## 2 前提条件

- 基础鉴权 Token 默认开通，权限认证 Token（即房间 ID 和推流 ID 权限位）请联系 ZEGO 技术支持开通。
- 已在项目中集成 ZEGO Express SDK（2.14.0 及以上版本），实现基本的实时音视频功能，请参考 [快速开始 - 集成\|_blank](!ExpressVideoSDK-Integration/SDK_Integration) 和 [快速开始 - 实现流程\|_blank](!ExpressVideoSDK-Integration/Solution_Implementation)。


## 3 实现流程

@@@Token_implementation_process@@@


## 4 使用步骤

@@@Token_usage_steps@@@


### 4.2 生成 Token


开发者获得项目的 AppID 和 ServerSecret 信息后，根据实际业务需求，即可在自己的服务端生成 Token。开发者客户端向开发者服务端发送申请 Token 请求，由开发者服务端生成 Token 后返回给到对应客户端。

ZEGO 在 GitHub/Gitee 提供了一个开源的 zego_server_assistant 插件，支持使用 Go、C++、Java、Objective-C、Python、PHP、.NET、Node.js 语言，在开发者的服务端部署生成 Token。

zego_server_assistant 插件中提供了生成基础鉴权 Token 和生成权限认证 Token 的示例代码，两者的适用场景如下，开发者可按需选择：
- 基础鉴权 Token：用于业务的简单权限验证的场景，此时 “payload” 字段可传空。
- 权限认证 Token：为了进一步提高安全性，开放房间 ID 和推流 ID 这两个权限位，可以验证登录房间的 ID 和推流 ID，此时 “payload” 字段需要按照规则生成，可参考下表的“权限认证 Token”示例代码。权限位校验规则如下：
    - 只校验登录权限：登录时校验权限，推流时不校验权限。
    - 同时校验登录和推流权限：登录和推流时均校验权限。

@@@Server_generates_Token_2@@@


### 4.3 使用 Token 

用户携带获取到的 Token 和 user、roomID 信息，通过 [loginRoom\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#login-room) 接口登录对应的房间。

```javascript
let roomID = 'xxx' // 要登录的房间 ID
let token = 'xxxxxxxxxx' // 请求开发者服务端获取 
let user = {userID : 'xxxx'} // 房间内用户唯一标识
let loginResult = zg.loginRoom(roomID, token, user): Promise<boolean>
```

如果开发者需要在登录房间后修改推流权限位，可以调用 [renewToken\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#renew-token) 接口更新 Token，更新后会影响下一次登推流的权限，之前已经成功的推流不受影响。


```javascript
let token = await getToken(); // 重新请求开发者服务端获取 Token;
zg.renewToken(token); 
```

### 4.4 Token 过期时的处理方式

在 Token 过期前 30 秒，SDK 会通过 [tokenWillExpire\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~interface~ZegoRTMEvent#token-will-expire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [renewToken\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#renew-token) 接口更新 Token。若未处理，不同版本对 Token 过期的处理机制有所不同：

- 若您接入的是 **2.6.0 ～ 2.10.0** 版本的 ZEGO Express SDK，此时如果未更新 Token，则在 Token 过期时：
    - 已登录的用户不会被踢出房间。
    - 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。
- 若您接入的是 **2.11.0** 及以上版本的 ZEGO Express SDK：
    - 可以联系 ZEGO 技术支持额外配置 Token 过期管理机制，此时如果未更新 Token，则当 Token 过期时：
        - 已登录的用户会被踢出房间，且无法再登录房间。
        - 当前已成功的推流会被停止，也无法进行下一次推流。
    - 若未联系 ZEGO 技术支持额外配置 Token 过期管理机制，此时如果未更新 Token：
        - 已登录的用户不会被踢出房间。
        - 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。

<Note title="Note">

若开启了登录权限校验，用户登录房间时必须主动传入新的 Token。

</Note>


```javascript
zg.on('tokenWillExpire',(roomID: string)=>{
    let token = await getToken(); // 重新请求开发者服务端获取 Token
    zg.renewToken(token);
});
```


## 5 API 参考

| 方法 | 描述 |
|-------|--------|
| [loginRoom\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#login-room) | 登录房间 |
| [renewToken\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~class~ZegoExpressEngine#renew-token) | 更新 Token |
| [tokenWillExpire\|_blank](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~javascript_web~interface~ZegoRTMEvent#token-will-expire) | Token 过期回调 |
