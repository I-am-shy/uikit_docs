# 评分功能

---

评分功能属于在线K歌房可选部分，业务侧根据需要，可以考虑集成。通过打分，评分功能可以增加用户互动，增加趣味性。

评分功能属于正版曲库模块，无法单独使用。评分功能由酷狗音速达提供，依赖于逐字歌词，没有逐字歌词的歌曲无法评分。

评分功能主要包含功能：音准线展示和歌唱评分。

## 1 前提条件

- 已在项目中集成 ZEGO Express SDK（含版权音乐功能），实现基本的点歌和歌曲播放相关功能，详情请参考 [点歌（获取和分享歌曲）\|_blank](!KTV_Live_Chorus_Program_down-Songs_get_share)。
- 已获取评分控件，详情请参考 [下载\|_blank](!KTV_Live_Chorus_Program_down-online_ktv_download)。

## 2 实现流程

### 2.1 初始化配置

调用 [createCopyrightedMusic\|_blank](/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoExpressEngine#create-copyrighted-music) 接口创建音乐版权实例后，需要调用 [initCopyrightedMusic\|_blank](/article/api?doc=Express_Video_SDK_API~java_android~class~ZegoCopyrightedMusic#init-copyrighted-music) 初始化接口。

```java
mCopyrightedMusic = mSDKEngine.createCopyrightedMusic();
ZegoCopyrightedMusicConfig config = new ZegoCopyrightedMusicConfig();
config.user = mUserInfo;
L.i(TAG, "ZGKTVCopyrightedMusicManager init start: " + System.currentTimeMillis());
mCopyrightedMusic.initCopyrightedMusic(config, new IZegoCopyrightedMusicInitCallback() {
    @Override
    public void onInitCallback(int i) {
    L.i(TAG, "ZGKTVCopyrightedMusicManager init end: " + System.currentTimeMillis());
    if (i == 0) {
    initialized = true;
    ZGKTVPlayerManager.getInstance().init();
    L.i(TAG, "Init ZegoCopyrightedMusic success");
    } 
    else {
      L.i(TAG, "Init ZegoCopyrightedMusic fail, errorCode:%d" + i);
    }
    if (callback != null) {
        callback.onRTCCallback(i);
    }
  }
});
```

### 2.2 音准线展示

ZEGO SDK 提供每首歌的标准音高线，可以获取音高线值进行渲染展示。

#### 2.2.1 初始化评分控件

```java
mZegoLyricView = findViewById(R.id.lyric_view);
```

#### 2.2.2 获取标准音高线和展示标准音高线

先获取歌曲信息然后根据ResourceID获取标准音高线，将获取的标准音高线数据设置到音高线控件中并渲染展示。

```java
ZGKTVPlayerManager.getInstance().getStandardPitch(new IZegoCopyrightedMusicGetStandardPitchCallback() {
     @Override
     public void onGetStandardPitchCallback(int errorCode, String pitch) {
         if (errorCode == 0) {
              Gson gson = new Gson();
              mMusicPlayerMenu.getPitchView().setStandardPitch(ZegoPitchViewHelper.parsePitch(gson.fromJson(pitch, ZGKTVPitch.class)));
              } else {
                  mMusicPlayerMenu.getPitchView().reset();
                  T.show("获取音高线失败");
         }
    }
});
```
#### 2.2.3 获取实时音高线和实时渲染音高线

获取人声歌唱对应的实时音高线，渲染展示用户的演唱音高。

```java
public void onCurrentPitchValueUpdate(String resourceID, int currentDuration, int pitchValue) {
    if (mIsMicMuted) {
         return;
    }
    mCurrentPitch = pitchValue;
}

private void updateMusicPlayerMenu() {
    // 计算出当前播放器进度 （当前进度 = 当前时间 - 播放器回调时的时间 + 播放器进度）
   long customProgress = System.currentTimeMillis() - mPlayerCurrentTimeMillis + mPlayerCurrentProgress;
   currentProgress = customProgress;
   ......
   progressInterval++;
   if (progressInterval >= 2) {
       ......
       mMusicPlayerMenu.getPitchView().setCurrentSongProgress(customProgress, mCurrentPitch);
   }
}
```

### 2.3 歌唱评分

歌曲的评分由评分控件呈现，每一句的分数和总体分数都展示在其中。

#### 2.3.1 开启评分

歌曲播放时开启评分，评分的频率为60ms。

```java
public void onMediaPlayerStateUpdate(ZegoMediaPlayer mediaPlayer, ZegoMediaPlayerState state, int errorCode) {
    ......
     if (state == ZegoMediaPlayerState.PLAYING) {
     song.setState(ZGKTVSongState.PLAYING);
     ZGKTVCopyrightedMusicManager.getInstance().resetScore(mResourceID);
     ZGKTVCopyrightedMusicManager.getInstance().startScore(mResourceID);
      ZGRealTimeKtvManager.getInstance().restartMvStream();
     } 
    ......
}

public void startScore(String resourceID) {
    if (resourceID != null) {
    L.e(TAG, "startScore:resourceID" + resourceID);
    mCopyrightedMusic.startScore(resourceID, 60);
    } else {
       L.e(TAG, "startScore resourceID is NULL");
    }
}
```

#### 2.3.2 停止评分

```objc
public void onMediaPlayerStateUpdate(ZegoMediaPlayer mediaPlayer, ZegoMediaPlayerState state, int errorCode) {
    ......
     if (state == ZegoMediaPlayerState.PLAYING) {
     ......
     }else if (state == ZegoMediaPlayerState.PLAY_ENDED) {
        ZGKTVCopyrightedMusicManager.getInstance().stopScore(mResourceID);
    }
    ......
}

```

#### 2.3.3 获取评分

歌词控件每一行结束会回调，可以在这里获取分数。

```java
mZegoLyricView.setOnLyricFinishLineListener(new OnLyricLineFinishedListener() {
    @Override
    public void onLyricLineFinished(int position, LineInfo lineInfo) {
        int lastScore = mMusicPlayerMenu.getScore();
        int totalScore = ZGKTVPlayerManager.getInstance().getTotalScore();
        if (totalScore >= 0) {
             mMusicPlayerMenu.setScore(totalScore);
        }
        if (mMusicPlayerMenu.getPitchView().getPitchStartTime() < currentProgress) {

             if (!mIsMicMuted) {
             int score = ZGKTVPlayerManager.getInstance().getPreviousScore();
             if (score <= 100) {
                    mMusicPlayerMenu.getPitchView().addScore(score);
              } else {
                   mMusicPlayerMenu.getPitchView().addScore(totalScore - lastScore);
              }
          } else {
              mMusicPlayerMenu.getPitchView().addScore(totalScore - lastScore);
              }
          }
      }
});
```

歌曲演唱结束的时候在播放器的结束回调中获取分数，可以是总分，也可以是平均分。

```java
int totalScore = ZGKTVPlayerManager.getInstance().getTotalScore();
public int getTotalScore(String resourceID) {
    if (resourceID != null) {
    L.e(TAG, "getTotalScore:resourceID" + resourceID);
    int score = mCopyrightedMusic.getTotalScore(resourceID);
    L.e(TAG, "getTotalScore:score:" + score);
        return score;
    } else {
        L.e(TAG, "getTotalScore resourceID is NULL");
        return -1;
   }
}
```
