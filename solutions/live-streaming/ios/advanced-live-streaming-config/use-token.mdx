---
articleID: 20755
---
# 使用 Token 鉴权

---


## 功能介绍

@@@Introduction_to_Token_Authentication_Native@@@

## 前提条件

- 基础鉴权 Token 默认开通，权限认证 Token（即房间 ID 和推流 ID 权限位）请联系 ZEGO 技术支持开通。
- 已在项目中集成 ZEGO Express SDK（2.17.0 及以上版本），实现基本的实时音视频功能，请参考 [快速开始 - 集成](!ExpressVideoSDK-Integration/SDK_Integration) 和 [快速开始 - 实现流程](!ExpressVideoSDK-Integration/Solution_Implementation)。

<Warning title="注意">


若您集成的是 2.17.0 之前版本的 ZEGO Express SDK（使用 AppSign 鉴权），现在想升级到 2.17.0 版本且使用 Token 鉴权，可以通过 [如何从 AppSign 鉴权升级为 Token 鉴权](https://doc-zh.zego.im/faq/token_upgrade) 文档了解 AppSign 鉴权和 Token 鉴权更多信息。
</Warning>

## 流程概述

### 房间模块

@@@Token_implementation_process@@@

### 范围场景模块

使用 Token 鉴权时，需要开发者先生成 Token，您再携带 Token 登录场景，ZEGO 服务端对带着 Token 的用户进行校验。

以使用 Token 判断用户是否能登录场景为例介绍使用流程，如下图：

<Frame width="512" height="auto" caption=""><img src="https://storage.zego.im/sdk-doc/Pics/QuickStart/token_rangescene_uml.png" /></Frame>

1. 开发者客户端发起申请 Token 的请求。
2. 在开发者的服务端上生成 Token，并返回给开发者客户端。
3. 开发者客户端携带申请到的 Token 和 userID、sceneID 信息，登录对应的场景。
4. ZEGO SDK 会自动将 Token 发送到 ZEGO 服务端进行校验。
5. ZEGO 服务端会将校验结果返回给 ZEGO SDK。
6. ZEGO SDK 再将校验的结果直接返回给开发者客户端，没有权限的客户端将登录失败。

## 基础鉴权 Token 的生成与使用

@@@Token_usage_steps_change@@@

### 生成基础鉴权 Token

@@@Server_generates_Token_change@@@

### 使用 Token

#### 房间模块

用户携带获取到的 Token 和 user、roomID 信息，登录对应的房间。

<Warning title="注意">


调用 [loginRoom](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoExpressEngine#login-room-user) 接口登录房间时使用的 userID，必须和 “4.2 生成基础鉴权 Token” 时使用的 userID 保持一致。
</Warning>

```objc
NSString *roomID = @"xxx"; // 要登录的房间 ID
ZegoUser *user = [ZegoUser userWithUserID:@"xxxx"];
ZegoRoomConfig *config = [[ZegoRoomConfig alloc] init];
config.token = @"xxxxxxxx"; // 请求开发者服务端获取

[[ZegoExpressEngine sharedEngine] loginRoom:roomID user:user config:config];
```

如果开发者需要在用户登录房间后修改用户的推流权限，也可以调用 [renewToken](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeScene#renew-token) 接口更新权限，更新后会影响下一次推流的权限，之前已经成功的推流不受影响。


```objc
NSString *token = [MyToken getToken]; // 重新请求开发者服务端获取 Token
[[ZegoExpressEngine sharedEngine] renewToken:token roomID:roomID];
```

#### 范围场景模块

用户携带获取到的 Token 和 user、sceneID 信息，登录对应的场景。

<Warning title="注意">


调用 [loginScene](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeScene#login-scene-callback) 接口登录场景时使用的 userID，必须和 “4.2 生成基础鉴权 Token” 时使用的 userID 保持一致。
</Warning>

```objc
long long sceneID = 123; // 要登录的场景 ID
ZegoUser *user = [ZegoUser userWithUserID:@"xxxx"];
ZegoSceneParam *param = [[ZegoSceneParam alloc] init];
param.sceneID = sceneID;
param.user = user;
param.token = @"xxxxxxxx"; // 请求开发者服务端获取

[rangeScene loginScene:param callback:^(int errorCode, ZegoSceneConfig * _Nonnull config) {}];
```

### Token 过期时的处理方式

@@@Token_overdue@@@

#### 房间模块

在 Token 过期前 30 秒，SDK 会通过 [onRoomTokenWillExpire](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~protocol~ZegoEventHandler#on-room-token-will-expire-room-id) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [renewToken](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeScene#renew-token) 接口更新 Token。若未处理，不同版本对 Token 过期的处理机制有所不同：

@@@Token expiration processing mechanism@@@


<Note title="说明">


若开启了登录权限校验，用户登录房间时必须主动传入新的 Token。
</Note>



```objc
- (void)onRoomTokenWillExpire:(int)remainTimeInSecond roomID:(NSString *)roomID {
    NSString *token = [MyToken getToken]; // 重新请求开发者服务端获取 Token
    
    [[ZegoExpressEngine sharedEngine] renewToken:token roomID:roomID];
}
```

#### 范围场景模块

在 Token 过期前 30 秒，SDK 会通过 [tokenWillExpire](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeSceneEventHandler#range-scene-token-will-expire) 回调发出通知。

收到该回调后，开发者需要从自己的服务端获取新的有效 Token，并调用 SDK 提供的 [ZegoRangeScene.renewToken](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeScene#renew-token) 接口更新 Token。若未处理，Token 过期的处理机制如下：

- 已登录的用户不会被踢出场景。
- 当前已成功的推拉流不受影响，但是会影响用户的下一次推拉流操作。


<Note title="说明">


若开启了登录权限校验，用户登录场景时必须主动传入新的 Token。
</Note>



```objc
- (void)rangeScene:(ZegoRangeScene *)rangeScene tokenWillExpire:(int)remainTimeInSecond {
    NSString *token = [MyToken getToken]; // 重新请求开发者服务端获取 Token
    // 请切换线程调用 renewToken
    [rangeScene renewToken:token];
}
```

## 进阶功能

### 生成权限认证 Token

@@@Server_generates_Token_change2@@@


### 客户端生成 Token（不推荐）

@@@Client_generates_Token@@@

@@@Client_generates_Token_Step@@@




## API 参考

| 方法 | 描述 |
|-------|--------|
| [loginRoom](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoExpressEngine#login-room-user) | 登录房间 |
| [renewToken](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~class~ZegoRangeScene#renew-token) | 更新 Token |
| [onRoomTokenWillExpire](https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~objective-c_ios~protocol~ZegoEventHandler#on-room-token-will-expire-room-id) | Token 过期回调 |

## 相关文档

[如何防止音视频互动中的幽灵麦或炸房的现象？](https://doc-zh.zego.im/faq/bombing)
